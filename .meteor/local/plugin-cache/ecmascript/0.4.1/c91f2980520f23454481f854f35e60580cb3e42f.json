{"metadata":{"usedHelpers":["typeof","interopRequireDefault"],"marked":[],"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"/packages/mongo/mongo_livedata_tests.js","filenameRelative":"/packages/mongo/mongo_livedata_tests.js","env":{},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":false,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"/packages/mongo/mongo_livedata_tests.js.map","sourceFileName":"/packages/mongo/mongo_livedata_tests.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"basename":"mongo_livedata_tests"},"ignored":false,"code":"var _typeof2 = require(\"babel-runtime/helpers/typeof\");\n\nvar _typeof3 = _interopRequireDefault(_typeof2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { \"default\": obj }; }\n\n// This is a magic collection that fails its writes on the server when\n// the selector (or inserted document) contains fail: true.\n\nvar TRANSFORMS = {};\n\n// We keep track of the collections, so we can refer to them by name\nvar COLLECTIONS = {};\n\nif (Meteor.isServer) {\n  Meteor.methods({\n    createInsecureCollection: function () {\n      function createInsecureCollection(name, options) {\n        check(name, String);\n        check(options, Match.Optional({\n          transformName: Match.Optional(String),\n          idGeneration: Match.Optional(String)\n        }));\n\n        if (options && options.transformName) {\n          options.transform = TRANSFORMS[options.transformName];\n        }\n        var c = new Mongo.Collection(name, options);\n        COLLECTIONS[name] = c;\n        c._insecure = true;\n        Meteor.publish('c-' + name, function () {\n          return c.find();\n        });\n      }\n\n      return createInsecureCollection;\n    }(),\n    dropInsecureCollection: function () {\n      function dropInsecureCollection(name) {\n        var c = COLLECTIONS[name];\n        c._dropCollection();\n      }\n\n      return dropInsecureCollection;\n    }()\n  });\n}\n\n// We store the generated id, keyed by collection, for each insert\n// This is so we can test the stub and the server generate the same id\nvar INSERTED_IDS = {};\n\nMeteor.methods({\n  insertObjects: function () {\n    function insertObjects(collectionName, doc, count) {\n      var c = COLLECTIONS[collectionName];\n      var ids = [];\n      for (var i = 0; i < count; i++) {\n        var id = c.insert(doc);\n        INSERTED_IDS[collectionName] = (INSERTED_IDS[collectionName] || []).concat([id]);\n        ids.push(id);\n      }\n      return ids;\n    }\n\n    return insertObjects;\n  }(),\n  upsertObject: function () {\n    function upsertObject(collectionName, selector, modifier) {\n      var c = COLLECTIONS[collectionName];\n      return c.upsert(selector, modifier);\n    }\n\n    return upsertObject;\n  }(),\n  doMeteorCall: function () {\n    function doMeteorCall(name /*, arguments */) {\n      var args = Array.prototype.slice.call(arguments);\n\n      return Meteor.call.apply(null, args);\n    }\n\n    return doMeteorCall;\n  }()\n});\n\nvar runInFence = function runInFence(f) {\n  if (Meteor.isClient) {\n    f();\n  } else {\n    var fence = new DDPServer._WriteFence();\n    DDPServer._CurrentWriteFence.withValue(fence, f);\n    fence.armAndWait();\n  }\n};\n\n// Helpers for upsert tests\n\nvar stripId = function stripId(obj) {\n  delete obj._id;\n};\n\nvar compareResults = function compareResults(test, skipIds, actual, expected) {\n  if (skipIds) {\n    _.map(actual, stripId);\n    _.map(expected, stripId);\n  }\n  // (technically should ignore order in comparison)\n  test.equal(actual, expected);\n};\n\nvar upsert = function upsert(coll, useUpdate, query, mod, options, callback) {\n  if (!callback && typeof options === \"function\") {\n    callback = options;\n    options = {};\n  }\n\n  if (useUpdate) {\n    if (callback) return coll.update(query, mod, _.extend({ upsert: true }, options), function (err, result) {\n      callback(err, !err && {\n        numberAffected: result\n      });\n    });\n    return {\n      numberAffected: coll.update(query, mod, _.extend({ upsert: true }, options))\n    };\n  } else {\n    return coll.upsert(query, mod, options, callback);\n  }\n};\n\nvar upsertTestMethod = \"livedata_upsert_test_method\";\nvar upsertTestMethodColl;\n\n// This is the implementation of the upsert test method on both the client and\n// the server. On the client, we get a test object. On the server, we just throw\n// errors if something doesn't go according to plan, and when the client\n// receives those errors it will cause the test to fail.\n//\n// Client-side exceptions in here will NOT cause the test to fail! Because it's\n// a stub, those exceptions will get caught and logged.\nvar upsertTestMethodImpl = function upsertTestMethodImpl(coll, useUpdate, test) {\n  coll.remove({});\n  var result1 = upsert(coll, useUpdate, { foo: \"bar\" }, { foo: \"bar\" });\n\n  if (!test) {\n    test = {\n      equal: function () {\n        function equal(a, b) {\n          if (!EJSON.equals(a, b)) throw new Error(\"Not equal: \" + JSON.stringify(a) + \", \" + JSON.stringify(b));\n        }\n\n        return equal;\n      }(),\n      isTrue: function () {\n        function isTrue(a) {\n          if (!a) throw new Error(\"Not truthy: \" + JSON.stringify(a));\n        }\n\n        return isTrue;\n      }(),\n      isFalse: function () {\n        function isFalse(a) {\n          if (a) throw new Error(\"Not falsey: \" + JSON.stringify(a));\n        }\n\n        return isFalse;\n      }()\n    };\n  }\n\n  // if we don't test this, then testing result1.numberAffected will throw,\n  // which will get caught and logged and the whole test will pass!\n  test.isTrue(result1);\n\n  test.equal(result1.numberAffected, 1);\n  if (!useUpdate) test.isTrue(result1.insertedId);\n  var fooId = result1.insertedId;\n  var obj = coll.findOne({ foo: \"bar\" });\n  test.isTrue(obj);\n  if (!useUpdate) test.equal(obj._id, result1.insertedId);\n  var result2 = upsert(coll, useUpdate, { _id: fooId }, { $set: { foo: \"baz \" } });\n  test.isTrue(result2);\n  test.equal(result2.numberAffected, 1);\n  test.isFalse(result2.insertedId);\n};\n\nif (Meteor.isServer) {\n  var m = {};\n  m[upsertTestMethod] = function (run, useUpdate, options) {\n    check(run, String);\n    check(useUpdate, Boolean);\n    upsertTestMethodColl = new Mongo.Collection(upsertTestMethod + \"_collection_\" + run, options);\n    upsertTestMethodImpl(upsertTestMethodColl, useUpdate);\n  };\n  Meteor.methods(m);\n}\n\nMeteor._FailureTestCollection = new Mongo.Collection(\"___meteor_failure_test_collection\");\n\n// For test \"document with a custom type\"\nvar Dog = function Dog(name, color, actions) {\n  var self = this;\n  self.color = color;\n  self.name = name;\n  self.actions = actions || [{ name: \"wag\" }, { name: \"swim\" }];\n};\n_.extend(Dog.prototype, {\n  getName: function () {\n    function getName() {\n      return this.name;\n    }\n\n    return getName;\n  }(),\n  getColor: function () {\n    function getColor() {\n      return this.name;\n    }\n\n    return getColor;\n  }(),\n  equals: function () {\n    function equals(other) {\n      return other.name === this.name && other.color === this.color && EJSON.equals(other.actions, this.actions);\n    }\n\n    return equals;\n  }(),\n  toJSONValue: function () {\n    function toJSONValue() {\n      return { color: this.color, name: this.name, actions: this.actions };\n    }\n\n    return toJSONValue;\n  }(),\n  typeName: function () {\n    function typeName() {\n      return \"dog\";\n    }\n\n    return typeName;\n  }(),\n  clone: function () {\n    function clone() {\n      return new Dog(this.name, this.color);\n    }\n\n    return clone;\n  }(),\n  speak: function () {\n    function speak() {\n      return \"woof\";\n    }\n\n    return speak;\n  }()\n});\nEJSON.addType(\"dog\", function (o) {\n  return new Dog(o.name, o.color, o.actions);\n});\n\n// Parameterize tests.\n_.each(['STRING', 'MONGO'], function (idGeneration) {\n\n  var collectionOptions = { idGeneration: idGeneration };\n\n  testAsyncMulti(\"mongo-livedata - database error reporting. \" + idGeneration, [function (test, expect) {\n    var ftc = Meteor._FailureTestCollection;\n\n    var exception = function exception(err, res) {\n      test.instanceOf(err, Error);\n    };\n\n    _.each([\"insert\", \"remove\", \"update\"], function (op) {\n      var arg = op === \"insert\" ? {} : 'bla';\n      var arg2 = {};\n\n      var callOp = function callOp(callback) {\n        if (op === \"update\") {\n          ftc[op](arg, arg2, callback);\n        } else {\n          ftc[op](arg, callback);\n        }\n      };\n\n      if (Meteor.isServer) {\n        test.throws(function () {\n          callOp();\n        });\n\n        callOp(expect(exception));\n      }\n\n      if (Meteor.isClient) {\n        callOp(expect(exception));\n\n        // This would log to console in normal operation.\n        Meteor._suppress_log(1);\n        callOp();\n      }\n    });\n  }]);\n\n  Tinytest.addAsync(\"mongo-livedata - basics, \" + idGeneration, function (test, onComplete) {\n    var run = test.runId();\n    var coll, coll2;\n    if (Meteor.isClient) {\n      coll = new Mongo.Collection(null, collectionOptions); // local, unmanaged\n      coll2 = new Mongo.Collection(null, collectionOptions); // local, unmanaged\n    } else {\n        coll = new Mongo.Collection(\"livedata_test_collection_\" + run, collectionOptions);\n        coll2 = new Mongo.Collection(\"livedata_test_collection_2_\" + run, collectionOptions);\n      }\n\n    var log = '';\n    var obs = coll.find({ run: run }, { sort: [\"x\"] }).observe({\n      addedAt: function () {\n        function addedAt(doc, before_index, before) {\n          log += 'a(' + doc.x + ',' + before_index + ',' + before + ')';\n        }\n\n        return addedAt;\n      }(),\n      changedAt: function () {\n        function changedAt(new_doc, old_doc, at_index) {\n          log += 'c(' + new_doc.x + ',' + at_index + ',' + old_doc.x + ')';\n        }\n\n        return changedAt;\n      }(),\n      movedTo: function () {\n        function movedTo(doc, old_index, new_index) {\n          log += 'm(' + doc.x + ',' + old_index + ',' + new_index + ')';\n        }\n\n        return movedTo;\n      }(),\n      removedAt: function () {\n        function removedAt(doc, at_index) {\n          log += 'r(' + doc.x + ',' + at_index + ')';\n        }\n\n        return removedAt;\n      }()\n    });\n\n    var captureObserve = function captureObserve(f) {\n      if (Meteor.isClient) {\n        f();\n      } else {\n        var fence = new DDPServer._WriteFence();\n        DDPServer._CurrentWriteFence.withValue(fence, f);\n        fence.armAndWait();\n      }\n\n      var ret = log;\n      log = '';\n      return ret;\n    };\n\n    var expectObserve = function expectObserve(expected, f) {\n      if (!(expected instanceof Array)) expected = [expected];\n\n      test.include(expected, captureObserve(f));\n    };\n\n    test.equal(coll.find({ run: run }).count(), 0);\n    test.equal(coll.findOne(\"abc\"), undefined);\n    test.equal(coll.findOne({ run: run }), undefined);\n\n    expectObserve('a(1,0,null)', function () {\n      var id = coll.insert({ run: run, x: 1 });\n      test.equal(coll.find({ run: run }).count(), 1);\n      test.equal(coll.findOne(id).x, 1);\n      test.equal(coll.findOne({ run: run }).x, 1);\n    });\n\n    expectObserve('a(4,1,null)', function () {\n      var id2 = coll.insert({ run: run, x: 4 });\n      test.equal(coll.find({ run: run }).count(), 2);\n      test.equal(coll.find({ _id: id2 }).count(), 1);\n      test.equal(coll.findOne(id2).x, 4);\n    });\n\n    test.equal(coll.findOne({ run: run }, { sort: [\"x\"], skip: 0 }).x, 1);\n    test.equal(coll.findOne({ run: run }, { sort: [\"x\"], skip: 1 }).x, 4);\n    test.equal(coll.findOne({ run: run }, { sort: { x: -1 }, skip: 0 }).x, 4);\n    test.equal(coll.findOne({ run: run }, { sort: { x: -1 }, skip: 1 }).x, 1);\n\n    var cur = coll.find({ run: run }, { sort: [\"x\"] });\n    var total = 0;\n    var index = 0;\n    var context = {};\n    cur.forEach(function (doc, i, cursor) {\n      test.equal(i, index++);\n      test.isTrue(cursor === cur);\n      test.isTrue(context === this);\n      total *= 10;\n      if (Meteor.isServer) {\n        // Verify that the callbacks from forEach run sequentially and that\n        // forEach waits for them to complete (issue# 321). If they do not run\n        // sequentially, then the second callback could execute during the first\n        // callback's sleep sleep and the *= 10 will occur before the += 1, then\n        // total (at test.equal time) will be 5. If forEach does not wait for the\n        // callbacks to complete, then total (at test.equal time) will be 0.\n        Meteor._sleepForMs(5);\n      }\n      total += doc.x;\n      // verify the meteor environment is set up here\n      coll2.insert({ total: total });\n    }, context);\n    test.equal(total, 14);\n\n    index = 0;\n    test.equal(cur.map(function (doc, i, cursor) {\n      // XXX we could theoretically make map run its iterations in parallel or\n      // something which would make this fail\n      test.equal(i, index++);\n      test.isTrue(cursor === cur);\n      test.isTrue(context === this);\n      return doc.x * 2;\n    }, context), [2, 8]);\n\n    test.equal(_.pluck(coll.find({ run: run }, { sort: { x: -1 } }).fetch(), \"x\"), [4, 1]);\n\n    expectObserve('', function () {\n      var count = coll.update({ run: run, x: -1 }, { $inc: { x: 2 } }, { multi: true });\n      test.equal(count, 0);\n    });\n\n    expectObserve('c(3,0,1)c(6,1,4)', function () {\n      var count = coll.update({ run: run }, { $inc: { x: 2 } }, { multi: true });\n      test.equal(count, 2);\n      test.equal(_.pluck(coll.find({ run: run }, { sort: { x: -1 } }).fetch(), \"x\"), [6, 3]);\n    });\n\n    expectObserve(['c(13,0,3)m(13,0,1)', 'm(6,1,0)c(13,1,3)', 'c(13,0,3)m(6,1,0)', 'm(3,0,1)c(13,1,3)'], function () {\n      coll.update({ run: run, x: 3 }, { $inc: { x: 10 } }, { multi: true });\n      test.equal(_.pluck(coll.find({ run: run }, { sort: { x: -1 } }).fetch(), \"x\"), [13, 6]);\n    });\n\n    expectObserve('r(13,1)', function () {\n      var count = coll.remove({ run: run, x: { $gt: 10 } });\n      test.equal(count, 1);\n      test.equal(coll.find({ run: run }).count(), 1);\n    });\n\n    expectObserve('r(6,0)', function () {\n      coll.remove({ run: run });\n      test.equal(coll.find({ run: run }).count(), 0);\n    });\n\n    expectObserve('', function () {\n      var count = coll.remove({ run: run });\n      test.equal(count, 0);\n      test.equal(coll.find({ run: run }).count(), 0);\n    });\n\n    obs.stop();\n    onComplete();\n  });\n\n  Tinytest.addAsync(\"mongo-livedata - fuzz test, \" + idGeneration, function (test, onComplete) {\n\n    var run = Random.id();\n    var coll;\n    if (Meteor.isClient) {\n      coll = new Mongo.Collection(null, collectionOptions); // local, unmanaged\n    } else {\n        coll = new Mongo.Collection(\"livedata_test_collection_\" + run, collectionOptions);\n      }\n\n    // fuzz test of observe(), especially the server-side diffing\n    var actual = [];\n    var correct = [];\n    var counters = { add: 0, change: 0, move: 0, remove: 0 };\n\n    var obs = coll.find({ run: run }, { sort: [\"x\"] }).observe({\n      addedAt: function () {\n        function addedAt(doc, before_index) {\n          counters.add++;\n          actual.splice(before_index, 0, doc.x);\n        }\n\n        return addedAt;\n      }(),\n      changedAt: function () {\n        function changedAt(new_doc, old_doc, at_index) {\n          counters.change++;\n          test.equal(actual[at_index], old_doc.x);\n          actual[at_index] = new_doc.x;\n        }\n\n        return changedAt;\n      }(),\n      movedTo: function () {\n        function movedTo(doc, old_index, new_index) {\n          counters.move++;\n          test.equal(actual[old_index], doc.x);\n          actual.splice(old_index, 1);\n          actual.splice(new_index, 0, doc.x);\n        }\n\n        return movedTo;\n      }(),\n      removedAt: function () {\n        function removedAt(doc, at_index) {\n          counters.remove++;\n          test.equal(actual[at_index], doc.x);\n          actual.splice(at_index, 1);\n        }\n\n        return removedAt;\n      }()\n    });\n\n    if (Meteor.isServer) {\n      // For now, has to be polling (not oplog) because it is ordered observe.\n      test.isTrue(obs._multiplexer._observeDriver._suspendPolling);\n    }\n\n    var step = 0;\n\n    // Use non-deterministic randomness so we can have a shorter fuzz\n    // test (fewer iterations).  For deterministic (fully seeded)\n    // randomness, remove the call to Random.fraction().\n    var seededRandom = new SeededRandom(\"foobard\" + Random.fraction());\n    // Random integer in [0,n)\n    var rnd = function rnd(n) {\n      return seededRandom.nextIntBetween(0, n - 1);\n    };\n\n    var finishObserve = function finishObserve(f) {\n      if (Meteor.isClient) {\n        f();\n      } else {\n        var fence = new DDPServer._WriteFence();\n        DDPServer._CurrentWriteFence.withValue(fence, f);\n        fence.armAndWait();\n      }\n    };\n\n    var doStep = function doStep() {\n      if (step++ === 5) {\n        // run N random tests\n        obs.stop();\n        onComplete();\n        return;\n      }\n\n      var max_counters = _.clone(counters);\n\n      finishObserve(function () {\n        if (Meteor.isServer) obs._multiplexer._observeDriver._suspendPolling();\n\n        // Do a batch of 1-10 operations\n        var batch_count = rnd(10) + 1;\n        for (var i = 0; i < batch_count; i++) {\n          // 25% add, 25% remove, 25% change in place, 25% change and move\n          var op = rnd(4);\n          var which = rnd(correct.length);\n          if (op === 0 || step < 2 || !correct.length) {\n            // Add\n            var x = rnd(1000000);\n            coll.insert({ run: run, x: x });\n            correct.push(x);\n            max_counters.add++;\n          } else if (op === 1 || op === 2) {\n            var x = correct[which];\n            if (op === 1)\n              // Small change, not likely to cause a move\n              var val = x + (rnd(2) ? -1 : 1);else\n              // Large change, likely to cause a move\n              var val = rnd(1000000);\n            coll.update({ run: run, x: x }, { $set: { x: val } });\n            correct[which] = val;\n            max_counters.change++;\n            max_counters.move++;\n          } else {\n            coll.remove({ run: run, x: correct[which] });\n            correct.splice(which, 1);\n            max_counters.remove++;\n          }\n        }\n        if (Meteor.isServer) obs._multiplexer._observeDriver._resumePolling();\n      });\n\n      // Did we actually deliver messages that mutated the array in the\n      // right way?\n      correct.sort(function (a, b) {\n        return a - b;\n      });\n      test.equal(actual, correct);\n\n      // Did we limit ourselves to one 'moved' message per change,\n      // rather than O(results) moved messages?\n      _.each(max_counters, function (v, k) {\n        test.isTrue(max_counters[k] >= counters[k], k);\n      });\n\n      Meteor.defer(doStep);\n    };\n\n    doStep();\n  });\n\n  Tinytest.addAsync(\"mongo-livedata - scribbling, \" + idGeneration, function (test, onComplete) {\n    var run = test.runId();\n    var coll;\n    if (Meteor.isClient) {\n      coll = new Mongo.Collection(null, collectionOptions); // local, unmanaged\n    } else {\n        coll = new Mongo.Collection(\"livedata_test_collection_\" + run, collectionOptions);\n      }\n\n    var numAddeds = 0;\n    var handle = coll.find({ run: run }).observe({\n      addedAt: function () {\n        function addedAt(o) {\n          // test that we can scribble on the object we get back from Mongo without\n          // breaking anything.  The worst possible scribble is messing with _id.\n          delete o._id;\n          numAddeds++;\n        }\n\n        return addedAt;\n      }()\n    });\n    _.each([123, 456, 789], function (abc) {\n      runInFence(function () {\n        coll.insert({ run: run, abc: abc });\n      });\n    });\n    handle.stop();\n    // will be 6 (1+2+3) if we broke diffing!\n    test.equal(numAddeds, 3);\n\n    onComplete();\n  });\n\n  Tinytest.addAsync(\"mongo-livedata - stop handle in callback, \" + idGeneration, function (test, onComplete) {\n    var run = Random.id();\n    var coll;\n    if (Meteor.isClient) {\n      coll = new Mongo.Collection(null, collectionOptions); // local, unmanaged\n    } else {\n        coll = new Mongo.Collection(\"stopHandleInCallback-\" + run, collectionOptions);\n      }\n\n    var output = [];\n\n    var handle = coll.find().observe({\n      added: function () {\n        function added(doc) {\n          output.push({ added: doc._id });\n        }\n\n        return added;\n      }(),\n      changed: function () {\n        function changed(newDoc) {\n          output.push('changed');\n          handle.stop();\n        }\n\n        return changed;\n      }()\n    });\n\n    test.equal(output, []);\n\n    // Insert a document. Observe that the added callback is called.\n    var docId;\n    runInFence(function () {\n      docId = coll.insert({ foo: 42 });\n    });\n    test.length(output, 1);\n    test.equal(output.shift(), { added: docId });\n\n    // Update it. Observe that the changed callback is called. This should also\n    // stop the observation.\n    runInFence(function () {\n      coll.update(docId, { $set: { bar: 10 } });\n    });\n    test.length(output, 1);\n    test.equal(output.shift(), 'changed');\n\n    // Update again. This shouldn't call the callback because we stopped the\n    // observation.\n    runInFence(function () {\n      coll.update(docId, { $set: { baz: 40 } });\n    });\n    test.length(output, 0);\n\n    test.equal(coll.find().count(), 1);\n    test.equal(coll.findOne(docId), { _id: docId, foo: 42, bar: 10, baz: 40 });\n\n    onComplete();\n  });\n\n  // This behavior isn't great, but it beats deadlock.\n  if (Meteor.isServer) {\n    Tinytest.addAsync(\"mongo-livedata - recursive observe throws, \" + idGeneration, function (test, onComplete) {\n      var run = test.runId();\n      var coll = new Mongo.Collection(\"observeInCallback-\" + run, collectionOptions);\n\n      var callbackCalled = false;\n      var handle = coll.find({}).observe({\n        added: function () {\n          function added(newDoc) {\n            callbackCalled = true;\n            test.throws(function () {\n              coll.find({}).observe();\n            });\n          }\n\n          return added;\n        }()\n      });\n      test.isFalse(callbackCalled);\n      // Insert a document. Observe that the added callback is called.\n      runInFence(function () {\n        coll.insert({ foo: 42 });\n      });\n      test.isTrue(callbackCalled);\n\n      handle.stop();\n\n      onComplete();\n    });\n\n    Tinytest.addAsync(\"mongo-livedata - cursor dedup, \" + idGeneration, function (test, onComplete) {\n      var run = test.runId();\n      var coll = new Mongo.Collection(\"cursorDedup-\" + run, collectionOptions);\n\n      var observer = function observer(noAdded) {\n        var output = [];\n        var callbacks = {\n          changed: function () {\n            function changed(newDoc) {\n              output.push({ changed: newDoc._id });\n            }\n\n            return changed;\n          }()\n        };\n        if (!noAdded) {\n          callbacks.added = function (doc) {\n            output.push({ added: doc._id });\n          };\n        }\n        var handle = coll.find({ foo: 22 }).observe(callbacks);\n        return { output: output, handle: handle };\n      };\n\n      // Insert a doc and start observing.\n      var docId1 = coll.insert({ foo: 22 });\n      var o1 = observer();\n      // Initial add.\n      test.length(o1.output, 1);\n      test.equal(o1.output.shift(), { added: docId1 });\n\n      // Insert another doc (blocking until observes have fired).\n      var docId2;\n      runInFence(function () {\n        docId2 = coll.insert({ foo: 22, bar: 5 });\n      });\n      // Observed add.\n      test.length(o1.output, 1);\n      test.equal(o1.output.shift(), { added: docId2 });\n\n      // Second identical observe.\n      var o2 = observer();\n      // Initial adds.\n      test.length(o2.output, 2);\n      test.include([docId1, docId2], o2.output[0].added);\n      test.include([docId1, docId2], o2.output[1].added);\n      test.notEqual(o2.output[0].added, o2.output[1].added);\n      o2.output.length = 0;\n      // Original observe not affected.\n      test.length(o1.output, 0);\n\n      // White-box test: both observes should share an ObserveMultiplexer.\n      var observeMultiplexer = o1.handle._multiplexer;\n      test.isTrue(observeMultiplexer);\n      test.isTrue(observeMultiplexer === o2.handle._multiplexer);\n\n      // Update. Both observes fire.\n      runInFence(function () {\n        coll.update(docId1, { $set: { x: 'y' } });\n      });\n      test.length(o1.output, 1);\n      test.length(o2.output, 1);\n      test.equal(o1.output.shift(), { changed: docId1 });\n      test.equal(o2.output.shift(), { changed: docId1 });\n\n      // Stop first handle. Second handle still around.\n      o1.handle.stop();\n      test.length(o1.output, 0);\n      test.length(o2.output, 0);\n\n      // Another update. Just the second handle should fire.\n      runInFence(function () {\n        coll.update(docId2, { $set: { z: 'y' } });\n      });\n      test.length(o1.output, 0);\n      test.length(o2.output, 1);\n      test.equal(o2.output.shift(), { changed: docId2 });\n\n      // Stop second handle. Nothing should happen, but the multiplexer should\n      // be stopped.\n      test.isTrue(observeMultiplexer._handles); // This will change.\n      o2.handle.stop();\n      test.length(o1.output, 0);\n      test.length(o2.output, 0);\n      // White-box: ObserveMultiplexer has nulled its _handles so you can't\n      // accidentally join to it.\n      test.isNull(observeMultiplexer._handles);\n\n      // Start yet another handle on the same query.\n      var o3 = observer();\n      // Initial adds.\n      test.length(o3.output, 2);\n      test.include([docId1, docId2], o3.output[0].added);\n      test.include([docId1, docId2], o3.output[1].added);\n      test.notEqual(o3.output[0].added, o3.output[1].added);\n      // Old observers not called.\n      test.length(o1.output, 0);\n      test.length(o2.output, 0);\n      // White-box: Different ObserveMultiplexer.\n      test.isTrue(observeMultiplexer !== o3.handle._multiplexer);\n\n      // Start another handle with no added callback. Regression test for #589.\n      var o4 = observer(true);\n\n      o3.handle.stop();\n      o4.handle.stop();\n\n      onComplete();\n    });\n\n    Tinytest.addAsync(\"mongo-livedata - async server-side insert, \" + idGeneration, function (test, onComplete) {\n      // Tests that insert returns before the callback runs. Relies on the fact\n      // that mongo does not run the callback before spinning off the event loop.\n      var cname = Random.id();\n      var coll = new Mongo.Collection(cname);\n      var doc = { foo: \"bar\" };\n      var x = 0;\n      coll.insert(doc, function (err, result) {\n        test.equal(err, null);\n        test.equal(x, 1);\n        onComplete();\n      });\n      x++;\n    });\n\n    Tinytest.addAsync(\"mongo-livedata - async server-side update, \" + idGeneration, function (test, onComplete) {\n      // Tests that update returns before the callback runs.\n      var cname = Random.id();\n      var coll = new Mongo.Collection(cname);\n      var doc = { foo: \"bar\" };\n      var x = 0;\n      var id = coll.insert(doc);\n      coll.update(id, { $set: { foo: \"baz\" } }, function (err, result) {\n        test.equal(err, null);\n        test.equal(result, 1);\n        test.equal(x, 1);\n        onComplete();\n      });\n      x++;\n    });\n\n    Tinytest.addAsync(\"mongo-livedata - async server-side remove, \" + idGeneration, function (test, onComplete) {\n      // Tests that remove returns before the callback runs.\n      var cname = Random.id();\n      var coll = new Mongo.Collection(cname);\n      var doc = { foo: \"bar\" };\n      var x = 0;\n      var id = coll.insert(doc);\n      coll.remove(id, function (err, result) {\n        test.equal(err, null);\n        test.isFalse(coll.findOne(id));\n        test.equal(x, 1);\n        onComplete();\n      });\n      x++;\n    });\n\n    // compares arrays a and b w/o looking at order\n    var setsEqual = function setsEqual(a, b) {\n      a = _.map(a, EJSON.stringify);\n      b = _.map(b, EJSON.stringify);\n      return _.isEmpty(_.difference(a, b)) && _.isEmpty(_.difference(b, a));\n    };\n\n    // This test mainly checks the correctness of oplog code dealing with limited\n    // queries. Compitablity with poll-diff is added as well.\n    Tinytest.addAsync(\"mongo-livedata - observe sorted, limited \" + idGeneration, function (test, onComplete) {\n      var run = test.runId();\n      var coll = new Mongo.Collection(\"observeLimit-\" + run, collectionOptions);\n\n      var observer = function observer() {\n        var state = {};\n        var output = [];\n        var callbacks = {\n          changed: function () {\n            function changed(newDoc) {\n              output.push({ changed: newDoc._id });\n              state[newDoc._id] = newDoc;\n            }\n\n            return changed;\n          }(),\n          added: function () {\n            function added(newDoc) {\n              output.push({ added: newDoc._id });\n              state[newDoc._id] = newDoc;\n            }\n\n            return added;\n          }(),\n          removed: function () {\n            function removed(oldDoc) {\n              output.push({ removed: oldDoc._id });\n              delete state[oldDoc._id];\n            }\n\n            return removed;\n          }()\n        };\n        var handle = coll.find({ foo: 22 }, { sort: { bar: 1 }, limit: 3 }).observe(callbacks);\n\n        return { output: output, handle: handle, state: state };\n      };\n      var clearOutput = function clearOutput(o) {\n        o.output.splice(0, o.output.length);\n      };\n\n      var ins = function ins(doc) {\n        var id;runInFence(function () {\n          id = coll.insert(doc);\n        });\n        return id;\n      };\n      var rem = function rem(sel) {\n        runInFence(function () {\n          coll.remove(sel);\n        });\n      };\n      var upd = function upd(sel, mod, opt) {\n        runInFence(function () {\n          coll.update(sel, mod, opt);\n        });\n      };\n      // tests '_id' subfields for all documents in oplog buffer\n      var testOplogBufferIds = function testOplogBufferIds(ids) {\n        if (!usesOplog) return;\n        var bufferIds = [];\n        o.handle._multiplexer._observeDriver._unpublishedBuffer.forEach(function (x, id) {\n          bufferIds.push(id);\n        });\n\n        test.isTrue(setsEqual(ids, bufferIds), \"expected: \" + ids + \"; got: \" + bufferIds);\n      };\n      var testSafeAppendToBufferFlag = function testSafeAppendToBufferFlag(expected) {\n        if (!usesOplog) return;\n        test.equal(o.handle._multiplexer._observeDriver._safeAppendToBuffer, expected);\n      };\n\n      // We'll describe our state as follows.  5:1 means \"the document with\n      // _id=docId1 and bar=5\".  We list documents as\n      //   [ currently published | in the buffer ] outside the buffer\n      // If safeToAppendToBuffer is true, we'll say ]! instead.\n\n      // Insert a doc and start observing.\n      var docId1 = ins({ foo: 22, bar: 5 });\n      waitUntilOplogCaughtUp();\n\n      // State: [ 5:1 | ]!\n      var o = observer();\n      var usesOplog = o.handle._multiplexer._observeDriver._usesOplog;\n      // Initial add.\n      test.length(o.output, 1);\n      test.equal(o.output.shift(), { added: docId1 });\n      testSafeAppendToBufferFlag(true);\n\n      // Insert another doc (blocking until observes have fired).\n      // State: [ 5:1 6:2 | ]!\n      var docId2 = ins({ foo: 22, bar: 6 });\n      // Observed add.\n      test.length(o.output, 1);\n      test.equal(o.output.shift(), { added: docId2 });\n      testSafeAppendToBufferFlag(true);\n\n      var docId3 = ins({ foo: 22, bar: 3 });\n      // State: [ 3:3 5:1 6:2 | ]!\n      test.length(o.output, 1);\n      test.equal(o.output.shift(), { added: docId3 });\n      testSafeAppendToBufferFlag(true);\n\n      // Add a non-matching document\n      ins({ foo: 13 });\n      // It shouldn't be added\n      test.length(o.output, 0);\n\n      // Add something that matches but is too big to fit in\n      var docId4 = ins({ foo: 22, bar: 7 });\n      // State: [ 3:3 5:1 6:2 | 7:4 ]!\n      // It shouldn't be added but should end up in the buffer.\n      test.length(o.output, 0);\n      testOplogBufferIds([docId4]);\n      testSafeAppendToBufferFlag(true);\n\n      // Let's add something small enough to fit in\n      var docId5 = ins({ foo: 22, bar: -1 });\n      // State: [ -1:5 3:3 5:1 | 6:2 7:4 ]!\n      // We should get an added and a removed events\n      test.length(o.output, 2);\n      // doc 2 was removed from the published set as it is too big to be in\n      test.isTrue(setsEqual(o.output, [{ added: docId5 }, { removed: docId2 }]));\n      clearOutput(o);\n      testOplogBufferIds([docId2, docId4]);\n      testSafeAppendToBufferFlag(true);\n\n      // Now remove something and that doc 2 should be right back\n      rem(docId5);\n      // State: [ 3:3 5:1 6:2 | 7:4 ]!\n      test.length(o.output, 2);\n      test.isTrue(setsEqual(o.output, [{ removed: docId5 }, { added: docId2 }]));\n      clearOutput(o);\n      testOplogBufferIds([docId4]);\n      testSafeAppendToBufferFlag(true);\n\n      // Add some negative numbers overflowing the buffer.\n      // New documents will take the published place, [3 5 6] will take the buffer\n      // and 7 will be outside of the buffer in MongoDB.\n      var docId6 = ins({ foo: 22, bar: -1 });\n      var docId7 = ins({ foo: 22, bar: -2 });\n      var docId8 = ins({ foo: 22, bar: -3 });\n      // State: [ -3:8 -2:7 -1:6 | 3:3 5:1 6:2 ] 7:4\n      test.length(o.output, 6);\n      var expected = [{ added: docId6 }, { removed: docId2 }, { added: docId7 }, { removed: docId1 }, { added: docId8 }, { removed: docId3 }];\n      test.isTrue(setsEqual(o.output, expected));\n      clearOutput(o);\n      testOplogBufferIds([docId1, docId2, docId3]);\n      testSafeAppendToBufferFlag(false);\n\n      // If we update first 3 docs (increment them by 20), it would be\n      // interesting.\n      upd({ bar: { $lt: 0 } }, { $inc: { bar: 20 } }, { multi: true });\n      // State: [ 3:3 5:1 6:2 | ] 7:4 17:8 18:7 19:6\n      //   which triggers re-poll leaving us at\n      // State: [ 3:3 5:1 6:2 | 7:4 17:8 18:7 ] 19:6\n\n      // The updated documents can't find their place in published and they can't\n      // be buffered as we are not aware of the situation outside of the buffer.\n      // But since our buffer becomes empty, it will be refilled partially with\n      // updated documents.\n      test.length(o.output, 6);\n      var expectedRemoves = [{ removed: docId6 }, { removed: docId7 }, { removed: docId8 }];\n      var expectedAdds = [{ added: docId3 }, { added: docId1 }, { added: docId2 }];\n\n      test.isTrue(setsEqual(o.output, expectedAdds.concat(expectedRemoves)));\n      clearOutput(o);\n      testOplogBufferIds([docId4, docId7, docId8]);\n      testSafeAppendToBufferFlag(false);\n\n      // Remove first 4 docs (3, 1, 2, 4) forcing buffer to become empty and\n      // schedule a repoll.\n      rem({ bar: { $lt: 10 } });\n      // State: [ 17:8 18:7 19:6 | ]!\n\n      // XXX the oplog code analyzes the events one by one: one remove after\n      // another. Poll-n-diff code, on the other side, analyzes the batch action\n      // of multiple remove. Because of that difference, expected outputs differ.\n      if (usesOplog) {\n        var expectedRemoves = [{ removed: docId3 }, { removed: docId1 }, { removed: docId2 }, { removed: docId4 }];\n        var expectedAdds = [{ added: docId4 }, { added: docId8 }, { added: docId7 }, { added: docId6 }];\n\n        test.length(o.output, 8);\n      } else {\n        var expectedRemoves = [{ removed: docId3 }, { removed: docId1 }, { removed: docId2 }];\n        var expectedAdds = [{ added: docId8 }, { added: docId7 }, { added: docId6 }];\n\n        test.length(o.output, 6);\n      }\n\n      test.isTrue(setsEqual(o.output, expectedAdds.concat(expectedRemoves)));\n      clearOutput(o);\n      testOplogBufferIds([]);\n      testSafeAppendToBufferFlag(true);\n\n      var docId9 = ins({ foo: 22, bar: 21 });\n      var docId10 = ins({ foo: 22, bar: 31 });\n      var docId11 = ins({ foo: 22, bar: 41 });\n      var docId12 = ins({ foo: 22, bar: 51 });\n      // State: [ 17:8 18:7 19:6 | 21:9 31:10 41:11 ] 51:12\n\n      testOplogBufferIds([docId9, docId10, docId11]);\n      testSafeAppendToBufferFlag(false);\n      test.length(o.output, 0);\n      upd({ bar: { $lt: 20 } }, { $inc: { bar: 5 } }, { multi: true });\n      // State: [ 21:9 22:8 23:7 | 24:6 31:10 41:11 ] 51:12\n      test.length(o.output, 4);\n      test.isTrue(setsEqual(o.output, [{ removed: docId6 }, { added: docId9 }, { changed: docId7 }, { changed: docId8 }]));\n      clearOutput(o);\n      testOplogBufferIds([docId6, docId10, docId11]);\n      testSafeAppendToBufferFlag(false);\n\n      rem(docId9);\n      // State: [ 22:8 23:7 24:6 | 31:10 41:11 ] 51:12\n      test.length(o.output, 2);\n      test.isTrue(setsEqual(o.output, [{ removed: docId9 }, { added: docId6 }]));\n      clearOutput(o);\n      testOplogBufferIds([docId10, docId11]);\n      testSafeAppendToBufferFlag(false);\n\n      upd({ bar: { $gt: 25 } }, { $inc: { bar: -7.5 } }, { multi: true });\n      // State: [ 22:8 23:7 23.5:10 | 24:6 ] 33.5:11 43.5:12\n      // 33.5 doesn't update in-place in buffer, because it the driver is not sure\n      // it can do it: because the buffer does not have the safe append flag set,\n      // for all it knows there is a different doc which is less than 33.5.\n      test.length(o.output, 2);\n      test.isTrue(setsEqual(o.output, [{ removed: docId6 }, { added: docId10 }]));\n      clearOutput(o);\n      testOplogBufferIds([docId6]);\n      testSafeAppendToBufferFlag(false);\n\n      // Force buffer objects to be moved into published set so we can check them\n      rem(docId7);\n      rem(docId8);\n      rem(docId10);\n      // State: [ 24:6 | ] 33.5:11 43.5:12\n      //    triggers repoll\n      // State: [ 24:6 33.5:11 43.5:12 | ]!\n      test.length(o.output, 6);\n      test.isTrue(setsEqual(o.output, [{ removed: docId7 }, { removed: docId8 }, { removed: docId10 }, { added: docId6 }, { added: docId11 }, { added: docId12 }]));\n\n      test.length(_.keys(o.state), 3);\n      test.equal(o.state[docId6], { _id: docId6, foo: 22, bar: 24 });\n      test.equal(o.state[docId11], { _id: docId11, foo: 22, bar: 33.5 });\n      test.equal(o.state[docId12], { _id: docId12, foo: 22, bar: 43.5 });\n      clearOutput(o);\n      testOplogBufferIds([]);\n      testSafeAppendToBufferFlag(true);\n\n      var docId13 = ins({ foo: 22, bar: 50 });\n      var docId14 = ins({ foo: 22, bar: 51 });\n      var docId15 = ins({ foo: 22, bar: 52 });\n      var docId16 = ins({ foo: 22, bar: 53 });\n      // State: [ 24:6 33.5:11 43.5:12 | 50:13 51:14 52:15 ] 53:16\n      test.length(o.output, 0);\n      testOplogBufferIds([docId13, docId14, docId15]);\n      testSafeAppendToBufferFlag(false);\n\n      // Update something that's outside the buffer to be in the buffer, writing\n      // only to the sort key.\n      upd(docId16, { $set: { bar: 10 } });\n      // State: [ 10:16 24:6 33.5:11 | 43.5:12 50:13 51:14 ] 52:15\n      test.length(o.output, 2);\n      test.isTrue(setsEqual(o.output, [{ removed: docId12 }, { added: docId16 }]));\n      clearOutput(o);\n      testOplogBufferIds([docId12, docId13, docId14]);\n      testSafeAppendToBufferFlag(false);\n\n      o.handle.stop();\n      onComplete();\n    });\n\n    Tinytest.addAsync(\"mongo-livedata - observe sorted, limited, sort fields \" + idGeneration, function (test, onComplete) {\n      var run = test.runId();\n      var coll = new Mongo.Collection(\"observeLimit-\" + run, collectionOptions);\n\n      var observer = function observer() {\n        var state = {};\n        var output = [];\n        var callbacks = {\n          changed: function () {\n            function changed(newDoc) {\n              output.push({ changed: newDoc._id });\n              state[newDoc._id] = newDoc;\n            }\n\n            return changed;\n          }(),\n          added: function () {\n            function added(newDoc) {\n              output.push({ added: newDoc._id });\n              state[newDoc._id] = newDoc;\n            }\n\n            return added;\n          }(),\n          removed: function () {\n            function removed(oldDoc) {\n              output.push({ removed: oldDoc._id });\n              delete state[oldDoc._id];\n            }\n\n            return removed;\n          }()\n        };\n        var handle = coll.find({}, { sort: { x: 1 },\n          limit: 2,\n          fields: { y: 1 } }).observe(callbacks);\n\n        return { output: output, handle: handle, state: state };\n      };\n      var clearOutput = function clearOutput(o) {\n        o.output.splice(0, o.output.length);\n      };\n      var ins = function ins(doc) {\n        var id;runInFence(function () {\n          id = coll.insert(doc);\n        });\n        return id;\n      };\n      var rem = function rem(id) {\n        runInFence(function () {\n          coll.remove(id);\n        });\n      };\n\n      var o = observer();\n\n      var docId1 = ins({ x: 1, y: 1222 });\n      var docId2 = ins({ x: 5, y: 5222 });\n\n      test.length(o.output, 2);\n      test.equal(o.output, [{ added: docId1 }, { added: docId2 }]);\n      clearOutput(o);\n\n      var docId3 = ins({ x: 7, y: 7222 });\n      test.length(o.output, 0);\n\n      var docId4 = ins({ x: -1, y: -1222 });\n\n      // Becomes [docId4 docId1 | docId2 docId3]\n      test.length(o.output, 2);\n      test.isTrue(setsEqual(o.output, [{ added: docId4 }, { removed: docId2 }]));\n\n      test.equal(_.size(o.state), 2);\n      test.equal(o.state[docId4], { _id: docId4, y: -1222 });\n      test.equal(o.state[docId1], { _id: docId1, y: 1222 });\n      clearOutput(o);\n\n      rem(docId2);\n      // Becomes [docId4 docId1 | docId3]\n      test.length(o.output, 0);\n\n      rem(docId4);\n      // Becomes [docId1 docId3]\n      test.length(o.output, 2);\n      test.isTrue(setsEqual(o.output, [{ added: docId3 }, { removed: docId4 }]));\n\n      test.equal(_.size(o.state), 2);\n      test.equal(o.state[docId3], { _id: docId3, y: 7222 });\n      test.equal(o.state[docId1], { _id: docId1, y: 1222 });\n      clearOutput(o);\n\n      onComplete();\n    });\n\n    Tinytest.addAsync(\"mongo-livedata - observe sorted, limited, big initial set\" + idGeneration, function (test, onComplete) {\n      var run = test.runId();\n      var coll = new Mongo.Collection(\"observeLimit-\" + run, collectionOptions);\n\n      var observer = function observer() {\n        var state = {};\n        var output = [];\n        var callbacks = {\n          changed: function () {\n            function changed(newDoc) {\n              output.push({ changed: newDoc._id });\n              state[newDoc._id] = newDoc;\n            }\n\n            return changed;\n          }(),\n          added: function () {\n            function added(newDoc) {\n              output.push({ added: newDoc._id });\n              state[newDoc._id] = newDoc;\n            }\n\n            return added;\n          }(),\n          removed: function () {\n            function removed(oldDoc) {\n              output.push({ removed: oldDoc._id });\n              delete state[oldDoc._id];\n            }\n\n            return removed;\n          }()\n        };\n        var handle = coll.find({}, { sort: { x: 1, y: 1 }, limit: 3 }).observe(callbacks);\n\n        return { output: output, handle: handle, state: state };\n      };\n      var clearOutput = function clearOutput(o) {\n        o.output.splice(0, o.output.length);\n      };\n      var ins = function ins(doc) {\n        var id;runInFence(function () {\n          id = coll.insert(doc);\n        });\n        return id;\n      };\n      var rem = function rem(id) {\n        runInFence(function () {\n          coll.remove(id);\n        });\n      };\n      // tests '_id' subfields for all documents in oplog buffer\n      var testOplogBufferIds = function testOplogBufferIds(ids) {\n        var bufferIds = [];\n        o.handle._multiplexer._observeDriver._unpublishedBuffer.forEach(function (x, id) {\n          bufferIds.push(id);\n        });\n\n        test.isTrue(setsEqual(ids, bufferIds), \"expected: \" + ids + \"; got: \" + bufferIds);\n      };\n      var testSafeAppendToBufferFlag = function testSafeAppendToBufferFlag(expected) {\n        if (expected) test.isTrue(o.handle._multiplexer._observeDriver._safeAppendToBuffer);else test.isFalse(o.handle._multiplexer._observeDriver._safeAppendToBuffer);\n      };\n\n      var ids = {};\n      _.each([2, 4, 1, 3, 5, 5, 9, 1, 3, 2, 5], function (x, i) {\n        ids[i] = ins({ x: x, y: i });\n      });\n\n      // Ensure that we are past all the 'i' entries before we run the query, so\n      // that we get the expected phase transitions.\n      waitUntilOplogCaughtUp();\n\n      var o = observer();\n      var usesOplog = o.handle._multiplexer._observeDriver._usesOplog;\n      //  x: [1 1 2 | 2 3 3] 4 5 5 5  9\n      // id: [2 7 0 | 9 3 8] 1 4 5 10 6\n\n      test.length(o.output, 3);\n      test.isTrue(setsEqual([{ added: ids[2] }, { added: ids[7] }, { added: ids[0] }], o.output));\n      usesOplog && testOplogBufferIds([ids[9], ids[3], ids[8]]);\n      usesOplog && testSafeAppendToBufferFlag(false);\n      clearOutput(o);\n\n      rem(ids[0]);\n      //  x: [1 1 2 | 3 3] 4 5 5 5  9\n      // id: [2 7 9 | 3 8] 1 4 5 10 6\n      test.length(o.output, 2);\n      test.isTrue(setsEqual([{ removed: ids[0] }, { added: ids[9] }], o.output));\n      usesOplog && testOplogBufferIds([ids[3], ids[8]]);\n      usesOplog && testSafeAppendToBufferFlag(false);\n      clearOutput(o);\n\n      rem(ids[7]);\n      //  x: [1 2 3 | 3] 4 5 5 5  9\n      // id: [2 9 3 | 8] 1 4 5 10 6\n      test.length(o.output, 2);\n      test.isTrue(setsEqual([{ removed: ids[7] }, { added: ids[3] }], o.output));\n      usesOplog && testOplogBufferIds([ids[8]]);\n      usesOplog && testSafeAppendToBufferFlag(false);\n      clearOutput(o);\n\n      rem(ids[3]);\n      //  x: [1 2 3 | 4 5 5] 5  9\n      // id: [2 9 8 | 1 4 5] 10 6\n      test.length(o.output, 2);\n      test.isTrue(setsEqual([{ removed: ids[3] }, { added: ids[8] }], o.output));\n      usesOplog && testOplogBufferIds([ids[1], ids[4], ids[5]]);\n      usesOplog && testSafeAppendToBufferFlag(false);\n      clearOutput(o);\n\n      rem({ x: { $lt: 4 } });\n      //  x: [4 5 5 | 5  9]\n      // id: [1 4 5 | 10 6]\n      test.length(o.output, 6);\n      test.isTrue(setsEqual([{ removed: ids[2] }, { removed: ids[9] }, { removed: ids[8] }, { added: ids[5] }, { added: ids[4] }, { added: ids[1] }], o.output));\n      usesOplog && testOplogBufferIds([ids[10], ids[6]]);\n      usesOplog && testSafeAppendToBufferFlag(true);\n      clearOutput(o);\n\n      onComplete();\n    });\n  }\n\n  testAsyncMulti('mongo-livedata - empty documents, ' + idGeneration, [function (test, expect) {\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var coll = new Mongo.Collection(this.collectionName, collectionOptions);\n\n    coll.insert({}, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      var cursor = coll.find();\n      test.equal(cursor.count(), 1);\n    }));\n  }]);\n\n  // Regression test for #2413.\n  testAsyncMulti('mongo-livedata - upsert without callback, ' + idGeneration, [function (test, expect) {\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var coll = new Mongo.Collection(this.collectionName, collectionOptions);\n\n    // No callback!  Before fixing #2413, this method never returned and\n    // so no future DDP methods worked either.\n    coll.upsert('foo', { bar: 1 });\n    // Do something else on the same method and expect it to actually work.\n    // (If the bug comes back, this will 'async batch timeout'.)\n    coll.insert({}, expect(function () {}));\n  }]);\n\n  // See https://github.com/meteor/meteor/issues/594.\n  testAsyncMulti('mongo-livedata - document with length, ' + idGeneration, [function (test, expect) {\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName, collectionOptions);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var self = this;\n    var coll = self.coll = new Mongo.Collection(self.collectionName, collectionOptions);\n\n    coll.insert({ foo: 'x', length: 0 }, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      self.docId = id;\n      test.equal(coll.findOne(self.docId), { _id: self.docId, foo: 'x', length: 0 });\n    }));\n  }, function (test, expect) {\n    var self = this;\n    var coll = self.coll;\n    coll.update(self.docId, { $set: { length: 5 } }, expect(function (err) {\n      test.isFalse(err);\n      test.equal(coll.findOne(self.docId), { _id: self.docId, foo: 'x', length: 5 });\n    }));\n  }]);\n\n  testAsyncMulti('mongo-livedata - document with a date, ' + idGeneration, [function (test, expect) {\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName, collectionOptions);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n\n    var coll = new Mongo.Collection(this.collectionName, collectionOptions);\n    var docId;\n    coll.insert({ d: new Date(1356152390004) }, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      docId = id;\n      var cursor = coll.find();\n      test.equal(cursor.count(), 1);\n      test.equal(coll.findOne().d.getFullYear(), 2012);\n    }));\n  }]);\n\n  testAsyncMulti('mongo-livedata - document goes through a transform, ' + idGeneration, [function (test, expect) {\n    var self = this;\n    var seconds = function seconds(doc) {\n      doc.seconds = function () {\n        return doc.d.getSeconds();\n      };\n      return doc;\n    };\n    TRANSFORMS[\"seconds\"] = seconds;\n    self.collectionOptions = {\n      idGeneration: idGeneration,\n      transform: seconds,\n      transformName: \"seconds\"\n    };\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName, collectionOptions);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var self = this;\n    self.coll = new Mongo.Collection(self.collectionName, self.collectionOptions);\n    var obs;\n    var expectAdd = expect(function (doc) {\n      test.equal(doc.seconds(), 50);\n    });\n    var expectRemove = expect(function (doc) {\n      test.equal(doc.seconds(), 50);\n      obs.stop();\n    });\n    self.coll.insert({ d: new Date(1356152390004) }, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      var cursor = self.coll.find();\n      obs = cursor.observe({\n        added: expectAdd,\n        removed: expectRemove\n      });\n      test.equal(cursor.count(), 1);\n      test.equal(cursor.fetch()[0].seconds(), 50);\n      test.equal(self.coll.findOne().seconds(), 50);\n      test.equal(self.coll.findOne({}, { transform: null }).seconds, undefined);\n      test.equal(self.coll.findOne({}, {\n        transform: function () {\n          function transform(doc) {\n            return { seconds: doc.d.getSeconds() };\n          }\n\n          return transform;\n        }()\n      }).seconds, 50);\n      self.coll.remove(id);\n    }));\n  }, function (test, expect) {\n    var self = this;\n    self.coll.insert({ d: new Date(1356152390004) }, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      self.id1 = id;\n    }));\n    self.coll.insert({ d: new Date(1356152391004) }, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      self.id2 = id;\n    }));\n  }]);\n\n  testAsyncMulti('mongo-livedata - transform sets _id if not present, ' + idGeneration, [function (test, expect) {\n    var self = this;\n    var justId = function justId(doc) {\n      return _.omit(doc, '_id');\n    };\n    TRANSFORMS[\"justId\"] = justId;\n    var collectionOptions = {\n      idGeneration: idGeneration,\n      transform: justId,\n      transformName: \"justId\"\n    };\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName, collectionOptions);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var self = this;\n    self.coll = new Mongo.Collection(this.collectionName, collectionOptions);\n    self.coll.insert({}, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      test.equal(self.coll.findOne()._id, id);\n    }));\n  }]);\n\n  var bin = Base64.decode(\"TWFuIGlzIGRpc3Rpbmd1aXNoZWQsIG5vdCBvbmx5IGJ5IGhpcyBy\" + \"ZWFzb24sIGJ1dCBieSB0aGlzIHNpbmd1bGFyIHBhc3Npb24gZnJv\" + \"bSBvdGhlciBhbmltYWxzLCB3aGljaCBpcyBhIGx1c3Qgb2YgdGhl\" + \"IG1pbmQsIHRoYXQgYnkgYSBwZXJzZXZlcmFuY2Ugb2YgZGVsaWdo\" + \"dCBpbiB0aGUgY29udGludWVkIGFuZCBpbmRlZmF0aWdhYmxlIGdl\" + \"bmVyYXRpb24gb2Yga25vd2xlZGdlLCBleGNlZWRzIHRoZSBzaG9y\" + \"dCB2ZWhlbWVuY2Ugb2YgYW55IGNhcm5hbCBwbGVhc3VyZS4=\");\n\n  testAsyncMulti('mongo-livedata - document with binary data, ' + idGeneration, [function (test, expect) {\n    // XXX probably shouldn't use EJSON's private test symbols\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName, collectionOptions);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var coll = new Mongo.Collection(this.collectionName, collectionOptions);\n    var docId;\n    coll.insert({ b: bin }, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      docId = id;\n      var cursor = coll.find();\n      test.equal(cursor.count(), 1);\n      var inColl = coll.findOne();\n      test.isTrue(EJSON.isBinary(inColl.b));\n      test.equal(inColl.b, bin);\n    }));\n  }]);\n\n  testAsyncMulti('mongo-livedata - document with a custom type, ' + idGeneration, [function (test, expect) {\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName, collectionOptions);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var self = this;\n    self.coll = new Mongo.Collection(this.collectionName, collectionOptions);\n    var docId;\n    // Dog is implemented at the top of the file, outside of the idGeneration\n    // loop (so that we only call EJSON.addType once).\n    var d = new Dog(\"reginald\", \"purple\");\n    self.coll.insert({ d: d }, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      docId = id;\n      self.docId = docId;\n      var cursor = self.coll.find();\n      test.equal(cursor.count(), 1);\n      var inColl = self.coll.findOne();\n      test.isTrue(inColl);\n      inColl && test.equal(inColl.d.speak(), \"woof\");\n    }));\n  }, function (test, expect) {\n    var self = this;\n    self.coll.insert(new Dog(\"rover\", \"orange\"), expect(function (err, id) {\n      test.isTrue(err);\n      test.isFalse(id);\n    }));\n  }, function (test, expect) {\n    var self = this;\n    self.coll.update(self.docId, new Dog(\"rover\", \"orange\"), expect(function (err) {\n      test.isTrue(err);\n    }));\n  }]);\n\n  if (Meteor.isServer) {\n    Tinytest.addAsync(\"mongo-livedata - update return values, \" + idGeneration, function (test, onComplete) {\n      var run = test.runId();\n      var coll = new Mongo.Collection(\"livedata_update_result_\" + run, collectionOptions);\n\n      coll.insert({ foo: \"bar\" });\n      coll.insert({ foo: \"baz\" });\n      test.equal(coll.update({}, { $set: { foo: \"qux\" } }, { multi: true }), 2);\n      coll.update({}, { $set: { foo: \"quux\" } }, { multi: true }, function (err, result) {\n        test.isFalse(err);\n        test.equal(result, 2);\n        onComplete();\n      });\n    });\n\n    Tinytest.addAsync(\"mongo-livedata - remove return values, \" + idGeneration, function (test, onComplete) {\n      var run = test.runId();\n      var coll = new Mongo.Collection(\"livedata_update_result_\" + run, collectionOptions);\n\n      coll.insert({ foo: \"bar\" });\n      coll.insert({ foo: \"baz\" });\n      test.equal(coll.remove({}), 2);\n      coll.insert({ foo: \"bar\" });\n      coll.insert({ foo: \"baz\" });\n      coll.remove({}, function (err, result) {\n        test.isFalse(err);\n        test.equal(result, 2);\n        onComplete();\n      });\n    });\n\n    Tinytest.addAsync(\"mongo-livedata - id-based invalidation, \" + idGeneration, function (test, onComplete) {\n      var run = test.runId();\n      var coll = new Mongo.Collection(\"livedata_invalidation_collection_\" + run, collectionOptions);\n\n      coll.allow({\n        update: function () {\n          function update() {\n            return true;\n          }\n\n          return update;\n        }(),\n        remove: function () {\n          function remove() {\n            return true;\n          }\n\n          return remove;\n        }()\n      });\n\n      var id1 = coll.insert({ x: 42, is1: true });\n      var id2 = coll.insert({ x: 50, is2: true });\n\n      var polls = {};\n      var handlesToStop = [];\n      var observe = function observe(name, query) {\n        var handle = coll.find(query).observeChanges({\n          // Make sure that we only poll on invalidation, not due to time, and\n          // keep track of when we do. Note: this option disables the use of\n          // oplogs (which admittedly is somewhat irrelevant to this feature).\n          _testOnlyPollCallback: function () {\n            function _testOnlyPollCallback() {\n              polls[name] = name in polls ? polls[name] + 1 : 1;\n            }\n\n            return _testOnlyPollCallback;\n          }()\n        });\n        handlesToStop.push(handle);\n      };\n\n      observe(\"all\", {});\n      observe(\"id1Direct\", id1);\n      observe(\"id1InQuery\", { _id: id1, z: null });\n      observe(\"id2Direct\", id2);\n      observe(\"id2InQuery\", { _id: id2, z: null });\n      observe(\"bothIds\", { _id: { $in: [id1, id2] } });\n\n      var resetPollsAndRunInFence = function resetPollsAndRunInFence(f) {\n        polls = {};\n        runInFence(f);\n      };\n\n      // Update id1 directly. This should poll all but the \"id2\" queries. \"all\"\n      // and \"bothIds\" increment by 2 because they are looking at both.\n      resetPollsAndRunInFence(function () {\n        coll.update(id1, { $inc: { x: 1 } });\n      });\n      test.equal(polls, { all: 1, id1Direct: 1, id1InQuery: 1, bothIds: 1 });\n\n      // Update id2 using a funny query. This should poll all but the \"id1\"\n      // queries.\n      resetPollsAndRunInFence(function () {\n        coll.update({ _id: id2, q: null }, { $inc: { x: 1 } });\n      });\n      test.equal(polls, { all: 1, id2Direct: 1, id2InQuery: 1, bothIds: 1 });\n\n      // Update both using a $in query. Should poll each of them exactly once.\n      resetPollsAndRunInFence(function () {\n        coll.update({ _id: { $in: [id1, id2] }, q: null }, { $inc: { x: 1 } });\n      });\n      test.equal(polls, { all: 1, id1Direct: 1, id1InQuery: 1, id2Direct: 1, id2InQuery: 1,\n        bothIds: 1 });\n\n      _.each(handlesToStop, function (h) {\n        h.stop();\n      });\n      onComplete();\n    });\n\n    Tinytest.add(\"mongo-livedata - upsert error parse, \" + idGeneration, function (test) {\n      var run = test.runId();\n      var coll = new Mongo.Collection(\"livedata_upsert_errorparse_collection_\" + run, collectionOptions);\n\n      coll.insert({ _id: 'foobar' });\n      var err;\n      try {\n        coll.update({ _id: 'foobar' }, { _id: 'cowbar' });\n      } catch (e) {\n        err = e;\n      }\n      test.isTrue(err);\n      test.isTrue(MongoInternals.Connection._isCannotChangeIdError(err));\n\n      try {\n        coll.insert({ _id: 'foobar' });\n      } catch (e) {\n        err = e;\n      }\n      test.isTrue(err);\n      // duplicate id error is not same as change id error\n      test.isFalse(MongoInternals.Connection._isCannotChangeIdError(err));\n    });\n  } // end Meteor.isServer\n\n  // This test is duplicated below (with some changes) for async upserts that go\n  // over the network.\n  _.each(Meteor.isServer ? [true, false] : [true], function (minimongo) {\n    _.each([true, false], function (useUpdate) {\n      _.each([true, false], function (useDirectCollection) {\n        Tinytest.add(\"mongo-livedata - \" + (useUpdate ? \"update \" : \"\") + \"upsert\" + (minimongo ? \" minimongo\" : \"\") + (useDirectCollection ? \" direct collection \" : \"\") + \", \" + idGeneration, function (test) {\n          var run = test.runId();\n          var options = collectionOptions;\n          // We don't get ids back when we use update() to upsert, or when we are\n          // directly calling MongoConnection.upsert().\n          var skipIds = useUpdate || !minimongo && useDirectCollection;\n          if (minimongo) options = _.extend({}, collectionOptions, { connection: null });\n          var coll = new Mongo.Collection(\"livedata_upsert_collection_\" + run + (useUpdate ? \"_update_\" : \"\") + (minimongo ? \"_minimongo_\" : \"\") + (useDirectCollection ? \"_direct_\" : \"\") + \"\", options);\n          if (useDirectCollection) coll = coll._collection;\n\n          var result1 = upsert(coll, useUpdate, { foo: 'bar' }, { foo: 'bar' });\n          test.equal(result1.numberAffected, 1);\n          if (!skipIds) test.isTrue(result1.insertedId);\n          compareResults(test, skipIds, coll.find().fetch(), [{ foo: 'bar', _id: result1.insertedId }]);\n\n          var result2 = upsert(coll, useUpdate, { foo: 'bar' }, { foo: 'baz' });\n          test.equal(result2.numberAffected, 1);\n          if (!skipIds) test.isFalse(result2.insertedId);\n          compareResults(test, skipIds, coll.find().fetch(), [{ foo: 'baz', _id: result1.insertedId }]);\n\n          coll.remove({});\n\n          // Test values that require transformation to go into Mongo:\n\n          var t1 = new Mongo.ObjectID();\n          var t2 = new Mongo.ObjectID();\n          var result3 = upsert(coll, useUpdate, { foo: t1 }, { foo: t1 });\n          test.equal(result3.numberAffected, 1);\n          if (!skipIds) test.isTrue(result3.insertedId);\n          compareResults(test, skipIds, coll.find().fetch(), [{ foo: t1, _id: result3.insertedId }]);\n\n          var result4 = upsert(coll, useUpdate, { foo: t1 }, { foo: t2 });\n          test.equal(result2.numberAffected, 1);\n          if (!skipIds) test.isFalse(result2.insertedId);\n          compareResults(test, skipIds, coll.find().fetch(), [{ foo: t2, _id: result3.insertedId }]);\n\n          coll.remove({});\n\n          // Test modification by upsert\n\n          var result5 = upsert(coll, useUpdate, { name: 'David' }, { $set: { foo: 1 } });\n          test.equal(result5.numberAffected, 1);\n          if (!skipIds) test.isTrue(result5.insertedId);\n          var davidId = result5.insertedId;\n          compareResults(test, skipIds, coll.find().fetch(), [{ name: 'David', foo: 1, _id: davidId }]);\n\n          test.throws(function () {\n            // test that bad modifier fails fast\n            upsert(coll, useUpdate, { name: 'David' }, { $blah: { foo: 2 } });\n          });\n\n          var result6 = upsert(coll, useUpdate, { name: 'David' }, { $set: { foo: 2 } });\n          test.equal(result6.numberAffected, 1);\n          if (!skipIds) test.isFalse(result6.insertedId);\n          compareResults(test, skipIds, coll.find().fetch(), [{ name: 'David', foo: 2,\n            _id: result5.insertedId }]);\n\n          var emilyId = coll.insert({ name: 'Emily', foo: 2 });\n          compareResults(test, skipIds, coll.find().fetch(), [{ name: 'David', foo: 2, _id: davidId }, { name: 'Emily', foo: 2, _id: emilyId }]);\n\n          // multi update by upsert\n          var result7 = upsert(coll, useUpdate, { foo: 2 }, { $set: { bar: 7 },\n            $setOnInsert: { name: 'Fred', foo: 2 } }, { multi: true });\n          test.equal(result7.numberAffected, 2);\n          if (!skipIds) test.isFalse(result7.insertedId);\n          compareResults(test, skipIds, coll.find().fetch(), [{ name: 'David', foo: 2, bar: 7, _id: davidId }, { name: 'Emily', foo: 2, bar: 7, _id: emilyId }]);\n\n          // insert by multi upsert\n          var result8 = upsert(coll, useUpdate, { foo: 3 }, { $set: { bar: 7 },\n            $setOnInsert: { name: 'Fred', foo: 2 } }, { multi: true });\n          test.equal(result8.numberAffected, 1);\n          if (!skipIds) test.isTrue(result8.insertedId);\n          var fredId = result8.insertedId;\n          compareResults(test, skipIds, coll.find().fetch(), [{ name: 'David', foo: 2, bar: 7, _id: davidId }, { name: 'Emily', foo: 2, bar: 7, _id: emilyId }, { name: 'Fred', foo: 2, bar: 7, _id: fredId }]);\n\n          // test `insertedId` option\n          var result9 = upsert(coll, useUpdate, { name: 'Steve' }, { name: 'Steve' }, { insertedId: 'steve' });\n          test.equal(result9.numberAffected, 1);\n          if (!skipIds) test.equal(result9.insertedId, 'steve');\n          compareResults(test, skipIds, coll.find().fetch(), [{ name: 'David', foo: 2, bar: 7, _id: davidId }, { name: 'Emily', foo: 2, bar: 7, _id: emilyId }, { name: 'Fred', foo: 2, bar: 7, _id: fredId }, { name: 'Steve', _id: 'steve' }]);\n          test.isTrue(coll.findOne('steve'));\n          test.isFalse(coll.findOne('fred'));\n\n          // Test $ operator in selectors.\n\n          var result10 = upsert(coll, useUpdate, { $or: [{ name: 'David' }, { name: 'Emily' }] }, { $set: { foo: 3 } }, { multi: true });\n          test.equal(result10.numberAffected, 2);\n          if (!skipIds) test.isFalse(result10.insertedId);\n          compareResults(test, skipIds, [coll.findOne({ name: 'David' }), coll.findOne({ name: 'Emily' })], [{ name: 'David', foo: 3, bar: 7, _id: davidId }, { name: 'Emily', foo: 3, bar: 7, _id: emilyId }]);\n\n          var result11 = upsert(coll, useUpdate, {\n            name: 'Charlie',\n            $or: [{ foo: 2 }, { bar: 7 }]\n          }, { $set: { foo: 3 } });\n          test.equal(result11.numberAffected, 1);\n          if (!skipIds) test.isTrue(result11.insertedId);\n          var charlieId = result11.insertedId;\n          compareResults(test, skipIds, coll.find({ name: 'Charlie' }).fetch(), [{ name: 'Charlie', foo: 3, _id: charlieId }]);\n        });\n      });\n    });\n  });\n\n  var asyncUpsertTestName = function asyncUpsertTestName(useNetwork, useDirectCollection, useUpdate, idGeneration) {\n    return \"mongo-livedata - async \" + (useUpdate ? \"update \" : \"\") + \"upsert \" + (useNetwork ? \"over network \" : \"\") + (useDirectCollection ? \", direct collection \" : \"\") + idGeneration;\n  };\n\n  // This is a duplicate of the test above, with some changes to make it work for\n  // callback style. On the client, we test server-backed and in-memory\n  // collections, and run the tests for both the Mongo.Collection and the\n  // LocalCollection. On the server, we test mongo-backed collections, for both\n  // the Mongo.Collection and the MongoConnection.\n  //\n  // XXX Rewrite with testAsyncMulti, that would simplify things a lot!\n  _.each(Meteor.isServer ? [false] : [true, false], function (useNetwork) {\n    _.each(useNetwork ? [false] : [true, false], function (useDirectCollection) {\n      _.each([true, false], function (useUpdate) {\n        Tinytest.addAsync(asyncUpsertTestName(useNetwork, useDirectCollection, useUpdate, idGeneration), function (test, onComplete) {\n          var coll;\n          var run = test.runId();\n          var collName = \"livedata_upsert_collection_\" + run + (useUpdate ? \"_update_\" : \"\") + (useNetwork ? \"_network_\" : \"\") + (useDirectCollection ? \"_direct_\" : \"\");\n\n          var next0 = function next0() {\n            // Test starts here.\n            upsert(coll, useUpdate, { _id: 'foo' }, { _id: 'foo', foo: 'bar' }, next1);\n          };\n\n          if (useNetwork) {\n            Meteor.call(\"createInsecureCollection\", collName, collectionOptions);\n            coll = new Mongo.Collection(collName, collectionOptions);\n            Meteor.subscribe(\"c-\" + collName, next0);\n          } else {\n            var opts = _.clone(collectionOptions);\n            if (Meteor.isClient) opts.connection = null;\n            coll = new Mongo.Collection(collName, opts);\n            if (useDirectCollection) coll = coll._collection;\n          }\n\n          var result1;\n          var next1 = function next1(err, result) {\n            result1 = result;\n            test.equal(result1.numberAffected, 1);\n            if (!useUpdate) {\n              test.isTrue(result1.insertedId);\n              test.equal(result1.insertedId, 'foo');\n            }\n            compareResults(test, useUpdate, coll.find().fetch(), [{ foo: 'bar', _id: 'foo' }]);\n            upsert(coll, useUpdate, { _id: 'foo' }, { foo: 'baz' }, next2);\n          };\n\n          if (!useNetwork) {\n            next0();\n          }\n\n          var t1, t2, result2;\n          var next2 = function next2(err, result) {\n            result2 = result;\n            test.equal(result2.numberAffected, 1);\n            if (!useUpdate) test.isFalse(result2.insertedId);\n            compareResults(test, useUpdate, coll.find().fetch(), [{ foo: 'baz', _id: result1.insertedId }]);\n            coll.remove({ _id: 'foo' });\n            compareResults(test, useUpdate, coll.find().fetch(), []);\n\n            // Test values that require transformation to go into Mongo:\n\n            t1 = new Mongo.ObjectID();\n            t2 = new Mongo.ObjectID();\n            upsert(coll, useUpdate, { _id: t1 }, { _id: t1, foo: 'bar' }, next3);\n          };\n\n          var result3;\n          var next3 = function next3(err, result) {\n            result3 = result;\n            test.equal(result3.numberAffected, 1);\n            if (!useUpdate) {\n              test.isTrue(result3.insertedId);\n              test.equal(t1, result3.insertedId);\n            }\n            compareResults(test, useUpdate, coll.find().fetch(), [{ _id: t1, foo: 'bar' }]);\n\n            upsert(coll, useUpdate, { _id: t1 }, { foo: t2 }, next4);\n          };\n\n          var next4 = function next4(err, result4) {\n            test.equal(result2.numberAffected, 1);\n            if (!useUpdate) test.isFalse(result2.insertedId);\n            compareResults(test, useUpdate, coll.find().fetch(), [{ foo: t2, _id: result3.insertedId }]);\n\n            coll.remove({ _id: t1 });\n\n            // Test modification by upsert\n            upsert(coll, useUpdate, { _id: 'David' }, { $set: { foo: 1 } }, next5);\n          };\n\n          var result5;\n          var next5 = function next5(err, result) {\n            result5 = result;\n            test.equal(result5.numberAffected, 1);\n            if (!useUpdate) {\n              test.isTrue(result5.insertedId);\n              test.equal(result5.insertedId, 'David');\n            }\n            var davidId = result5.insertedId;\n            compareResults(test, useUpdate, coll.find().fetch(), [{ foo: 1, _id: davidId }]);\n\n            if (!Meteor.isClient && useDirectCollection) {\n              // test that bad modifier fails\n              // The stub throws an exception about the invalid modifier, which\n              // livedata logs (so we suppress it).\n              Meteor._suppress_log(1);\n              upsert(coll, useUpdate, { _id: 'David' }, { $blah: { foo: 2 } }, function (err) {\n                if (!(Meteor.isClient && useDirectCollection)) test.isTrue(err);\n                upsert(coll, useUpdate, { _id: 'David' }, { $set: { foo: 2 } }, next6);\n              });\n            } else {\n              // XXX skip this test for now for LocalCollection; the fact that\n              // we're in a nested sequence of callbacks means we're inside a\n              // Meteor.defer, which means the exception just gets\n              // logged. Something should be done about this at some point?  Maybe\n              // LocalCollection callbacks don't really have to be deferred.\n              upsert(coll, useUpdate, { _id: 'David' }, { $set: { foo: 2 } }, next6);\n            }\n          };\n\n          var result6;\n          var next6 = function next6(err, result) {\n            result6 = result;\n            test.equal(result6.numberAffected, 1);\n            if (!useUpdate) test.isFalse(result6.insertedId);\n            compareResults(test, useUpdate, coll.find().fetch(), [{ _id: 'David', foo: 2 }]);\n\n            var emilyId = coll.insert({ _id: 'Emily', foo: 2 });\n            compareResults(test, useUpdate, coll.find().fetch(), [{ _id: 'David', foo: 2 }, { _id: 'Emily', foo: 2 }]);\n\n            // multi update by upsert.\n            // We can't actually update multiple documents since we have to do it by\n            // id, but at least make sure the multi flag doesn't mess anything up.\n            upsert(coll, useUpdate, { _id: 'Emily' }, { $set: { bar: 7 },\n              $setOnInsert: { name: 'Fred', foo: 2 } }, { multi: true }, next7);\n          };\n\n          var result7;\n          var next7 = function next7(err, result) {\n            result7 = result;\n            test.equal(result7.numberAffected, 1);\n            if (!useUpdate) test.isFalse(result7.insertedId);\n            compareResults(test, useUpdate, coll.find().fetch(), [{ _id: 'David', foo: 2 }, { _id: 'Emily', foo: 2, bar: 7 }]);\n\n            // insert by multi upsert\n            upsert(coll, useUpdate, { _id: 'Fred' }, { $set: { bar: 7 },\n              $setOnInsert: { name: 'Fred', foo: 2 } }, { multi: true }, next8);\n          };\n\n          var result8;\n          var next8 = function next8(err, result) {\n            result8 = result;\n\n            test.equal(result8.numberAffected, 1);\n            if (!useUpdate) {\n              test.isTrue(result8.insertedId);\n              test.equal(result8.insertedId, 'Fred');\n            }\n            var fredId = result8.insertedId;\n            compareResults(test, useUpdate, coll.find().fetch(), [{ _id: 'David', foo: 2 }, { _id: 'Emily', foo: 2, bar: 7 }, { name: 'Fred', foo: 2, bar: 7, _id: fredId }]);\n            onComplete();\n          };\n        });\n      });\n    });\n  });\n\n  if (Meteor.isClient) {\n    Tinytest.addAsync(\"mongo-livedata - async update/remove return values over network \" + idGeneration, function (test, onComplete) {\n      var coll;\n      var run = test.runId();\n      var collName = \"livedata_upsert_collection_\" + run;\n      Meteor.call(\"createInsecureCollection\", collName, collectionOptions);\n      coll = new Mongo.Collection(collName, collectionOptions);\n      Meteor.subscribe(\"c-\" + collName, function () {\n        coll.insert({ _id: \"foo\" });\n        coll.insert({ _id: \"bar\" });\n        coll.update({ _id: \"foo\" }, { $set: { foo: 1 } }, { multi: true }, function (err, result) {\n          test.isFalse(err);\n          test.equal(result, 1);\n          coll.update({ _id: \"foo\" }, { _id: \"foo\", foo: 2 }, function (err, result) {\n            test.isFalse(err);\n            test.equal(result, 1);\n            coll.update({ _id: \"baz\" }, { $set: { foo: 1 } }, function (err, result) {\n              test.isFalse(err);\n              test.equal(result, 0);\n              coll.remove({ _id: \"foo\" }, function (err, result) {\n                test.equal(result, 1);\n                coll.remove({ _id: \"baz\" }, function (err, result) {\n                  test.equal(result, 0);\n                  onComplete();\n                });\n              });\n            });\n          });\n        });\n      });\n    });\n  }\n\n  // Runs a method and its stub which do some upserts. The method throws an error\n  // if we don't get the right return values.\n  if (Meteor.isClient) {\n    _.each([true, false], function (useUpdate) {\n      Tinytest.addAsync(\"mongo-livedata - \" + (useUpdate ? \"update \" : \"\") + \"upsert in method, \" + idGeneration, function (test, onComplete) {\n        var run = test.runId();\n        upsertTestMethodColl = new Mongo.Collection(upsertTestMethod + \"_collection_\" + run, collectionOptions);\n        var m = {};\n        delete Meteor.connection._methodHandlers[upsertTestMethod];\n        m[upsertTestMethod] = function (run, useUpdate, options) {\n          upsertTestMethodImpl(upsertTestMethodColl, useUpdate, test);\n        };\n        Meteor.methods(m);\n        Meteor.call(upsertTestMethod, run, useUpdate, collectionOptions, function (err, result) {\n          test.isFalse(err);\n          onComplete();\n        });\n      });\n    });\n  }\n\n  _.each(Meteor.isServer ? [true, false] : [true], function (minimongo) {\n    _.each([true, false], function (useUpdate) {\n      Tinytest.add(\"mongo-livedata - \" + (useUpdate ? \"update \" : \"\") + \"upsert by id\" + (minimongo ? \" minimongo\" : \"\") + \", \" + idGeneration, function (test) {\n        var run = test.runId();\n        var options = collectionOptions;\n        if (minimongo) options = _.extend({}, collectionOptions, { connection: null });\n        var coll = new Mongo.Collection(\"livedata_upsert_by_id_collection_\" + run, options);\n\n        var ret;\n        ret = upsert(coll, useUpdate, { _id: 'foo' }, { $set: { x: 1 } });\n        test.equal(ret.numberAffected, 1);\n        if (!useUpdate) test.equal(ret.insertedId, 'foo');\n        compareResults(test, useUpdate, coll.find().fetch(), [{ _id: 'foo', x: 1 }]);\n\n        ret = upsert(coll, useUpdate, { _id: 'foo' }, { $set: { x: 2 } });\n        test.equal(ret.numberAffected, 1);\n        if (!useUpdate) test.isFalse(ret.insertedId);\n        compareResults(test, useUpdate, coll.find().fetch(), [{ _id: 'foo', x: 2 }]);\n\n        ret = upsert(coll, useUpdate, { _id: 'bar' }, { $set: { x: 1 } });\n        test.equal(ret.numberAffected, 1);\n        if (!useUpdate) test.equal(ret.insertedId, 'bar');\n        compareResults(test, useUpdate, coll.find().fetch(), [{ _id: 'foo', x: 2 }, { _id: 'bar', x: 1 }]);\n\n        coll.remove({});\n        ret = upsert(coll, useUpdate, { _id: 'traq' }, { x: 1 });\n\n        test.equal(ret.numberAffected, 1);\n        var myId = ret.insertedId;\n        if (useUpdate) {\n          myId = coll.findOne()._id;\n        }\n        // Starting with Mongo 2.6, upsert with entire document takes _id from the\n        // query, so the above upsert actually does an insert with _id traq\n        // instead of a random _id.  Whenever we are using our simulated upsert,\n        // we have this behavior (whether running against Mongo 2.4 or 2.6).\n        // https://jira.mongodb.org/browse/SERVER-5289\n        test.equal(myId, 'traq');\n        compareResults(test, useUpdate, coll.find().fetch(), [{ x: 1, _id: 'traq' }]);\n\n        // this time, insert as _id 'traz'\n        ret = upsert(coll, useUpdate, { _id: 'traz' }, { _id: 'traz', x: 2 });\n        test.equal(ret.numberAffected, 1);\n        if (!useUpdate) test.equal(ret.insertedId, 'traz');\n        compareResults(test, useUpdate, coll.find().fetch(), [{ x: 1, _id: 'traq' }, { x: 2, _id: 'traz' }]);\n\n        // now update _id 'traz'\n        ret = upsert(coll, useUpdate, { _id: 'traz' }, { x: 3 });\n        test.equal(ret.numberAffected, 1);\n        test.isFalse(ret.insertedId);\n        compareResults(test, useUpdate, coll.find().fetch(), [{ x: 1, _id: 'traq' }, { x: 3, _id: 'traz' }]);\n\n        // now update, passing _id (which is ok as long as it's the same)\n        ret = upsert(coll, useUpdate, { _id: 'traz' }, { _id: 'traz', x: 4 });\n        test.equal(ret.numberAffected, 1);\n        test.isFalse(ret.insertedId);\n        compareResults(test, useUpdate, coll.find().fetch(), [{ x: 1, _id: 'traq' }, { x: 4, _id: 'traz' }]);\n      });\n    });\n  });\n}); // end idGeneration parametrization\n\nTinytest.add('mongo-livedata - rewrite selector', function (test) {\n  test.equal(Mongo.Collection._rewriteSelector({ x: /^o+B/im }), { x: { $regex: '^o+B', $options: 'im' } });\n  test.equal(Mongo.Collection._rewriteSelector({ x: { $regex: /^o+B/im } }), { x: { $regex: '^o+B', $options: 'im' } });\n  test.equal(Mongo.Collection._rewriteSelector({ x: /^o+B/ }), { x: { $regex: '^o+B' } });\n  test.equal(Mongo.Collection._rewriteSelector({ x: { $regex: /^o+B/ } }), { x: { $regex: '^o+B' } });\n  test.equal(Mongo.Collection._rewriteSelector('foo'), { _id: 'foo' });\n\n  test.equal(Mongo.Collection._rewriteSelector({ '$or': [{ x: /^o/ }, { y: /^p/ }, { z: 'q' }, { w: { $regex: /^r/ } }] }), { '$or': [{ x: { $regex: '^o' } }, { y: { $regex: '^p' } }, { z: 'q' }, { w: { $regex: '^r' } }] });\n\n  test.equal(Mongo.Collection._rewriteSelector({ '$or': [{ '$and': [{ x: /^a/i }, { y: /^b/ }, { z: { $regex: /^c/i } }, { w: { $regex: '^[abc]', $options: 'i' } }, // make sure we don't break vanilla selectors\n      { v: { $regex: /O/, $options: 'i' } }, // $options should override the ones on the RegExp object\n      { u: { $regex: /O/m, $options: 'i' } } // $options should override the ones on the RegExp object\n      ] }, { '$nor': [{ s: /^d/ }, { t: /^e/i }, { u: { $regex: /^f/i } },\n      // even empty string overrides built-in flags\n      { v: { $regex: /^g/i, $options: '' } }] }] }), { '$or': [{ '$and': [{ x: { $regex: '^a', $options: 'i' } }, { y: { $regex: '^b' } }, { z: { $regex: '^c', $options: 'i' } }, { w: { $regex: '^[abc]', $options: 'i' } }, { v: { $regex: 'O', $options: 'i' } }, { u: { $regex: 'O', $options: 'i' } }] }, { '$nor': [{ s: { $regex: '^d' } }, { t: { $regex: '^e', $options: 'i' } }, { u: { $regex: '^f', $options: 'i' } }, { v: { $regex: '^g', $options: '' } }] }] });\n\n  var oid = new Mongo.ObjectID();\n  test.equal(Mongo.Collection._rewriteSelector(oid), { _id: oid });\n});\n\ntestAsyncMulti('mongo-livedata - specified _id', [function (test, expect) {\n  this.collectionName = Random.id();\n  if (Meteor.isClient) {\n    Meteor.call('createInsecureCollection', this.collectionName);\n    Meteor.subscribe('c-' + this.collectionName, expect());\n  }\n}, function (test, expect) {\n  var expectError = expect(function (err, result) {\n    test.isTrue(err);\n    var doc = coll.findOne();\n    test.equal(doc.name, \"foo\");\n  });\n  var coll = new Mongo.Collection(this.collectionName);\n  coll.insert({ _id: \"foo\", name: \"foo\" }, expect(function (err1, id) {\n    test.equal(id, \"foo\");\n    var doc = coll.findOne();\n    test.equal(doc._id, \"foo\");\n    Meteor._suppress_log(1);\n    coll.insert({ _id: \"foo\", name: \"bar\" }, expectError);\n  }));\n}]);\n\n// Consistent id generation tests\nfunction collectionInsert(test, expect, coll, index) {\n  var clientSideId = coll.insert({ name: \"foo\" }, expect(function (err1, id) {\n    test.equal(id, clientSideId);\n    var o = coll.findOne(id);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\nfunction collectionUpsert(test, expect, coll, index) {\n  var upsertId = '123456' + index;\n\n  coll.upsert(upsertId, { $set: { name: \"foo\" } }, expect(function (err1, result) {\n    test.equal(result.insertedId, upsertId);\n    test.equal(result.numberAffected, 1);\n\n    var o = coll.findOne(upsertId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\nfunction collectionUpsertExisting(test, expect, coll, index) {\n  var clientSideId = coll.insert({ name: \"foo\" }, expect(function (err1, id) {\n    test.equal(id, clientSideId);\n\n    var o = coll.findOne(id);\n    test.isTrue(_.isObject(o));\n    // We're not testing sequencing/visibility rules here, so skip this check\n    // test.equal(o.name, 'foo');\n  }));\n\n  coll.upsert(clientSideId, { $set: { name: \"bar\" } }, expect(function (err1, result) {\n    test.equal(result.insertedId, clientSideId);\n    test.equal(result.numberAffected, 1);\n\n    var o = coll.findOne(clientSideId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'bar');\n  }));\n};\n\nfunction functionCallsInsert(test, expect, coll, index) {\n  Meteor.call(\"insertObjects\", coll._name, { name: \"foo\" }, 1, expect(function (err1, ids) {\n    test.notEqual((INSERTED_IDS[coll._name] || []).length, 0);\n    var stubId = INSERTED_IDS[coll._name][index];\n\n    test.equal(ids.length, 1);\n    test.equal(ids[0], stubId);\n\n    var o = coll.findOne(stubId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\nfunction functionCallsUpsert(test, expect, coll, index) {\n  var upsertId = '123456' + index;\n  Meteor.call(\"upsertObject\", coll._name, upsertId, { $set: { name: \"foo\" } }, expect(function (err1, result) {\n    test.equal(result.insertedId, upsertId);\n    test.equal(result.numberAffected, 1);\n\n    var o = coll.findOne(upsertId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\nfunction functionCallsUpsertExisting(test, expect, coll, index) {\n  var id = coll.insert({ name: \"foo\" });\n\n  var o = coll.findOne(id);\n  test.notEqual(null, o);\n  test.equal(o.name, 'foo');\n\n  Meteor.call(\"upsertObject\", coll._name, id, { $set: { name: \"bar\" } }, expect(function (err1, result) {\n    test.equal(result.numberAffected, 1);\n    test.equal(result.insertedId, undefined);\n\n    var o = coll.findOne(id);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'bar');\n  }));\n};\n\nfunction functionCalls3Inserts(test, expect, coll, index) {\n  Meteor.call(\"insertObjects\", coll._name, { name: \"foo\" }, 3, expect(function (err1, ids) {\n    test.notEqual((INSERTED_IDS[coll._name] || []).length, 0);\n    test.equal(ids.length, 3);\n\n    for (var i = 0; i < 3; i++) {\n      var stubId = INSERTED_IDS[coll._name][3 * index + i];\n      test.equal(ids[i], stubId);\n\n      var o = coll.findOne(stubId);\n      test.isTrue(_.isObject(o));\n      test.equal(o.name, 'foo');\n    }\n  }));\n};\n\nfunction functionChainInsert(test, expect, coll, index) {\n  Meteor.call(\"doMeteorCall\", \"insertObjects\", coll._name, { name: \"foo\" }, 1, expect(function (err1, ids) {\n    test.notEqual((INSERTED_IDS[coll._name] || []).length, 0);\n    var stubId = INSERTED_IDS[coll._name][index];\n\n    test.equal(ids.length, 1);\n    test.equal(ids[0], stubId);\n\n    var o = coll.findOne(stubId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\nfunction functionChain2Insert(test, expect, coll, index) {\n  Meteor.call(\"doMeteorCall\", \"doMeteorCall\", \"insertObjects\", coll._name, { name: \"foo\" }, 1, expect(function (err1, ids) {\n    test.notEqual((INSERTED_IDS[coll._name] || []).length, 0);\n    var stubId = INSERTED_IDS[coll._name][index];\n\n    test.equal(ids.length, 1);\n    test.equal(ids[0], stubId);\n\n    var o = coll.findOne(stubId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\nfunction functionChain2Upsert(test, expect, coll, index) {\n  var upsertId = '123456' + index;\n  Meteor.call(\"doMeteorCall\", \"doMeteorCall\", \"upsertObject\", coll._name, upsertId, { $set: { name: \"foo\" } }, expect(function (err1, result) {\n    test.equal(result.insertedId, upsertId);\n    test.equal(result.numberAffected, 1);\n\n    var o = coll.findOne(upsertId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\n_.each({ collectionInsert: collectionInsert,\n  collectionUpsert: collectionUpsert,\n  functionCallsInsert: functionCallsInsert,\n  functionCallsUpsert: functionCallsUpsert,\n  functionCallsUpsertExisting: functionCallsUpsertExisting,\n  functionCalls3Insert: functionCalls3Inserts,\n  functionChainInsert: functionChainInsert,\n  functionChain2Insert: functionChain2Insert,\n  functionChain2Upsert: functionChain2Upsert }, function (fn, name) {\n  _.each([1, 3], function (repetitions) {\n    _.each([1, 3], function (collectionCount) {\n      _.each(['STRING', 'MONGO'], function (idGeneration) {\n\n        testAsyncMulti('mongo-livedata - consistent _id generation ' + name + ', ' + repetitions + ' repetitions on ' + collectionCount + ' collections, idGeneration=' + idGeneration, [function (test, expect) {\n          var collectionOptions = { idGeneration: idGeneration };\n\n          var cleanups = this.cleanups = [];\n          this.collections = _.times(collectionCount, function () {\n            var collectionName = \"consistentid_\" + Random.id();\n            if (Meteor.isClient) {\n              Meteor.call('createInsecureCollection', collectionName, collectionOptions);\n              Meteor.subscribe('c-' + collectionName, expect());\n              cleanups.push(function (expect) {\n                Meteor.call('dropInsecureCollection', collectionName, expect(function () {}));\n              });\n            }\n\n            var collection = new Mongo.Collection(collectionName, collectionOptions);\n            if (Meteor.isServer) {\n              cleanups.push(function () {\n                collection._dropCollection();\n              });\n            }\n            COLLECTIONS[collectionName] = collection;\n            return collection;\n          });\n        }, function (test, expect) {\n          // now run the actual test\n          for (var i = 0; i < repetitions; i++) {\n            for (var j = 0; j < collectionCount; j++) {\n              fn(test, expect, this.collections[j], i);\n            }\n          }\n        }, function (test, expect) {\n          // Run any registered cleanup functions (e.g. to drop collections)\n          _.each(this.cleanups, function (cleanup) {\n            cleanup(expect);\n          });\n        }]);\n      });\n    });\n  });\n});\n\ntestAsyncMulti('mongo-livedata - empty string _id', [function (test, expect) {\n  var self = this;\n  self.collectionName = Random.id();\n  if (Meteor.isClient) {\n    Meteor.call('createInsecureCollection', self.collectionName);\n    Meteor.subscribe('c-' + self.collectionName, expect());\n  }\n  self.coll = new Mongo.Collection(self.collectionName);\n  try {\n    self.coll.insert({ _id: \"\", f: \"foo\" });\n    test.fail(\"Insert with an empty _id should fail\");\n  } catch (e) {\n    // ok\n  }\n  self.coll.insert({ _id: \"realid\", f: \"bar\" }, expect(function (err, res) {\n    test.equal(res, \"realid\");\n  }));\n}, function (test, expect) {\n  var self = this;\n  var docs = self.coll.find().fetch();\n  test.equal(docs, [{ _id: \"realid\", f: \"bar\" }]);\n}, function (test, expect) {\n  var self = this;\n  if (Meteor.isServer) {\n    self.coll._collection.insert({ _id: \"\", f: \"baz\" });\n    test.equal(self.coll.find().fetch().length, 2);\n  }\n}]);\n\nif (Meteor.isServer) {\n\n  testAsyncMulti(\"mongo-livedata - minimongo on server to server connection\", [function (test, expect) {\n    var self = this;\n    Meteor._debug(\"connection setup\");\n    self.id = Random.id();\n    var C = self.C = new Mongo.Collection(\"ServerMinimongo_\" + self.id);\n    C.allow({\n      insert: function () {\n        function insert() {\n          return true;\n        }\n\n        return insert;\n      }(),\n      update: function () {\n        function update() {\n          return true;\n        }\n\n        return update;\n      }(),\n      remove: function () {\n        function remove() {\n          return true;\n        }\n\n        return remove;\n      }()\n    });\n    C.insert({ a: 0, b: 1 });\n    C.insert({ a: 0, b: 2 });\n    C.insert({ a: 1, b: 3 });\n    Meteor.publish(self.id, function () {\n      return C.find({ a: 0 });\n    });\n\n    self.conn = DDP.connect(Meteor.absoluteUrl());\n    pollUntil(expect, function () {\n      return self.conn.status().connected;\n    }, 10000);\n  }, function (test, expect) {\n    var self = this;\n    if (self.conn.status().connected) {\n      self.miniC = new Mongo.Collection(\"ServerMinimongo_\" + self.id, {\n        connection: self.conn\n      });\n      var exp = expect(function (err) {\n        test.isFalse(err);\n      });\n      self.conn.subscribe(self.id, {\n        onError: exp,\n        onReady: exp\n      });\n    }\n  }, function (test, expect) {\n    var self = this;\n    if (self.miniC) {\n      var contents = self.miniC.find().fetch();\n      test.equal(contents.length, 2);\n      test.equal(contents[0].a, 0);\n    }\n  }, function (test, expect) {\n    var self = this;\n    if (!self.miniC) return;\n    self.miniC.insert({ a: 0, b: 3 });\n    var contents = self.miniC.find({ b: 3 }).fetch();\n    test.equal(contents.length, 1);\n    test.equal(contents[0].a, 0);\n  }]);\n\n  testAsyncMulti(\"mongo-livedata - minimongo observe on server\", [function (test, expect) {\n    var self = this;\n    self.id = Random.id();\n    self.C = new Mongo.Collection(\"ServerMinimongoObserve_\" + self.id);\n    self.events = [];\n\n    Meteor.publish(self.id, function () {\n      return self.C.find();\n    });\n\n    self.conn = DDP.connect(Meteor.absoluteUrl());\n    pollUntil(expect, function () {\n      return self.conn.status().connected;\n    }, 10000);\n  }, function (test, expect) {\n    var self = this;\n    if (self.conn.status().connected) {\n      self.miniC = new Mongo.Collection(\"ServerMinimongoObserve_\" + self.id, {\n        connection: self.conn\n      });\n      var exp = expect(function (err) {\n        test.isFalse(err);\n      });\n      self.conn.subscribe(self.id, {\n        onError: exp,\n        onReady: exp\n      });\n    }\n  }, function (test, expect) {\n    var self = this;\n    if (self.miniC) {\n      self.obs = self.miniC.find().observeChanges({\n        added: function () {\n          function added(id, fields) {\n            self.events.push({ evt: \"a\", id: id });\n            Meteor._sleepForMs(200);\n            self.events.push({ evt: \"b\", id: id });\n          }\n\n          return added;\n        }()\n      });\n      self.one = self.C.insert({});\n      self.two = self.C.insert({});\n      pollUntil(expect, function () {\n        return self.events.length === 4;\n      }, 10000);\n    }\n  }, function (test, expect) {\n    var self = this;\n    if (self.miniC) {\n      test.equal(self.events, [{ evt: \"a\", id: self.one }, { evt: \"b\", id: self.one }, { evt: \"a\", id: self.two }, { evt: \"b\", id: self.two }]);\n    }\n    self.obs && self.obs.stop();\n  }]);\n}\n\nTinytest.addAsync(\"mongo-livedata - local collections with different connections\", function (test, onComplete) {\n  var cname = Random.id();\n  var cname2 = Random.id();\n  var coll1 = new Mongo.Collection(cname);\n  var doc = { foo: \"bar\" };\n  var coll2 = new Mongo.Collection(cname2, { connection: null });\n  coll2.insert(doc, function (err, id) {\n    test.equal(coll1.find(doc).count(), 0);\n    test.equal(coll2.find(doc).count(), 1);\n    onComplete();\n  });\n});\n\nTinytest.addAsync(\"mongo-livedata - local collection with null connection, w/ callback\", function (test, onComplete) {\n  var cname = Random.id();\n  var coll1 = new Mongo.Collection(cname, { connection: null });\n  var doc = { foo: \"bar\" };\n  var docId = coll1.insert(doc, function (err, id) {\n    test.equal(docId, id);\n    test.equal(coll1.findOne(doc)._id, id);\n    onComplete();\n  });\n});\n\nTinytest.addAsync(\"mongo-livedata - local collection with null connection, w/o callback\", function (test, onComplete) {\n  var cname = Random.id();\n  var coll1 = new Mongo.Collection(cname, { connection: null });\n  var doc = { foo: \"bar\" };\n  var docId = coll1.insert(doc);\n  test.equal(coll1.findOne(doc)._id, docId);\n  onComplete();\n});\n\ntestAsyncMulti(\"mongo-livedata - update handles $push with $each correctly\", [function (test, expect) {\n  var self = this;\n  var collectionName = Random.id();\n  if (Meteor.isClient) {\n    Meteor.call('createInsecureCollection', collectionName);\n    Meteor.subscribe('c-' + collectionName, expect());\n  }\n\n  self.collection = new Mongo.Collection(collectionName);\n\n  self.id = self.collection.insert({ name: 'jens', elements: ['X', 'Y'] }, expect(function (err, res) {\n    test.isFalse(err);\n    test.equal(self.id, res);\n  }));\n}, function (test, expect) {\n  var self = this;\n  self.collection.update(self.id, {\n    $push: {\n      elements: {\n        $each: ['A', 'B', 'C'],\n        $slice: -4\n      } } }, expect(function (err, res) {\n    test.isFalse(err);\n    test.equal(self.collection.findOne(self.id), { _id: self.id, name: 'jens', elements: ['Y', 'A', 'B', 'C'] });\n  }));\n}]);\n\nif (Meteor.isServer) {\n  Tinytest.add(\"mongo-livedata - upsert handles $push with $each correctly\", function (test) {\n    var collection = new Mongo.Collection(Random.id());\n\n    var result = collection.upsert({ name: 'jens' }, { $push: {\n        elements: {\n          $each: ['A', 'B', 'C'],\n          $slice: -4\n        } } });\n\n    test.equal(collection.findOne(result.insertedId), { _id: result.insertedId,\n      name: 'jens',\n      elements: ['A', 'B', 'C'] });\n\n    var id = collection.insert({ name: \"david\", elements: ['X', 'Y'] });\n    result = collection.upsert({ name: 'david' }, { $push: {\n        elements: {\n          $each: ['A', 'B', 'C'],\n          $slice: -4\n        } } });\n\n    test.equal(collection.findOne(id), { _id: id,\n      name: 'david',\n      elements: ['Y', 'A', 'B', 'C'] });\n  });\n\n  Tinytest.add(\"mongo-livedata - upsert handles dotted selectors corrrectly\", function (test) {\n    var collection = new Mongo.Collection(Random.id());\n\n    var result1 = collection.upsert({\n      \"subdocument.a\": 1\n    }, {\n      $set: { message: \"upsert 1\" }\n    });\n\n    test.equal(collection.findOne(result1.insertedId), {\n      _id: result1.insertedId,\n      subdocument: { a: 1 },\n      message: \"upsert 1\"\n    });\n\n    var result2 = collection.upsert({\n      \"subdocument.a\": 1\n    }, {\n      $set: { message: \"upsert 2\" }\n    });\n\n    test.equal(result2, { numberAffected: 1 });\n\n    test.equal(collection.findOne(result1.insertedId), {\n      _id: result1.insertedId,\n      subdocument: { a: 1 },\n      message: \"upsert 2\"\n    });\n\n    var result3 = collection.upsert({\n      \"subdocument.a.b\": 1,\n      \"subdocument.c\": 2\n    }, {\n      $set: { message: \"upsert3\" }\n    });\n\n    test.equal(collection.findOne(result3.insertedId), {\n      _id: result3.insertedId,\n      subdocument: { a: { b: 1 }, c: 2 },\n      message: \"upsert3\"\n    });\n\n    var result4 = collection.upsert({\n      \"subdocument.a\": 4\n    }, {\n      $set: { \"subdocument.a\": \"upsert 4\" }\n    });\n\n    test.equal(collection.findOne(result4.insertedId), {\n      _id: result4.insertedId,\n      subdocument: { a: \"upsert 4\" }\n    });\n\n    var result5 = collection.upsert({\n      \"subdocument.a\": \"upsert 4\"\n    }, {\n      $set: { \"subdocument.a\": \"upsert 5\" }\n    });\n\n    test.equal(result5, { numberAffected: 1 });\n\n    test.equal(collection.findOne(result4.insertedId), {\n      _id: result4.insertedId,\n      subdocument: { a: \"upsert 5\" }\n    });\n\n    var result6 = collection.upsert({\n      \"subdocument.a\": \"upsert 5\"\n    }, {\n      $set: { \"subdocument\": \"upsert 6\" }\n    });\n\n    test.equal(result6, { numberAffected: 1 });\n\n    test.equal(collection.findOne(result4.insertedId), {\n      _id: result4.insertedId,\n      subdocument: \"upsert 6\"\n    });\n\n    var result7 = collection.upsert({\n      \"subdocument.a.b\": 7\n    }, {\n      $set: {\n        \"subdocument.a.c\": \"upsert7\"\n      }\n    });\n\n    test.equal(collection.findOne(result7.insertedId), {\n      _id: result7.insertedId,\n      subdocument: {\n        a: { b: 7, c: \"upsert7\" }\n      }\n    });\n\n    var result8 = collection.upsert({\n      \"subdocument.a.b\": 7\n    }, {\n      $set: {\n        \"subdocument.a.c\": \"upsert8\"\n      }\n    });\n\n    test.equal(result8, { numberAffected: 1 });\n\n    test.equal(collection.findOne(result7.insertedId), {\n      _id: result7.insertedId,\n      subdocument: {\n        a: { b: 7, c: \"upsert8\" }\n      }\n    });\n\n    var result9 = collection.upsert({\n      \"subdocument.a.b\": 7\n    }, {\n      $set: {\n        \"subdocument.a.b\": \"upsert9\"\n      }\n    });\n\n    test.equal(result9, { numberAffected: 1 });\n\n    test.equal(collection.findOne(result7.insertedId), {\n      _id: result7.insertedId,\n      subdocument: {\n        a: { b: \"upsert9\", c: \"upsert8\" }\n      }\n    });\n  });\n}\n\n// This is a VERY white-box test.\nMeteor.isServer && Tinytest.add(\"mongo-livedata - oplog - _disableOplog\", function (test) {\n  var collName = Random.id();\n  var coll = new Mongo.Collection(collName);\n  if (MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle) {\n    var observeWithOplog = coll.find({ x: 5 }).observeChanges({ added: function () {\n        function added() {}\n\n        return added;\n      }() });\n    test.isTrue(observeWithOplog._multiplexer._observeDriver._usesOplog);\n    observeWithOplog.stop();\n  }\n  var observeWithoutOplog = coll.find({ x: 6 }, { _disableOplog: true }).observeChanges({ added: function () {\n      function added() {}\n\n      return added;\n    }() });\n  test.isFalse(observeWithoutOplog._multiplexer._observeDriver._usesOplog);\n  observeWithoutOplog.stop();\n});\n\nMeteor.isServer && Tinytest.add(\"mongo-livedata - oplog - include selector fields\", function (test) {\n  var collName = \"includeSelector\" + Random.id();\n  var coll = new Mongo.Collection(collName);\n\n  var docId = coll.insert({ a: 1, b: [3, 2], c: 'foo' });\n  test.isTrue(docId);\n\n  // Wait until we've processed the insert oplog entry. (If the insert shows up\n  // during the observeChanges, the bug in question is not consistently\n  // reproduced.) We don't have to do this for polling observe (eg\n  // --disable-oplog).\n  waitUntilOplogCaughtUp();\n\n  var output = [];\n  var handle = coll.find({ a: 1, b: 2 }, { fields: { c: 1 } }).observeChanges({\n    added: function () {\n      function added(id, fields) {\n        output.push(['added', id, fields]);\n      }\n\n      return added;\n    }(),\n    changed: function () {\n      function changed(id, fields) {\n        output.push(['changed', id, fields]);\n      }\n\n      return changed;\n    }(),\n    removed: function () {\n      function removed(id) {\n        output.push(['removed', id]);\n      }\n\n      return removed;\n    }()\n  });\n  // Initially should match the document.\n  test.length(output, 1);\n  test.equal(output.shift(), ['added', docId, { c: 'foo' }]);\n\n  // Update in such a way that, if we only knew about the published field 'c'\n  // and the changed field 'b' (but not the field 'a'), we would think it didn't\n  // match any more.  (This is a regression test for a bug that existed because\n  // we used to not use the shared projection in the initial query.)\n  runInFence(function () {\n    coll.update(docId, { $set: { 'b.0': 2, c: 'bar' } });\n  });\n  test.length(output, 1);\n  test.equal(output.shift(), ['changed', docId, { c: 'bar' }]);\n\n  handle.stop();\n});\n\nMeteor.isServer && Tinytest.add(\"mongo-livedata - oplog - transform\", function (test) {\n  var collName = \"oplogTransform\" + Random.id();\n  var coll = new Mongo.Collection(collName);\n\n  var docId = coll.insert({ a: 25, x: { x: 5, y: 9 } });\n  test.isTrue(docId);\n\n  // Wait until we've processed the insert oplog entry. (If the insert shows up\n  // during the observeChanges, the bug in question is not consistently\n  // reproduced.) We don't have to do this for polling observe (eg\n  // --disable-oplog).\n  waitUntilOplogCaughtUp();\n\n  var cursor = coll.find({}, { transform: function () {\n      function transform(doc) {\n        return doc.x;\n      }\n\n      return transform;\n    }() });\n\n  var changesOutput = [];\n  var changesHandle = cursor.observeChanges({\n    added: function () {\n      function added(id, fields) {\n        changesOutput.push(['added', fields]);\n      }\n\n      return added;\n    }()\n  });\n  // We should get untransformed fields via observeChanges.\n  test.length(changesOutput, 1);\n  test.equal(changesOutput.shift(), ['added', { a: 25, x: { x: 5, y: 9 } }]);\n  changesHandle.stop();\n\n  var transformedOutput = [];\n  var transformedHandle = cursor.observe({\n    added: function () {\n      function added(doc) {\n        transformedOutput.push(['added', doc]);\n      }\n\n      return added;\n    }()\n  });\n  test.length(transformedOutput, 1);\n  test.equal(transformedOutput.shift(), ['added', { x: 5, y: 9 }]);\n  transformedHandle.stop();\n});\n\nMeteor.isServer && Tinytest.add(\"mongo-livedata - oplog - drop collection/db\", function (test) {\n  // This test uses a random database, so it can be dropped without affecting\n  // anything else.\n  var mongodbUri = Npm.require('mongodb-uri');\n  var parsedUri = mongodbUri.parse(process.env.MONGO_URL);\n  parsedUri.database = 'dropDB' + Random.id();\n  var driver = new MongoInternals.RemoteCollectionDriver(mongodbUri.format(parsedUri), {\n    oplogUrl: process.env.MONGO_OPLOG_URL\n  });\n\n  var collName = \"dropCollection\" + Random.id();\n  var coll = new Mongo.Collection(collName, { _driver: driver });\n\n  var doc1Id = coll.insert({ a: 'foo', c: 1 });\n  var doc2Id = coll.insert({ b: 'bar' });\n  var doc3Id = coll.insert({ a: 'foo', c: 2 });\n  var tmp;\n\n  var output = [];\n  var handle = coll.find({ a: 'foo' }).observeChanges({\n    added: function () {\n      function added(id, fields) {\n        output.push(['added', id, fields]);\n      }\n\n      return added;\n    }(),\n    changed: function () {\n      function changed(id) {\n        output.push(['changed']);\n      }\n\n      return changed;\n    }(),\n    removed: function () {\n      function removed(id) {\n        output.push(['removed', id]);\n      }\n\n      return removed;\n    }()\n  });\n  test.length(output, 2);\n  // make order consistent\n  if (output.length === 2 && output[0][1] === doc3Id) {\n    tmp = output[0];\n    output[0] = output[1];\n    output[1] = tmp;\n  }\n  test.equal(output.shift(), ['added', doc1Id, { a: 'foo', c: 1 }]);\n  test.equal(output.shift(), ['added', doc3Id, { a: 'foo', c: 2 }]);\n\n  // Wait until we've processed the insert oplog entry, so that we are in a\n  // steady state (and we don't see the dropped docs because we are FETCHING).\n  waitUntilOplogCaughtUp();\n\n  // Drop the collection. Should remove all docs.\n  runInFence(function () {\n    coll._dropCollection();\n  });\n\n  test.length(output, 2);\n  // make order consistent\n  if (output.length === 2 && output[0][1] === doc3Id) {\n    tmp = output[0];\n    output[0] = output[1];\n    output[1] = tmp;\n  }\n  test.equal(output.shift(), ['removed', doc1Id]);\n  test.equal(output.shift(), ['removed', doc3Id]);\n\n  // Put something back in.\n  var doc4Id;\n  runInFence(function () {\n    doc4Id = coll.insert({ a: 'foo', c: 3 });\n  });\n\n  test.length(output, 1);\n  test.equal(output.shift(), ['added', doc4Id, { a: 'foo', c: 3 }]);\n\n  // Now drop the database. Should remove all docs again.\n  runInFence(function () {\n    driver.mongo.dropDatabase();\n  });\n\n  test.length(output, 1);\n  test.equal(output.shift(), ['removed', doc4Id]);\n\n  handle.stop();\n  driver.mongo.close();\n});\n\nvar TestCustomType = function TestCustomType(head, tail) {\n  // use different field names on the object than in JSON, to ensure we are\n  // actually treating this as an opaque object.\n  this.myHead = head;\n  this.myTail = tail;\n};\n_.extend(TestCustomType.prototype, {\n  clone: function () {\n    function clone() {\n      return new TestCustomType(this.myHead, this.myTail);\n    }\n\n    return clone;\n  }(),\n  equals: function () {\n    function equals(other) {\n      return other instanceof TestCustomType && EJSON.equals(this.myHead, other.myHead) && EJSON.equals(this.myTail, other.myTail);\n    }\n\n    return equals;\n  }(),\n  typeName: function () {\n    function typeName() {\n      return 'someCustomType';\n    }\n\n    return typeName;\n  }(),\n  toJSONValue: function () {\n    function toJSONValue() {\n      return { head: this.myHead, tail: this.myTail };\n    }\n\n    return toJSONValue;\n  }()\n});\n\nEJSON.addType('someCustomType', function (json) {\n  return new TestCustomType(json.head, json.tail);\n});\n\ntestAsyncMulti(\"mongo-livedata - oplog - update EJSON\", [function (test, expect) {\n  var self = this;\n  var collectionName = \"ejson\" + Random.id();\n  if (Meteor.isClient) {\n    Meteor.call('createInsecureCollection', collectionName);\n    Meteor.subscribe('c-' + collectionName, expect());\n  }\n\n  self.collection = new Mongo.Collection(collectionName);\n  self.date = new Date();\n  self.objId = new Mongo.ObjectID();\n\n  self.id = self.collection.insert({ d: self.date, oi: self.objId,\n    custom: new TestCustomType('a', 'b') }, expect(function (err, res) {\n    test.isFalse(err);\n    test.equal(self.id, res);\n  }));\n}, function (test, expect) {\n  var self = this;\n  self.changes = [];\n  self.handle = self.collection.find({}).observeChanges({\n    added: function () {\n      function added(id, fields) {\n        self.changes.push(['a', id, fields]);\n      }\n\n      return added;\n    }(),\n    changed: function () {\n      function changed(id, fields) {\n        self.changes.push(['c', id, fields]);\n      }\n\n      return changed;\n    }(),\n    removed: function () {\n      function removed(id) {\n        self.changes.push(['r', id]);\n      }\n\n      return removed;\n    }()\n  });\n  test.length(self.changes, 1);\n  test.equal(self.changes.shift(), ['a', self.id, { d: self.date, oi: self.objId,\n    custom: new TestCustomType('a', 'b') }]);\n\n  // First, replace the entire custom object.\n  // (runInFence is useful for the server, using expect() is useful for the\n  // client)\n  runInFence(function () {\n    self.collection.update(self.id, { $set: { custom: new TestCustomType('a', 'c') } }, expect(function (err) {\n      test.isFalse(err);\n    }));\n  });\n}, function (test, expect) {\n  var self = this;\n  test.length(self.changes, 1);\n  test.equal(self.changes.shift(), ['c', self.id, { custom: new TestCustomType('a', 'c') }]);\n\n  // Now, sneakily replace just a piece of it. Meteor won't do this, but\n  // perhaps you are accessing Mongo directly.\n  runInFence(function () {\n    self.collection.update(self.id, { $set: { 'custom.EJSON$value.EJSONtail': 'd' } }, expect(function (err) {\n      test.isFalse(err);\n    }));\n  });\n}, function (test, expect) {\n  var self = this;\n  test.length(self.changes, 1);\n  test.equal(self.changes.shift(), ['c', self.id, { custom: new TestCustomType('a', 'd') }]);\n\n  // Update a date and an ObjectID too.\n  self.date2 = new Date(self.date.valueOf() + 1000);\n  self.objId2 = new Mongo.ObjectID();\n  runInFence(function () {\n    self.collection.update(self.id, { $set: { d: self.date2, oi: self.objId2 } }, expect(function (err) {\n      test.isFalse(err);\n    }));\n  });\n}, function (test, expect) {\n  var self = this;\n  test.length(self.changes, 1);\n  test.equal(self.changes.shift(), ['c', self.id, { d: self.date2, oi: self.objId2 }]);\n\n  self.handle.stop();\n}]);\n\nvar waitUntilOplogCaughtUp = function waitUntilOplogCaughtUp() {\n  var oplogHandle = MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle;\n  if (oplogHandle) oplogHandle.waitUntilCaughtUp();\n};\n\nMeteor.isServer && Tinytest.add(\"mongo-livedata - cursor dedup stop\", function (test) {\n  var coll = new Mongo.Collection(Random.id());\n  _.times(100, function () {\n    coll.insert({ foo: 'baz' });\n  });\n  var handler = coll.find({}).observeChanges({\n    added: function () {\n      function added(id) {\n        coll.update(id, { $set: { foo: 'bar' } });\n      }\n\n      return added;\n    }()\n  });\n  handler.stop();\n  // Previously, this would print\n  //    Exception in queued task: TypeError: Object.keys called on non-object\n  // Unfortunately, this test didn't fail before the bugfix, but it at least\n  // would print the error and no longer does.\n  // See https://github.com/meteor/meteor/issues/2070\n});\n\ntestAsyncMulti(\"mongo-livedata - undefined find options\", [function (test, expect) {\n  var self = this;\n  self.collName = Random.id();\n  if (Meteor.isClient) {\n    Meteor.call(\"createInsecureCollection\", self.collName);\n    Meteor.subscribe(\"c-\" + self.collName, expect());\n  }\n}, function (test, expect) {\n  var self = this;\n  self.coll = new Mongo.Collection(self.collName);\n  self.doc = { foo: 1, bar: 2, _id: \"foobar\" };\n  self.coll.insert(self.doc, expect(function (err, id) {\n    test.isFalse(err);\n  }));\n}, function (test, expect) {\n  var self = this;\n  var result = self.coll.findOne({ foo: 1 }, {\n    fields: undefined,\n    sort: undefined,\n    limit: undefined,\n    skip: undefined\n  });\n  test.equal(result, self.doc);\n}]);\n\n// Regression test for #2274.\nMeteor.isServer && testAsyncMulti(\"mongo-livedata - observe limit bug\", [function (test, expect) {\n  var self = this;\n  self.coll = new Mongo.Collection(Random.id());\n  var state = {};\n  var callbacks = {\n    changed: function () {\n      function changed(newDoc) {\n        state[newDoc._id] = newDoc;\n      }\n\n      return changed;\n    }(),\n    added: function () {\n      function added(newDoc) {\n        state[newDoc._id] = newDoc;\n      }\n\n      return added;\n    }(),\n    removed: function () {\n      function removed(oldDoc) {\n        delete state[oldDoc._id];\n      }\n\n      return removed;\n    }()\n  };\n  self.observe = self.coll.find({}, { limit: 1, sort: { sortField: -1 } }).observe(callbacks);\n\n  // Insert some documents.\n  runInFence(function () {\n    self.id0 = self.coll.insert({ sortField: 0, toDelete: true });\n    self.id1 = self.coll.insert({ sortField: 1, toDelete: true });\n    self.id2 = self.coll.insert({ sortField: 2, toDelete: true });\n  });\n  test.equal(_.keys(state), [self.id2]);\n\n  // Mutate the one in the unpublished buffer and the one below the\n  // buffer. Before the fix for #2274, this left the observe state machine in\n  // a broken state where the buffer was empty but it wasn't try to re-fill\n  // it.\n  runInFence(function () {\n    self.coll.update({ _id: { $ne: self.id2 } }, { $set: { toDelete: false } }, { multi: 1 });\n  });\n  test.equal(_.keys(state), [self.id2]);\n\n  // Now remove the one published document. This should slide up id1 from the\n  // buffer, but this didn't work before the #2274 fix.\n  runInFence(function () {\n    self.coll.remove({ toDelete: true });\n  });\n  test.equal(_.keys(state), [self.id1]);\n}]);\n\nMeteor.isServer && testAsyncMulti(\"mongo-livedata - update with replace forbidden\", [function (test, expect) {\n  var c = new Mongo.Collection(Random.id());\n\n  var id = c.insert({ foo: \"bar\" });\n\n  c.update(id, { foo2: \"bar2\" });\n  test.equal(c.findOne(id), { _id: id, foo2: \"bar2\" });\n\n  test.throws(function () {\n    c.update(id, { foo3: \"bar3\" }, { _forbidReplace: true });\n  }, \"Replacements are forbidden\");\n  test.equal(c.findOne(id), { _id: id, foo2: \"bar2\" });\n\n  test.throws(function () {\n    c.update(id, { foo3: \"bar3\", $set: { blah: 1 } });\n  }, \"cannot have both modifier and non-modifier fields\");\n  test.equal(c.findOne(id), { _id: id, foo2: \"bar2\" });\n}]);\n\nMeteor.isServer && Tinytest.add(\"mongo-livedata - connection failure throws\", function (test) {\n  test.throws(function () {\n    new MongoInternals.Connection('mongodb://this-does-not-exist.test/asdf');\n  });\n});\n\nMeteor.isServer && Tinytest.add(\"mongo-livedata - npm modules\", function (test) {\n  // Make sure the version number looks like a version number.\n  test.matches(MongoInternals.NpmModules.mongodb.version, /^1\\.(\\d+)\\.(\\d+)/);\n  test.equal((0, _typeof3[\"default\"])(MongoInternals.NpmModules.mongodb.module), 'function');\n  test.equal((0, _typeof3[\"default\"])(MongoInternals.NpmModules.mongodb.module.connect), 'function');\n  test.equal((0, _typeof3[\"default\"])(MongoInternals.NpmModules.mongodb.module.ObjectID), 'function');\n\n  var c = new Mongo.Collection(Random.id());\n  var rawCollection = c.rawCollection();\n  test.isTrue(rawCollection);\n  test.isTrue(rawCollection.findAndModify);\n  var rawDb = c.rawDatabase();\n  test.isTrue(rawDb);\n  test.isTrue(rawDb.admin);\n});\n\nif (Meteor.isServer) {\n  Tinytest.add(\"mongo-livedata - update/remove don't accept an array as a selector #4804\", function (test) {\n    var collection = new Mongo.Collection(Random.id());\n\n    _.times(10, function () {\n      collection.insert({ data: \"Hello\" });\n    });\n\n    test.equal(collection.find().count(), 10);\n\n    // Test several array-related selectors\n    _.each([[], [1, 2, 3], [{}]], function (selector) {\n      test.throws(function () {\n        collection.remove(selector);\n      });\n\n      test.throws(function () {\n        collection.update(selector, { $set: 5 });\n      });\n    });\n\n    test.equal(collection.find().count(), 10);\n  });\n}\n\n// This is a regression test for https://github.com/meteor/meteor/issues/4839.\n// Prior to fixing the issue (but after applying\n// https://github.com/meteor/meteor/pull/4694), doing a Mongo write from a\n// timeout that ran after a method body (invoked via the client) would throw an\n// error \"fence has already activated -- too late to add a callback\" and not\n// properly call the Mongo write's callback.  In this test:\n//  - The client invokes a method (fenceOnBeforeFireError1) which\n//    - Starts an observe on a query\n//    - Creates a timeout (which shares a write fence with the method)\n//    - Lets the method return (firing the write fence)\n//  - The timeout runs and does a Mongo write. This write is inside a write\n//    fence (because timeouts preserve the fence, see dcd26415) but the write\n//    fence already fired.\n//  - The Mongo write's callback confirms that there is no error. This was\n//    not the case before fixing the bug!  (Note that the observe was necessary\n//    for the error to occur, because the error was thrown from the observe's\n//    crossbar listener callback).  It puts the confirmation into a Future.\n//  - The client invokes another method which reads the confirmation from\n//    the future. (Well, the invocation happened earlier but the use of the\n//    Future sequences it so that the confirmation only gets read at this point.)\nif (Meteor.isClient) {\n  testAsyncMulti(\"mongo-livedata - fence onBeforeFire error\", [function (test, expect) {\n    var self = this;\n    self.nonce = Random.id();\n    Meteor.call('fenceOnBeforeFireError1', self.nonce, expect(function (err) {\n      test.isFalse(err);\n    }));\n  }, function (test, expect) {\n    var self = this;\n    Meteor.call('fenceOnBeforeFireError2', self.nonce, expect(function (err, success) {\n      test.isFalse(err);\n      test.isTrue(success);\n    }));\n  }]);\n} else {\n  var fenceOnBeforeFireErrorCollection = new Mongo.Collection(\"FOBFE\");\n  var Future = Npm.require('fibers/future');\n  var futuresByNonce = {};\n  Meteor.methods({\n    fenceOnBeforeFireError1: function () {\n      function fenceOnBeforeFireError1(nonce) {\n        futuresByNonce[nonce] = new Future();\n        var observe = fenceOnBeforeFireErrorCollection.find({ nonce: nonce }).observeChanges({ added: function () {\n            function added() {}\n\n            return added;\n          }() });\n        Meteor.setTimeout(function () {\n          fenceOnBeforeFireErrorCollection.insert({ nonce: nonce }, function (err, result) {\n            var success = !err && result;\n            futuresByNonce[nonce][\"return\"](success);\n            observe.stop();\n          });\n        }, 10);\n      }\n\n      return fenceOnBeforeFireError1;\n    }(),\n    fenceOnBeforeFireError2: function () {\n      function fenceOnBeforeFireError2(nonce) {\n        try {\n          return futuresByNonce[nonce].wait();\n        } finally {\n          delete futuresByNonce[nonce];\n        }\n      }\n\n      return fenceOnBeforeFireError2;\n    }()\n  });\n}","ast":null,"map":{"version":3,"sources":["/packages/mongo/mongo_livedata_tests.js"],"names":[],"mappings":"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","file":"/packages/mongo/mongo_livedata_tests.js.map","sourcesContent":["// This is a magic collection that fails its writes on the server when\n// the selector (or inserted document) contains fail: true.\n\nvar TRANSFORMS = {};\n\n// We keep track of the collections, so we can refer to them by name\nvar COLLECTIONS = {};\n\nif (Meteor.isServer) {\n  Meteor.methods({\n    createInsecureCollection: function (name, options) {\n      check(name, String);\n      check(options, Match.Optional({\n        transformName: Match.Optional(String),\n        idGeneration: Match.Optional(String)\n      }));\n\n      if (options && options.transformName) {\n        options.transform = TRANSFORMS[options.transformName];\n      }\n      var c = new Mongo.Collection(name, options);\n      COLLECTIONS[name] = c;\n      c._insecure = true;\n      Meteor.publish('c-' + name, function () {\n        return c.find();\n      });\n    },\n    dropInsecureCollection: function(name) {\n      var c = COLLECTIONS[name];\n      c._dropCollection();\n    }\n  });\n}\n\n// We store the generated id, keyed by collection, for each insert\n// This is so we can test the stub and the server generate the same id\nvar INSERTED_IDS = {};\n\nMeteor.methods({\n  insertObjects: function (collectionName, doc, count) {\n    var c = COLLECTIONS[collectionName];\n    var ids = [];\n    for (var i = 0; i < count; i++) {\n      var id = c.insert(doc);\n      INSERTED_IDS[collectionName] = (INSERTED_IDS[collectionName] || []).concat([id]);\n      ids.push(id);\n    }\n    return ids;\n  },\n  upsertObject: function (collectionName, selector, modifier) {\n    var c = COLLECTIONS[collectionName];\n    return c.upsert(selector, modifier);\n  },\n  doMeteorCall: function (name /*, arguments */) {\n    var args = Array.prototype.slice.call(arguments);\n\n    return Meteor.call.apply(null, args);\n  }\n});\n\nvar runInFence = function (f) {\n  if (Meteor.isClient) {\n    f();\n  } else {\n    var fence = new DDPServer._WriteFence;\n    DDPServer._CurrentWriteFence.withValue(fence, f);\n    fence.armAndWait();\n  }\n};\n\n// Helpers for upsert tests\n\nvar stripId = function (obj) {\n  delete obj._id;\n};\n\nvar compareResults = function (test, skipIds, actual, expected) {\n  if (skipIds) {\n    _.map(actual, stripId);\n    _.map(expected, stripId);\n  }\n  // (technically should ignore order in comparison)\n  test.equal(actual, expected);\n};\n\nvar upsert = function (coll, useUpdate, query, mod, options, callback) {\n  if (! callback && typeof options === \"function\") {\n    callback = options;\n    options = {};\n  }\n\n  if (useUpdate) {\n    if (callback)\n      return coll.update(query, mod,\n                         _.extend({ upsert: true }, options),\n                         function (err, result) {\n                           callback(err, ! err && {\n                             numberAffected: result\n                           });\n                         });\n    return {\n      numberAffected: coll.update(query, mod,\n                                  _.extend({ upsert: true }, options))\n    };\n  } else {\n    return coll.upsert(query, mod, options, callback);\n  }\n};\n\nvar upsertTestMethod = \"livedata_upsert_test_method\";\nvar upsertTestMethodColl;\n\n// This is the implementation of the upsert test method on both the client and\n// the server. On the client, we get a test object. On the server, we just throw\n// errors if something doesn't go according to plan, and when the client\n// receives those errors it will cause the test to fail.\n//\n// Client-side exceptions in here will NOT cause the test to fail! Because it's\n// a stub, those exceptions will get caught and logged.\nvar upsertTestMethodImpl = function (coll, useUpdate, test) {\n  coll.remove({});\n  var result1 = upsert(coll, useUpdate, { foo: \"bar\" }, { foo: \"bar\" });\n\n  if (! test) {\n    test = {\n      equal: function (a, b) {\n        if (! EJSON.equals(a, b))\n          throw new Error(\"Not equal: \" +\n                          JSON.stringify(a) + \", \" + JSON.stringify(b));\n      },\n      isTrue: function (a) {\n        if (! a)\n          throw new Error(\"Not truthy: \" + JSON.stringify(a));\n      },\n      isFalse: function (a) {\n        if (a)\n          throw new Error(\"Not falsey: \" + JSON.stringify(a));\n      }\n    };\n  }\n\n  // if we don't test this, then testing result1.numberAffected will throw,\n  // which will get caught and logged and the whole test will pass!\n  test.isTrue(result1);\n\n  test.equal(result1.numberAffected, 1);\n  if (! useUpdate)\n    test.isTrue(result1.insertedId);\n  var fooId = result1.insertedId;\n  var obj = coll.findOne({ foo: \"bar\" });\n  test.isTrue(obj);\n  if (! useUpdate)\n    test.equal(obj._id, result1.insertedId);\n  var result2 = upsert(coll, useUpdate, { _id: fooId },\n                       { $set: { foo: \"baz \" } });\n  test.isTrue(result2);\n  test.equal(result2.numberAffected, 1);\n  test.isFalse(result2.insertedId);\n};\n\nif (Meteor.isServer) {\n  var m = {};\n  m[upsertTestMethod] = function (run, useUpdate, options) {\n    check(run, String);\n    check(useUpdate, Boolean);\n    upsertTestMethodColl = new Mongo.Collection(upsertTestMethod + \"_collection_\" + run, options);\n    upsertTestMethodImpl(upsertTestMethodColl, useUpdate);\n  };\n  Meteor.methods(m);\n}\n\nMeteor._FailureTestCollection =\n  new Mongo.Collection(\"___meteor_failure_test_collection\");\n\n// For test \"document with a custom type\"\nvar Dog = function (name, color, actions) {\n  var self = this;\n  self.color = color;\n  self.name = name;\n  self.actions = actions || [{name: \"wag\"}, {name: \"swim\"}];\n};\n_.extend(Dog.prototype, {\n  getName: function () { return this.name;},\n  getColor: function () { return this.name;},\n  equals: function (other) { return other.name === this.name &&\n                             other.color === this.color &&\n                             EJSON.equals(other.actions, this.actions);},\n  toJSONValue: function () { return {color: this.color, name: this.name, actions: this.actions};},\n  typeName: function () { return \"dog\"; },\n  clone: function () { return new Dog(this.name, this.color); },\n  speak: function () { return \"woof\"; }\n});\nEJSON.addType(\"dog\", function (o) { return new Dog(o.name, o.color, o.actions);});\n\n\n// Parameterize tests.\n_.each( ['STRING', 'MONGO'], function(idGeneration) {\n\nvar collectionOptions = { idGeneration: idGeneration};\n\ntestAsyncMulti(\"mongo-livedata - database error reporting. \" + idGeneration, [\n  function (test, expect) {\n    var ftc = Meteor._FailureTestCollection;\n\n    var exception = function (err, res) {\n      test.instanceOf(err, Error);\n    };\n\n    _.each([\"insert\", \"remove\", \"update\"], function (op) {\n      var arg = (op === \"insert\" ? {} : 'bla');\n      var arg2 = {};\n\n      var callOp = function (callback) {\n        if (op === \"update\") {\n          ftc[op](arg, arg2, callback);\n        } else {\n          ftc[op](arg, callback);\n        }\n      };\n\n      if (Meteor.isServer) {\n        test.throws(function () {\n          callOp();\n        });\n\n        callOp(expect(exception));\n      }\n\n      if (Meteor.isClient) {\n        callOp(expect(exception));\n\n        // This would log to console in normal operation.\n        Meteor._suppress_log(1);\n        callOp();\n      }\n    });\n  }\n]);\n\n\nTinytest.addAsync(\"mongo-livedata - basics, \" + idGeneration, function (test, onComplete) {\n  var run = test.runId();\n  var coll, coll2;\n  if (Meteor.isClient) {\n    coll = new Mongo.Collection(null, collectionOptions) ; // local, unmanaged\n    coll2 = new Mongo.Collection(null, collectionOptions); // local, unmanaged\n  } else {\n    coll = new Mongo.Collection(\"livedata_test_collection_\"+run, collectionOptions);\n    coll2 = new Mongo.Collection(\"livedata_test_collection_2_\"+run, collectionOptions);\n  }\n\n  var log = '';\n  var obs = coll.find({run: run}, {sort: [\"x\"]}).observe({\n    addedAt: function (doc, before_index, before) {\n      log += 'a(' + doc.x + ',' + before_index + ',' + before + ')';\n    },\n    changedAt: function (new_doc, old_doc, at_index) {\n      log += 'c(' + new_doc.x + ',' + at_index + ',' + old_doc.x + ')';\n    },\n    movedTo: function (doc, old_index, new_index) {\n      log += 'm(' + doc.x + ',' + old_index + ',' + new_index + ')';\n    },\n    removedAt: function (doc, at_index) {\n      log += 'r(' + doc.x + ',' + at_index + ')';\n    }\n  });\n\n  var captureObserve = function (f) {\n    if (Meteor.isClient) {\n      f();\n    } else {\n      var fence = new DDPServer._WriteFence;\n      DDPServer._CurrentWriteFence.withValue(fence, f);\n      fence.armAndWait();\n    }\n\n    var ret = log;\n    log = '';\n    return ret;\n  };\n\n  var expectObserve = function (expected, f) {\n    if (!(expected instanceof Array))\n      expected = [expected];\n\n    test.include(expected, captureObserve(f));\n  };\n\n  test.equal(coll.find({run: run}).count(), 0);\n  test.equal(coll.findOne(\"abc\"), undefined);\n  test.equal(coll.findOne({run: run}), undefined);\n\n  expectObserve('a(1,0,null)', function () {\n    var id = coll.insert({run: run, x: 1});\n    test.equal(coll.find({run: run}).count(), 1);\n    test.equal(coll.findOne(id).x, 1);\n    test.equal(coll.findOne({run: run}).x, 1);\n  });\n\n  expectObserve('a(4,1,null)', function () {\n    var id2 = coll.insert({run: run, x: 4});\n    test.equal(coll.find({run: run}).count(), 2);\n    test.equal(coll.find({_id: id2}).count(), 1);\n    test.equal(coll.findOne(id2).x, 4);\n  });\n\n  test.equal(coll.findOne({run: run}, {sort: [\"x\"], skip: 0}).x, 1);\n  test.equal(coll.findOne({run: run}, {sort: [\"x\"], skip: 1}).x, 4);\n  test.equal(coll.findOne({run: run}, {sort: {x: -1}, skip: 0}).x, 4);\n  test.equal(coll.findOne({run: run}, {sort: {x: -1}, skip: 1}).x, 1);\n\n\n  var cur = coll.find({run: run}, {sort: [\"x\"]});\n  var total = 0;\n  var index = 0;\n  var context = {};\n  cur.forEach(function (doc, i, cursor) {\n    test.equal(i, index++);\n    test.isTrue(cursor === cur);\n    test.isTrue(context === this);\n    total *= 10;\n    if (Meteor.isServer) {\n      // Verify that the callbacks from forEach run sequentially and that\n      // forEach waits for them to complete (issue# 321). If they do not run\n      // sequentially, then the second callback could execute during the first\n      // callback's sleep sleep and the *= 10 will occur before the += 1, then\n      // total (at test.equal time) will be 5. If forEach does not wait for the\n      // callbacks to complete, then total (at test.equal time) will be 0.\n      Meteor._sleepForMs(5);\n    }\n    total += doc.x;\n    // verify the meteor environment is set up here\n    coll2.insert({total:total});\n  }, context);\n  test.equal(total, 14);\n\n  index = 0;\n  test.equal(cur.map(function (doc, i, cursor) {\n    // XXX we could theoretically make map run its iterations in parallel or\n    // something which would make this fail\n    test.equal(i, index++);\n    test.isTrue(cursor === cur);\n    test.isTrue(context === this);\n    return doc.x * 2;\n  }, context), [2, 8]);\n\n  test.equal(_.pluck(coll.find({run: run}, {sort: {x: -1}}).fetch(), \"x\"),\n             [4, 1]);\n\n  expectObserve('', function () {\n    var count = coll.update({run: run, x: -1}, {$inc: {x: 2}}, {multi: true});\n    test.equal(count, 0);\n  });\n\n  expectObserve('c(3,0,1)c(6,1,4)', function () {\n    var count = coll.update({run: run}, {$inc: {x: 2}}, {multi: true});\n    test.equal(count, 2);\n    test.equal(_.pluck(coll.find({run: run}, {sort: {x: -1}}).fetch(), \"x\"),\n               [6, 3]);\n  });\n\n  expectObserve(['c(13,0,3)m(13,0,1)', 'm(6,1,0)c(13,1,3)',\n                 'c(13,0,3)m(6,1,0)', 'm(3,0,1)c(13,1,3)'], function () {\n    coll.update({run: run, x: 3}, {$inc: {x: 10}}, {multi: true});\n    test.equal(_.pluck(coll.find({run: run}, {sort: {x: -1}}).fetch(), \"x\"),\n               [13, 6]);\n  });\n\n  expectObserve('r(13,1)', function () {\n    var count = coll.remove({run: run, x: {$gt: 10}});\n    test.equal(count, 1);\n    test.equal(coll.find({run: run}).count(), 1);\n  });\n\n  expectObserve('r(6,0)', function () {\n    coll.remove({run: run});\n    test.equal(coll.find({run: run}).count(), 0);\n  });\n\n  expectObserve('', function () {\n    var count = coll.remove({run: run});\n    test.equal(count, 0);\n    test.equal(coll.find({run: run}).count(), 0);\n  });\n\n  obs.stop();\n  onComplete();\n});\n\nTinytest.addAsync(\"mongo-livedata - fuzz test, \" + idGeneration, function(test, onComplete) {\n\n  var run = Random.id();\n  var coll;\n  if (Meteor.isClient) {\n    coll = new Mongo.Collection(null, collectionOptions); // local, unmanaged\n  } else {\n    coll = new Mongo.Collection(\"livedata_test_collection_\"+run, collectionOptions);\n  }\n\n  // fuzz test of observe(), especially the server-side diffing\n  var actual = [];\n  var correct = [];\n  var counters = {add: 0, change: 0, move: 0, remove: 0};\n\n  var obs = coll.find({run: run}, {sort: [\"x\"]}).observe({\n    addedAt: function (doc, before_index) {\n      counters.add++;\n      actual.splice(before_index, 0, doc.x);\n    },\n    changedAt: function (new_doc, old_doc, at_index) {\n      counters.change++;\n      test.equal(actual[at_index], old_doc.x);\n      actual[at_index] = new_doc.x;\n    },\n    movedTo: function (doc, old_index, new_index) {\n      counters.move++;\n      test.equal(actual[old_index], doc.x);\n      actual.splice(old_index, 1);\n      actual.splice(new_index, 0, doc.x);\n    },\n    removedAt: function (doc, at_index) {\n      counters.remove++;\n      test.equal(actual[at_index], doc.x);\n      actual.splice(at_index, 1);\n    }\n  });\n\n  if (Meteor.isServer) {\n    // For now, has to be polling (not oplog) because it is ordered observe.\n    test.isTrue(obs._multiplexer._observeDriver._suspendPolling);\n  }\n\n  var step = 0;\n\n  // Use non-deterministic randomness so we can have a shorter fuzz\n  // test (fewer iterations).  For deterministic (fully seeded)\n  // randomness, remove the call to Random.fraction().\n  var seededRandom = new SeededRandom(\"foobard\" + Random.fraction());\n  // Random integer in [0,n)\n  var rnd = function (n) {\n    return seededRandom.nextIntBetween(0, n-1);\n  };\n\n  var finishObserve = function (f) {\n    if (Meteor.isClient) {\n      f();\n    } else {\n      var fence = new DDPServer._WriteFence;\n      DDPServer._CurrentWriteFence.withValue(fence, f);\n      fence.armAndWait();\n    }\n  };\n\n  var doStep = function () {\n    if (step++ === 5) { // run N random tests\n      obs.stop();\n      onComplete();\n      return;\n    }\n\n    var max_counters = _.clone(counters);\n\n    finishObserve(function () {\n      if (Meteor.isServer)\n        obs._multiplexer._observeDriver._suspendPolling();\n\n      // Do a batch of 1-10 operations\n      var batch_count = rnd(10) + 1;\n      for (var i = 0; i < batch_count; i++) {\n        // 25% add, 25% remove, 25% change in place, 25% change and move\n        var op = rnd(4);\n        var which = rnd(correct.length);\n        if (op === 0 || step < 2 || !correct.length) {\n          // Add\n          var x = rnd(1000000);\n          coll.insert({run: run, x: x});\n          correct.push(x);\n          max_counters.add++;\n        } else if (op === 1 || op === 2) {\n          var x = correct[which];\n          if (op === 1)\n            // Small change, not likely to cause a move\n            var val = x + (rnd(2) ? -1 : 1);\n          else\n            // Large change, likely to cause a move\n            var val = rnd(1000000);\n          coll.update({run: run, x: x}, {$set: {x: val}});\n          correct[which] = val;\n          max_counters.change++;\n          max_counters.move++;\n        } else {\n          coll.remove({run: run, x: correct[which]});\n          correct.splice(which, 1);\n          max_counters.remove++;\n        }\n      }\n      if (Meteor.isServer)\n        obs._multiplexer._observeDriver._resumePolling();\n\n    });\n\n    // Did we actually deliver messages that mutated the array in the\n    // right way?\n    correct.sort(function (a,b) {return a-b;});\n    test.equal(actual, correct);\n\n    // Did we limit ourselves to one 'moved' message per change,\n    // rather than O(results) moved messages?\n    _.each(max_counters, function (v, k) {\n      test.isTrue(max_counters[k] >= counters[k], k);\n    });\n\n    Meteor.defer(doStep);\n  };\n\n  doStep();\n\n});\n\nTinytest.addAsync(\"mongo-livedata - scribbling, \" + idGeneration, function (test, onComplete) {\n  var run = test.runId();\n  var coll;\n  if (Meteor.isClient) {\n    coll = new Mongo.Collection(null, collectionOptions); // local, unmanaged\n  } else {\n    coll = new Mongo.Collection(\"livedata_test_collection_\"+run, collectionOptions);\n  }\n\n  var numAddeds = 0;\n  var handle = coll.find({run: run}).observe({\n    addedAt: function (o) {\n      // test that we can scribble on the object we get back from Mongo without\n      // breaking anything.  The worst possible scribble is messing with _id.\n      delete o._id;\n      numAddeds++;\n    }\n  });\n  _.each([123, 456, 789], function (abc) {\n    runInFence(function () {\n      coll.insert({run: run, abc: abc});\n    });\n  });\n  handle.stop();\n  // will be 6 (1+2+3) if we broke diffing!\n  test.equal(numAddeds, 3);\n\n  onComplete();\n});\n\nTinytest.addAsync(\"mongo-livedata - stop handle in callback, \" + idGeneration, function (test, onComplete) {\n  var run = Random.id();\n  var coll;\n  if (Meteor.isClient) {\n    coll = new Mongo.Collection(null, collectionOptions); // local, unmanaged\n  } else {\n    coll = new Mongo.Collection(\"stopHandleInCallback-\"+run, collectionOptions);\n  }\n\n  var output = [];\n\n  var handle = coll.find().observe({\n    added: function (doc) {\n      output.push({added: doc._id});\n    },\n    changed: function (newDoc) {\n      output.push('changed');\n      handle.stop();\n    }\n  });\n\n  test.equal(output, []);\n\n  // Insert a document. Observe that the added callback is called.\n  var docId;\n  runInFence(function () {\n    docId = coll.insert({foo: 42});\n  });\n  test.length(output, 1);\n  test.equal(output.shift(), {added: docId});\n\n  // Update it. Observe that the changed callback is called. This should also\n  // stop the observation.\n  runInFence(function() {\n    coll.update(docId, {$set: {bar: 10}});\n  });\n  test.length(output, 1);\n  test.equal(output.shift(), 'changed');\n\n  // Update again. This shouldn't call the callback because we stopped the\n  // observation.\n  runInFence(function() {\n    coll.update(docId, {$set: {baz: 40}});\n  });\n  test.length(output, 0);\n\n  test.equal(coll.find().count(), 1);\n  test.equal(coll.findOne(docId),\n             {_id: docId, foo: 42, bar: 10, baz: 40});\n\n  onComplete();\n});\n\n// This behavior isn't great, but it beats deadlock.\nif (Meteor.isServer) {\n  Tinytest.addAsync(\"mongo-livedata - recursive observe throws, \" + idGeneration, function (test, onComplete) {\n    var run = test.runId();\n    var coll = new Mongo.Collection(\"observeInCallback-\"+run, collectionOptions);\n\n    var callbackCalled = false;\n    var handle = coll.find({}).observe({\n      added: function (newDoc) {\n        callbackCalled = true;\n        test.throws(function () {\n          coll.find({}).observe();\n        });\n      }\n    });\n    test.isFalse(callbackCalled);\n    // Insert a document. Observe that the added callback is called.\n    runInFence(function () {\n      coll.insert({foo: 42});\n    });\n    test.isTrue(callbackCalled);\n\n    handle.stop();\n\n    onComplete();\n  });\n\n  Tinytest.addAsync(\"mongo-livedata - cursor dedup, \" + idGeneration, function (test, onComplete) {\n    var run = test.runId();\n    var coll = new Mongo.Collection(\"cursorDedup-\"+run, collectionOptions);\n\n    var observer = function (noAdded) {\n      var output = [];\n      var callbacks = {\n        changed: function (newDoc) {\n          output.push({changed: newDoc._id});\n        }\n      };\n      if (!noAdded) {\n        callbacks.added = function (doc) {\n          output.push({added: doc._id});\n        };\n      }\n      var handle = coll.find({foo: 22}).observe(callbacks);\n      return {output: output, handle: handle};\n    };\n\n    // Insert a doc and start observing.\n    var docId1 = coll.insert({foo: 22});\n    var o1 = observer();\n    // Initial add.\n    test.length(o1.output, 1);\n    test.equal(o1.output.shift(), {added: docId1});\n\n    // Insert another doc (blocking until observes have fired).\n    var docId2;\n    runInFence(function () {\n      docId2 = coll.insert({foo: 22, bar: 5});\n    });\n    // Observed add.\n    test.length(o1.output, 1);\n    test.equal(o1.output.shift(), {added: docId2});\n\n    // Second identical observe.\n    var o2 = observer();\n    // Initial adds.\n    test.length(o2.output, 2);\n    test.include([docId1, docId2], o2.output[0].added);\n    test.include([docId1, docId2], o2.output[1].added);\n    test.notEqual(o2.output[0].added, o2.output[1].added);\n    o2.output.length = 0;\n    // Original observe not affected.\n    test.length(o1.output, 0);\n\n    // White-box test: both observes should share an ObserveMultiplexer.\n    var observeMultiplexer = o1.handle._multiplexer;\n    test.isTrue(observeMultiplexer);\n    test.isTrue(observeMultiplexer === o2.handle._multiplexer);\n\n    // Update. Both observes fire.\n    runInFence(function () {\n      coll.update(docId1, {$set: {x: 'y'}});\n    });\n    test.length(o1.output, 1);\n    test.length(o2.output, 1);\n    test.equal(o1.output.shift(), {changed: docId1});\n    test.equal(o2.output.shift(), {changed: docId1});\n\n    // Stop first handle. Second handle still around.\n    o1.handle.stop();\n    test.length(o1.output, 0);\n    test.length(o2.output, 0);\n\n    // Another update. Just the second handle should fire.\n    runInFence(function () {\n      coll.update(docId2, {$set: {z: 'y'}});\n    });\n    test.length(o1.output, 0);\n    test.length(o2.output, 1);\n    test.equal(o2.output.shift(), {changed: docId2});\n\n    // Stop second handle. Nothing should happen, but the multiplexer should\n    // be stopped.\n    test.isTrue(observeMultiplexer._handles);  // This will change.\n    o2.handle.stop();\n    test.length(o1.output, 0);\n    test.length(o2.output, 0);\n    // White-box: ObserveMultiplexer has nulled its _handles so you can't\n    // accidentally join to it.\n    test.isNull(observeMultiplexer._handles);\n\n    // Start yet another handle on the same query.\n    var o3 = observer();\n    // Initial adds.\n    test.length(o3.output, 2);\n    test.include([docId1, docId2], o3.output[0].added);\n    test.include([docId1, docId2], o3.output[1].added);\n    test.notEqual(o3.output[0].added, o3.output[1].added);\n    // Old observers not called.\n    test.length(o1.output, 0);\n    test.length(o2.output, 0);\n    // White-box: Different ObserveMultiplexer.\n    test.isTrue(observeMultiplexer !== o3.handle._multiplexer);\n\n    // Start another handle with no added callback. Regression test for #589.\n    var o4 = observer(true);\n\n    o3.handle.stop();\n    o4.handle.stop();\n\n    onComplete();\n  });\n\n  Tinytest.addAsync(\"mongo-livedata - async server-side insert, \" + idGeneration, function (test, onComplete) {\n    // Tests that insert returns before the callback runs. Relies on the fact\n    // that mongo does not run the callback before spinning off the event loop.\n    var cname = Random.id();\n    var coll = new Mongo.Collection(cname);\n    var doc = { foo: \"bar\" };\n    var x = 0;\n    coll.insert(doc, function (err, result) {\n      test.equal(err, null);\n      test.equal(x, 1);\n      onComplete();\n    });\n    x++;\n  });\n\n  Tinytest.addAsync(\"mongo-livedata - async server-side update, \" + idGeneration, function (test, onComplete) {\n    // Tests that update returns before the callback runs.\n    var cname = Random.id();\n    var coll = new Mongo.Collection(cname);\n    var doc = { foo: \"bar\" };\n    var x = 0;\n    var id = coll.insert(doc);\n    coll.update(id, { $set: { foo: \"baz\" } }, function (err, result) {\n      test.equal(err, null);\n      test.equal(result, 1);\n      test.equal(x, 1);\n      onComplete();\n    });\n    x++;\n  });\n\n  Tinytest.addAsync(\"mongo-livedata - async server-side remove, \" + idGeneration, function (test, onComplete) {\n    // Tests that remove returns before the callback runs.\n    var cname = Random.id();\n    var coll = new Mongo.Collection(cname);\n    var doc = { foo: \"bar\" };\n    var x = 0;\n    var id = coll.insert(doc);\n    coll.remove(id, function (err, result) {\n      test.equal(err, null);\n      test.isFalse(coll.findOne(id));\n      test.equal(x, 1);\n      onComplete();\n    });\n    x++;\n  });\n\n  // compares arrays a and b w/o looking at order\n  var setsEqual = function (a, b) {\n    a = _.map(a, EJSON.stringify);\n    b = _.map(b, EJSON.stringify);\n    return _.isEmpty(_.difference(a, b)) && _.isEmpty(_.difference(b, a));\n  };\n\n  // This test mainly checks the correctness of oplog code dealing with limited\n  // queries. Compitablity with poll-diff is added as well.\n  Tinytest.addAsync(\"mongo-livedata - observe sorted, limited \" + idGeneration, function (test, onComplete) {\n    var run = test.runId();\n    var coll = new Mongo.Collection(\"observeLimit-\"+run, collectionOptions);\n\n    var observer = function () {\n      var state = {};\n      var output = [];\n      var callbacks = {\n        changed: function (newDoc) {\n          output.push({changed: newDoc._id});\n          state[newDoc._id] = newDoc;\n        },\n        added: function (newDoc) {\n          output.push({added: newDoc._id});\n          state[newDoc._id] = newDoc;\n        },\n        removed: function (oldDoc) {\n          output.push({removed: oldDoc._id});\n          delete state[oldDoc._id];\n        }\n      };\n      var handle = coll.find({foo: 22},\n                             {sort: {bar: 1}, limit: 3}).observe(callbacks);\n\n      return {output: output, handle: handle, state: state};\n    };\n    var clearOutput = function (o) { o.output.splice(0, o.output.length); };\n\n    var ins = function (doc) {\n      var id; runInFence(function () { id = coll.insert(doc); });\n      return id;\n    };\n    var rem = function (sel) { runInFence(function () { coll.remove(sel); }); };\n    var upd = function (sel, mod, opt) {\n      runInFence(function () {\n        coll.update(sel, mod, opt);\n      });\n    };\n    // tests '_id' subfields for all documents in oplog buffer\n    var testOplogBufferIds = function (ids) {\n      if (!usesOplog)\n        return;\n      var bufferIds = [];\n      o.handle._multiplexer._observeDriver._unpublishedBuffer.forEach(function (x, id) {\n        bufferIds.push(id);\n      });\n\n      test.isTrue(setsEqual(ids, bufferIds), \"expected: \" + ids + \"; got: \" + bufferIds);\n    };\n    var testSafeAppendToBufferFlag = function (expected) {\n      if (!usesOplog)\n        return;\n      test.equal(o.handle._multiplexer._observeDriver._safeAppendToBuffer,\n                 expected);\n    };\n\n    // We'll describe our state as follows.  5:1 means \"the document with\n    // _id=docId1 and bar=5\".  We list documents as\n    //   [ currently published | in the buffer ] outside the buffer\n    // If safeToAppendToBuffer is true, we'll say ]! instead.\n\n    // Insert a doc and start observing.\n    var docId1 = ins({foo: 22, bar: 5});\n    waitUntilOplogCaughtUp();\n\n    // State: [ 5:1 | ]!\n    var o = observer();\n    var usesOplog = o.handle._multiplexer._observeDriver._usesOplog;\n    // Initial add.\n    test.length(o.output, 1);\n    test.equal(o.output.shift(), {added: docId1});\n    testSafeAppendToBufferFlag(true);\n\n    // Insert another doc (blocking until observes have fired).\n    // State: [ 5:1 6:2 | ]!\n    var docId2 = ins({foo: 22, bar: 6});\n    // Observed add.\n    test.length(o.output, 1);\n    test.equal(o.output.shift(), {added: docId2});\n    testSafeAppendToBufferFlag(true);\n\n    var docId3 = ins({ foo: 22, bar: 3 });\n    // State: [ 3:3 5:1 6:2 | ]!\n    test.length(o.output, 1);\n    test.equal(o.output.shift(), {added: docId3});\n    testSafeAppendToBufferFlag(true);\n\n    // Add a non-matching document\n    ins({ foo: 13 });\n    // It shouldn't be added\n    test.length(o.output, 0);\n\n    // Add something that matches but is too big to fit in\n    var docId4 = ins({ foo: 22, bar: 7 });\n    // State: [ 3:3 5:1 6:2 | 7:4 ]!\n    // It shouldn't be added but should end up in the buffer.\n    test.length(o.output, 0);\n    testOplogBufferIds([docId4]);\n    testSafeAppendToBufferFlag(true);\n\n    // Let's add something small enough to fit in\n    var docId5 = ins({ foo: 22, bar: -1 });\n    // State: [ -1:5 3:3 5:1 | 6:2 7:4 ]!\n    // We should get an added and a removed events\n    test.length(o.output, 2);\n    // doc 2 was removed from the published set as it is too big to be in\n    test.isTrue(setsEqual(o.output, [{added: docId5}, {removed: docId2}]));\n    clearOutput(o);\n    testOplogBufferIds([docId2, docId4]);\n    testSafeAppendToBufferFlag(true);\n\n    // Now remove something and that doc 2 should be right back\n    rem(docId5);\n    // State: [ 3:3 5:1 6:2 | 7:4 ]!\n    test.length(o.output, 2);\n    test.isTrue(setsEqual(o.output, [{removed: docId5}, {added: docId2}]));\n    clearOutput(o);\n    testOplogBufferIds([docId4]);\n    testSafeAppendToBufferFlag(true);\n\n    // Add some negative numbers overflowing the buffer.\n    // New documents will take the published place, [3 5 6] will take the buffer\n    // and 7 will be outside of the buffer in MongoDB.\n    var docId6 = ins({ foo: 22, bar: -1 });\n    var docId7 = ins({ foo: 22, bar: -2 });\n    var docId8 = ins({ foo: 22, bar: -3 });\n    // State: [ -3:8 -2:7 -1:6 | 3:3 5:1 6:2 ] 7:4\n    test.length(o.output, 6);\n    var expected = [{added: docId6}, {removed: docId2},\n                    {added: docId7}, {removed: docId1},\n                    {added: docId8}, {removed: docId3}];\n    test.isTrue(setsEqual(o.output, expected));\n    clearOutput(o);\n    testOplogBufferIds([docId1, docId2, docId3]);\n    testSafeAppendToBufferFlag(false);\n\n    // If we update first 3 docs (increment them by 20), it would be\n    // interesting.\n    upd({ bar: { $lt: 0 }}, { $inc: { bar: 20 } }, { multi: true });\n    // State: [ 3:3 5:1 6:2 | ] 7:4 17:8 18:7 19:6\n    //   which triggers re-poll leaving us at\n    // State: [ 3:3 5:1 6:2 | 7:4 17:8 18:7 ] 19:6\n\n    // The updated documents can't find their place in published and they can't\n    // be buffered as we are not aware of the situation outside of the buffer.\n    // But since our buffer becomes empty, it will be refilled partially with\n    // updated documents.\n    test.length(o.output, 6);\n    var expectedRemoves = [{removed: docId6},\n                           {removed: docId7},\n                           {removed: docId8}];\n    var expectedAdds = [{added: docId3},\n                        {added: docId1},\n                        {added: docId2}];\n\n    test.isTrue(setsEqual(o.output, expectedAdds.concat(expectedRemoves)));\n    clearOutput(o);\n    testOplogBufferIds([docId4, docId7, docId8]);\n    testSafeAppendToBufferFlag(false);\n\n    // Remove first 4 docs (3, 1, 2, 4) forcing buffer to become empty and\n    // schedule a repoll.\n    rem({ bar: { $lt: 10 } });\n    // State: [ 17:8 18:7 19:6 | ]!\n\n    // XXX the oplog code analyzes the events one by one: one remove after\n    // another. Poll-n-diff code, on the other side, analyzes the batch action\n    // of multiple remove. Because of that difference, expected outputs differ.\n    if (usesOplog) {\n      var expectedRemoves = [{removed: docId3}, {removed: docId1},\n                             {removed: docId2}, {removed: docId4}];\n      var expectedAdds = [{added: docId4}, {added: docId8},\n                          {added: docId7}, {added: docId6}];\n\n      test.length(o.output, 8);\n    } else {\n      var expectedRemoves = [{removed: docId3}, {removed: docId1},\n                             {removed: docId2}];\n      var expectedAdds = [{added: docId8}, {added: docId7}, {added: docId6}];\n\n      test.length(o.output, 6);\n    }\n\n    test.isTrue(setsEqual(o.output, expectedAdds.concat(expectedRemoves)));\n    clearOutput(o);\n    testOplogBufferIds([]);\n    testSafeAppendToBufferFlag(true);\n\n    var docId9 = ins({ foo: 22, bar: 21 });\n    var docId10 = ins({ foo: 22, bar: 31 });\n    var docId11 = ins({ foo: 22, bar: 41 });\n    var docId12 = ins({ foo: 22, bar: 51 });\n    // State: [ 17:8 18:7 19:6 | 21:9 31:10 41:11 ] 51:12\n\n    testOplogBufferIds([docId9, docId10, docId11]);\n    testSafeAppendToBufferFlag(false);\n    test.length(o.output, 0);\n    upd({ bar: { $lt: 20 } }, { $inc: { bar: 5 } }, { multi: true });\n    // State: [ 21:9 22:8 23:7 | 24:6 31:10 41:11 ] 51:12\n    test.length(o.output, 4);\n    test.isTrue(setsEqual(o.output, [{removed: docId6},\n                                     {added: docId9},\n                                     {changed: docId7},\n                                     {changed: docId8}]));\n    clearOutput(o);\n    testOplogBufferIds([docId6, docId10, docId11]);\n    testSafeAppendToBufferFlag(false);\n\n    rem(docId9);\n    // State: [ 22:8 23:7 24:6 | 31:10 41:11 ] 51:12\n    test.length(o.output, 2);\n    test.isTrue(setsEqual(o.output, [{removed: docId9}, {added: docId6}]));\n    clearOutput(o);\n    testOplogBufferIds([docId10, docId11]);\n    testSafeAppendToBufferFlag(false);\n\n    upd({ bar: { $gt: 25 } }, { $inc: { bar: -7.5 } }, { multi: true });\n    // State: [ 22:8 23:7 23.5:10 | 24:6 ] 33.5:11 43.5:12\n    // 33.5 doesn't update in-place in buffer, because it the driver is not sure\n    // it can do it: because the buffer does not have the safe append flag set,\n    // for all it knows there is a different doc which is less than 33.5.\n    test.length(o.output, 2);\n    test.isTrue(setsEqual(o.output, [{removed: docId6}, {added: docId10}]));\n    clearOutput(o);\n    testOplogBufferIds([docId6]);\n    testSafeAppendToBufferFlag(false);\n\n    // Force buffer objects to be moved into published set so we can check them\n    rem(docId7);\n    rem(docId8);\n    rem(docId10);\n    // State: [ 24:6 | ] 33.5:11 43.5:12\n    //    triggers repoll\n    // State: [ 24:6 33.5:11 43.5:12 | ]!\n    test.length(o.output, 6);\n    test.isTrue(setsEqual(o.output, [{removed: docId7}, {removed: docId8},\n                                     {removed: docId10}, {added: docId6},\n                                     {added: docId11}, {added: docId12}]));\n\n    test.length(_.keys(o.state), 3);\n    test.equal(o.state[docId6], { _id: docId6, foo: 22, bar: 24 });\n    test.equal(o.state[docId11], { _id: docId11, foo: 22, bar: 33.5 });\n    test.equal(o.state[docId12], { _id: docId12, foo: 22, bar: 43.5 });\n    clearOutput(o);\n    testOplogBufferIds([]);\n    testSafeAppendToBufferFlag(true);\n\n    var docId13 = ins({ foo: 22, bar: 50 });\n    var docId14 = ins({ foo: 22, bar: 51 });\n    var docId15 = ins({ foo: 22, bar: 52 });\n    var docId16 = ins({ foo: 22, bar: 53 });\n    // State: [ 24:6 33.5:11 43.5:12 | 50:13 51:14 52:15 ] 53:16\n    test.length(o.output, 0);\n    testOplogBufferIds([docId13, docId14, docId15]);\n    testSafeAppendToBufferFlag(false);\n\n    // Update something that's outside the buffer to be in the buffer, writing\n    // only to the sort key.\n    upd(docId16, {$set: {bar: 10}});\n    // State: [ 10:16 24:6 33.5:11 | 43.5:12 50:13 51:14 ] 52:15\n    test.length(o.output, 2);\n    test.isTrue(setsEqual(o.output, [{removed: docId12}, {added: docId16}]));\n    clearOutput(o);\n    testOplogBufferIds([docId12, docId13, docId14]);\n    testSafeAppendToBufferFlag(false);\n\n    o.handle.stop();\n    onComplete();\n  });\n\n  Tinytest.addAsync(\"mongo-livedata - observe sorted, limited, sort fields \" + idGeneration, function (test, onComplete) {\n    var run = test.runId();\n    var coll = new Mongo.Collection(\"observeLimit-\"+run, collectionOptions);\n\n    var observer = function () {\n      var state = {};\n      var output = [];\n      var callbacks = {\n        changed: function (newDoc) {\n          output.push({changed: newDoc._id});\n          state[newDoc._id] = newDoc;\n        },\n        added: function (newDoc) {\n          output.push({added: newDoc._id});\n          state[newDoc._id] = newDoc;\n        },\n        removed: function (oldDoc) {\n          output.push({removed: oldDoc._id});\n          delete state[oldDoc._id];\n        }\n      };\n      var handle = coll.find({}, {sort: {x: 1},\n                                  limit: 2,\n                                  fields: {y: 1}}).observe(callbacks);\n\n      return {output: output, handle: handle, state: state};\n    };\n    var clearOutput = function (o) { o.output.splice(0, o.output.length); };\n    var ins = function (doc) {\n      var id; runInFence(function () { id = coll.insert(doc); });\n      return id;\n    };\n    var rem = function (id) {\n      runInFence(function () { coll.remove(id); });\n    };\n\n    var o = observer();\n\n    var docId1 = ins({ x: 1, y: 1222 });\n    var docId2 = ins({ x: 5, y: 5222 });\n\n    test.length(o.output, 2);\n    test.equal(o.output, [{added: docId1}, {added: docId2}]);\n    clearOutput(o);\n\n    var docId3 = ins({ x: 7, y: 7222 });\n    test.length(o.output, 0);\n\n    var docId4 = ins({ x: -1, y: -1222 });\n\n    // Becomes [docId4 docId1 | docId2 docId3]\n    test.length(o.output, 2);\n    test.isTrue(setsEqual(o.output, [{added: docId4}, {removed: docId2}]));\n\n    test.equal(_.size(o.state), 2);\n    test.equal(o.state[docId4], {_id: docId4, y: -1222});\n    test.equal(o.state[docId1], {_id: docId1, y: 1222});\n    clearOutput(o);\n\n    rem(docId2);\n    // Becomes [docId4 docId1 | docId3]\n    test.length(o.output, 0);\n\n    rem(docId4);\n    // Becomes [docId1 docId3]\n    test.length(o.output, 2);\n    test.isTrue(setsEqual(o.output, [{added: docId3}, {removed: docId4}]));\n\n    test.equal(_.size(o.state), 2);\n    test.equal(o.state[docId3], {_id: docId3, y: 7222});\n    test.equal(o.state[docId1], {_id: docId1, y: 1222});\n    clearOutput(o);\n\n    onComplete();\n  });\n\n  Tinytest.addAsync(\"mongo-livedata - observe sorted, limited, big initial set\" + idGeneration, function (test, onComplete) {\n    var run = test.runId();\n    var coll = new Mongo.Collection(\"observeLimit-\"+run, collectionOptions);\n\n    var observer = function () {\n      var state = {};\n      var output = [];\n      var callbacks = {\n        changed: function (newDoc) {\n          output.push({changed: newDoc._id});\n          state[newDoc._id] = newDoc;\n        },\n        added: function (newDoc) {\n          output.push({added: newDoc._id});\n          state[newDoc._id] = newDoc;\n        },\n        removed: function (oldDoc) {\n          output.push({removed: oldDoc._id});\n          delete state[oldDoc._id];\n        }\n      };\n      var handle = coll.find({}, {sort: {x: 1, y: 1}, limit: 3})\n                    .observe(callbacks);\n\n      return {output: output, handle: handle, state: state};\n    };\n    var clearOutput = function (o) { o.output.splice(0, o.output.length); };\n    var ins = function (doc) {\n      var id; runInFence(function () { id = coll.insert(doc); });\n      return id;\n    };\n    var rem = function (id) {\n      runInFence(function () { coll.remove(id); });\n    };\n    // tests '_id' subfields for all documents in oplog buffer\n    var testOplogBufferIds = function (ids) {\n      var bufferIds = [];\n      o.handle._multiplexer._observeDriver._unpublishedBuffer.forEach(function (x, id) {\n        bufferIds.push(id);\n      });\n\n      test.isTrue(setsEqual(ids, bufferIds), \"expected: \" + ids + \"; got: \" + bufferIds);\n    };\n    var testSafeAppendToBufferFlag = function (expected) {\n      if (expected)\n        test.isTrue(o.handle._multiplexer._observeDriver._safeAppendToBuffer);\n      else\n        test.isFalse(o.handle._multiplexer._observeDriver._safeAppendToBuffer);\n    };\n\n    var ids = {};\n    _.each([2, 4, 1, 3, 5, 5, 9, 1, 3, 2, 5], function (x, i) {\n      ids[i] = ins({ x: x, y: i });\n    });\n\n    // Ensure that we are past all the 'i' entries before we run the query, so\n    // that we get the expected phase transitions.\n    waitUntilOplogCaughtUp();\n\n    var o = observer();\n    var usesOplog = o.handle._multiplexer._observeDriver._usesOplog;\n    //  x: [1 1 2 | 2 3 3] 4 5 5 5  9\n    // id: [2 7 0 | 9 3 8] 1 4 5 10 6\n\n    test.length(o.output, 3);\n    test.isTrue(setsEqual([{added: ids[2]}, {added: ids[7]}, {added: ids[0]}], o.output));\n    usesOplog && testOplogBufferIds([ids[9], ids[3], ids[8]]);\n    usesOplog && testSafeAppendToBufferFlag(false);\n    clearOutput(o);\n\n    rem(ids[0]);\n    //  x: [1 1 2 | 3 3] 4 5 5 5  9\n    // id: [2 7 9 | 3 8] 1 4 5 10 6\n    test.length(o.output, 2);\n    test.isTrue(setsEqual([{removed: ids[0]}, {added: ids[9]}], o.output));\n    usesOplog && testOplogBufferIds([ids[3], ids[8]]);\n    usesOplog && testSafeAppendToBufferFlag(false);\n    clearOutput(o);\n\n    rem(ids[7]);\n    //  x: [1 2 3 | 3] 4 5 5 5  9\n    // id: [2 9 3 | 8] 1 4 5 10 6\n    test.length(o.output, 2);\n    test.isTrue(setsEqual([{removed: ids[7]}, {added: ids[3]}], o.output));\n    usesOplog && testOplogBufferIds([ids[8]]);\n    usesOplog && testSafeAppendToBufferFlag(false);\n    clearOutput(o);\n\n    rem(ids[3]);\n    //  x: [1 2 3 | 4 5 5] 5  9\n    // id: [2 9 8 | 1 4 5] 10 6\n    test.length(o.output, 2);\n    test.isTrue(setsEqual([{removed: ids[3]}, {added: ids[8]}], o.output));\n    usesOplog && testOplogBufferIds([ids[1], ids[4], ids[5]]);\n    usesOplog && testSafeAppendToBufferFlag(false);\n    clearOutput(o);\n\n    rem({ x: {$lt: 4} });\n    //  x: [4 5 5 | 5  9]\n    // id: [1 4 5 | 10 6]\n    test.length(o.output, 6);\n    test.isTrue(setsEqual([{removed: ids[2]}, {removed: ids[9]}, {removed: ids[8]},\n                           {added: ids[5]}, {added: ids[4]}, {added: ids[1]}], o.output));\n    usesOplog && testOplogBufferIds([ids[10], ids[6]]);\n    usesOplog && testSafeAppendToBufferFlag(true);\n    clearOutput(o);\n\n\n    onComplete();\n  });\n}\n\n\ntestAsyncMulti('mongo-livedata - empty documents, ' + idGeneration, [\n  function (test, expect) {\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var coll = new Mongo.Collection(this.collectionName, collectionOptions);\n\n    coll.insert({}, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      var cursor = coll.find();\n      test.equal(cursor.count(), 1);\n    }));\n  }\n]);\n\n// Regression test for #2413.\ntestAsyncMulti('mongo-livedata - upsert without callback, ' + idGeneration, [\n  function (test, expect) {\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var coll = new Mongo.Collection(this.collectionName, collectionOptions);\n\n    // No callback!  Before fixing #2413, this method never returned and\n    // so no future DDP methods worked either.\n    coll.upsert('foo', {bar: 1});\n    // Do something else on the same method and expect it to actually work.\n    // (If the bug comes back, this will 'async batch timeout'.)\n    coll.insert({}, expect(function(){}));\n  }\n]);\n\n// See https://github.com/meteor/meteor/issues/594.\ntestAsyncMulti('mongo-livedata - document with length, ' + idGeneration, [\n  function (test, expect) {\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName, collectionOptions);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var self = this;\n    var coll = self.coll = new Mongo.Collection(self.collectionName, collectionOptions);\n\n    coll.insert({foo: 'x', length: 0}, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      self.docId = id;\n      test.equal(coll.findOne(self.docId),\n                 {_id: self.docId, foo: 'x', length: 0});\n    }));\n  },\n  function (test, expect) {\n    var self = this;\n    var coll = self.coll;\n    coll.update(self.docId, {$set: {length: 5}}, expect(function (err) {\n      test.isFalse(err);\n      test.equal(coll.findOne(self.docId),\n                 {_id: self.docId, foo: 'x', length: 5});\n    }));\n  }\n]);\n\ntestAsyncMulti('mongo-livedata - document with a date, ' + idGeneration, [\n  function (test, expect) {\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName, collectionOptions);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n\n    var coll = new Mongo.Collection(this.collectionName, collectionOptions);\n    var docId;\n    coll.insert({d: new Date(1356152390004)}, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      docId = id;\n      var cursor = coll.find();\n      test.equal(cursor.count(), 1);\n      test.equal(coll.findOne().d.getFullYear(), 2012);\n    }));\n  }\n]);\n\ntestAsyncMulti('mongo-livedata - document goes through a transform, ' + idGeneration, [\n  function (test, expect) {\n    var self = this;\n    var seconds = function (doc) {\n      doc.seconds = function () {return doc.d.getSeconds();};\n      return doc;\n    };\n    TRANSFORMS[\"seconds\"] = seconds;\n    self.collectionOptions = {\n      idGeneration: idGeneration,\n      transform: seconds,\n      transformName: \"seconds\"\n    };\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName, collectionOptions);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var self = this;\n    self.coll = new Mongo.Collection(self.collectionName, self.collectionOptions);\n    var obs;\n    var expectAdd = expect(function (doc) {\n      test.equal(doc.seconds(), 50);\n    });\n    var expectRemove = expect(function (doc) {\n      test.equal(doc.seconds(), 50);\n      obs.stop();\n    });\n    self.coll.insert({d: new Date(1356152390004)}, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      var cursor = self.coll.find();\n      obs = cursor.observe({\n        added: expectAdd,\n        removed: expectRemove\n      });\n      test.equal(cursor.count(), 1);\n      test.equal(cursor.fetch()[0].seconds(), 50);\n      test.equal(self.coll.findOne().seconds(), 50);\n      test.equal(self.coll.findOne({}, {transform: null}).seconds, undefined);\n      test.equal(self.coll.findOne({}, {\n        transform: function (doc) {return {seconds: doc.d.getSeconds()};}\n      }).seconds, 50);\n      self.coll.remove(id);\n    }));\n  },\n  function (test, expect) {\n    var self = this;\n    self.coll.insert({d: new Date(1356152390004)}, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      self.id1 = id;\n    }));\n    self.coll.insert({d: new Date(1356152391004)}, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      self.id2 = id;\n    }));\n  }\n]);\n\ntestAsyncMulti('mongo-livedata - transform sets _id if not present, ' + idGeneration, [\n  function (test, expect) {\n    var self = this;\n    var justId = function (doc) {\n      return _.omit(doc, '_id');\n    };\n    TRANSFORMS[\"justId\"] = justId;\n    var collectionOptions = {\n      idGeneration: idGeneration,\n      transform: justId,\n      transformName: \"justId\"\n    };\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName, collectionOptions);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var self = this;\n    self.coll = new Mongo.Collection(this.collectionName, collectionOptions);\n    self.coll.insert({}, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      test.equal(self.coll.findOne()._id, id);\n    }));\n  }\n]);\n\nvar bin = Base64.decode(\n  \"TWFuIGlzIGRpc3Rpbmd1aXNoZWQsIG5vdCBvbmx5IGJ5IGhpcyBy\" +\n    \"ZWFzb24sIGJ1dCBieSB0aGlzIHNpbmd1bGFyIHBhc3Npb24gZnJv\" +\n    \"bSBvdGhlciBhbmltYWxzLCB3aGljaCBpcyBhIGx1c3Qgb2YgdGhl\" +\n    \"IG1pbmQsIHRoYXQgYnkgYSBwZXJzZXZlcmFuY2Ugb2YgZGVsaWdo\" +\n    \"dCBpbiB0aGUgY29udGludWVkIGFuZCBpbmRlZmF0aWdhYmxlIGdl\" +\n    \"bmVyYXRpb24gb2Yga25vd2xlZGdlLCBleGNlZWRzIHRoZSBzaG9y\" +\n    \"dCB2ZWhlbWVuY2Ugb2YgYW55IGNhcm5hbCBwbGVhc3VyZS4=\");\n\ntestAsyncMulti('mongo-livedata - document with binary data, ' + idGeneration, [\n  function (test, expect) {\n    // XXX probably shouldn't use EJSON's private test symbols\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName, collectionOptions);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var coll = new Mongo.Collection(this.collectionName, collectionOptions);\n    var docId;\n    coll.insert({b: bin}, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      docId = id;\n      var cursor = coll.find();\n      test.equal(cursor.count(), 1);\n      var inColl = coll.findOne();\n      test.isTrue(EJSON.isBinary(inColl.b));\n      test.equal(inColl.b, bin);\n    }));\n  }\n]);\n\ntestAsyncMulti('mongo-livedata - document with a custom type, ' + idGeneration, [\n  function (test, expect) {\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName, collectionOptions);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var self = this;\n    self.coll = new Mongo.Collection(this.collectionName, collectionOptions);\n    var docId;\n    // Dog is implemented at the top of the file, outside of the idGeneration\n    // loop (so that we only call EJSON.addType once).\n    var d = new Dog(\"reginald\", \"purple\");\n    self.coll.insert({d: d}, expect(function (err, id) {\n      test.isFalse(err);\n      test.isTrue(id);\n      docId = id;\n      self.docId = docId;\n      var cursor = self.coll.find();\n      test.equal(cursor.count(), 1);\n      var inColl = self.coll.findOne();\n      test.isTrue(inColl);\n      inColl && test.equal(inColl.d.speak(), \"woof\");\n    }));\n  }, function (test, expect) {\n    var self = this;\n    self.coll.insert(new Dog(\"rover\", \"orange\"), expect(function (err, id) {\n      test.isTrue(err);\n      test.isFalse(id);\n    }));\n  }, function (test, expect) {\n    var self = this;\n    self.coll.update(\n      self.docId, new Dog(\"rover\", \"orange\"), expect(function (err) {\n        test.isTrue(err);\n      }));\n  }\n]);\n\nif (Meteor.isServer) {\n  Tinytest.addAsync(\"mongo-livedata - update return values, \" + idGeneration, function (test, onComplete) {\n    var run = test.runId();\n    var coll = new Mongo.Collection(\"livedata_update_result_\"+run, collectionOptions);\n\n    coll.insert({ foo: \"bar\" });\n    coll.insert({ foo: \"baz\" });\n    test.equal(coll.update({}, { $set: { foo: \"qux\" } }, { multi: true }),\n               2);\n    coll.update({}, { $set: { foo: \"quux\" } }, { multi: true }, function (err, result) {\n      test.isFalse(err);\n      test.equal(result, 2);\n      onComplete();\n    });\n  });\n\n  Tinytest.addAsync(\"mongo-livedata - remove return values, \" + idGeneration, function (test, onComplete) {\n    var run = test.runId();\n    var coll = new Mongo.Collection(\"livedata_update_result_\"+run, collectionOptions);\n\n    coll.insert({ foo: \"bar\" });\n    coll.insert({ foo: \"baz\" });\n    test.equal(coll.remove({}), 2);\n    coll.insert({ foo: \"bar\" });\n    coll.insert({ foo: \"baz\" });\n    coll.remove({}, function (err, result) {\n      test.isFalse(err);\n      test.equal(result, 2);\n      onComplete();\n    });\n  });\n\n\n  Tinytest.addAsync(\"mongo-livedata - id-based invalidation, \" + idGeneration, function (test, onComplete) {\n    var run = test.runId();\n    var coll = new Mongo.Collection(\"livedata_invalidation_collection_\"+run, collectionOptions);\n\n    coll.allow({\n      update: function () {return true;},\n      remove: function () {return true;}\n    });\n\n    var id1 = coll.insert({x: 42, is1: true});\n    var id2 = coll.insert({x: 50, is2: true});\n\n    var polls = {};\n    var handlesToStop = [];\n    var observe = function (name, query) {\n      var handle = coll.find(query).observeChanges({\n        // Make sure that we only poll on invalidation, not due to time, and\n        // keep track of when we do. Note: this option disables the use of\n        // oplogs (which admittedly is somewhat irrelevant to this feature).\n        _testOnlyPollCallback: function () {\n          polls[name] = (name in polls ? polls[name] + 1 : 1);\n        }\n      });\n      handlesToStop.push(handle);\n    };\n\n    observe(\"all\", {});\n    observe(\"id1Direct\", id1);\n    observe(\"id1InQuery\", {_id: id1, z: null});\n    observe(\"id2Direct\", id2);\n    observe(\"id2InQuery\", {_id: id2, z: null});\n    observe(\"bothIds\", {_id: {$in: [id1, id2]}});\n\n    var resetPollsAndRunInFence = function (f) {\n      polls = {};\n      runInFence(f);\n    };\n\n    // Update id1 directly. This should poll all but the \"id2\" queries. \"all\"\n    // and \"bothIds\" increment by 2 because they are looking at both.\n    resetPollsAndRunInFence(function () {\n      coll.update(id1, {$inc: {x: 1}});\n    });\n    test.equal(\n      polls,\n      {all: 1, id1Direct: 1, id1InQuery: 1, bothIds: 1});\n\n    // Update id2 using a funny query. This should poll all but the \"id1\"\n    // queries.\n    resetPollsAndRunInFence(function () {\n      coll.update({_id: id2, q: null}, {$inc: {x: 1}});\n    });\n    test.equal(\n      polls,\n      {all: 1, id2Direct: 1, id2InQuery: 1, bothIds: 1});\n\n    // Update both using a $in query. Should poll each of them exactly once.\n    resetPollsAndRunInFence(function () {\n      coll.update({_id: {$in: [id1, id2]}, q: null}, {$inc: {x: 1}});\n    });\n    test.equal(\n      polls,\n      {all: 1, id1Direct: 1, id1InQuery: 1, id2Direct: 1, id2InQuery: 1,\n       bothIds: 1});\n\n    _.each(handlesToStop, function (h) {h.stop();});\n    onComplete();\n  });\n\n  Tinytest.add(\"mongo-livedata - upsert error parse, \" + idGeneration, function (test) {\n    var run = test.runId();\n    var coll = new Mongo.Collection(\"livedata_upsert_errorparse_collection_\"+run, collectionOptions);\n\n    coll.insert({_id: 'foobar'});\n    var err;\n    try {\n      coll.update({_id: 'foobar'}, {_id: 'cowbar'});\n    } catch (e) {\n      err = e;\n    }\n    test.isTrue(err);\n    test.isTrue(MongoInternals.Connection._isCannotChangeIdError(err));\n\n    try {\n      coll.insert({_id: 'foobar'});\n    } catch (e) {\n      err = e;\n    }\n    test.isTrue(err);\n    // duplicate id error is not same as change id error\n    test.isFalse(MongoInternals.Connection._isCannotChangeIdError(err));\n  });\n\n} // end Meteor.isServer\n\n// This test is duplicated below (with some changes) for async upserts that go\n// over the network.\n_.each(Meteor.isServer ? [true, false] : [true], function (minimongo) {\n  _.each([true, false], function (useUpdate) {\n    _.each([true, false], function (useDirectCollection) {\n      Tinytest.add(\"mongo-livedata - \" + (useUpdate ? \"update \" : \"\") + \"upsert\" + (minimongo ? \" minimongo\" : \"\") + (useDirectCollection ? \" direct collection \" : \"\") + \", \" + idGeneration, function (test) {\n        var run = test.runId();\n        var options = collectionOptions;\n        // We don't get ids back when we use update() to upsert, or when we are\n        // directly calling MongoConnection.upsert().\n        var skipIds = useUpdate || (! minimongo && useDirectCollection);\n        if (minimongo)\n          options = _.extend({}, collectionOptions, { connection: null });\n        var coll = new Mongo.Collection(\n          \"livedata_upsert_collection_\"+run+\n            (useUpdate ? \"_update_\" : \"\") +\n            (minimongo ? \"_minimongo_\" : \"\") +\n            (useDirectCollection ? \"_direct_\" : \"\") + \"\",\n          options\n        );\n        if (useDirectCollection)\n          coll = coll._collection;\n\n        var result1 = upsert(coll, useUpdate, {foo: 'bar'}, {foo: 'bar'});\n        test.equal(result1.numberAffected, 1);\n        if (! skipIds)\n          test.isTrue(result1.insertedId);\n        compareResults(test, skipIds, coll.find().fetch(), [{foo: 'bar', _id: result1.insertedId}]);\n\n        var result2 = upsert(coll, useUpdate, {foo: 'bar'}, {foo: 'baz'});\n        test.equal(result2.numberAffected, 1);\n        if (! skipIds)\n          test.isFalse(result2.insertedId);\n        compareResults(test, skipIds, coll.find().fetch(), [{foo: 'baz', _id: result1.insertedId}]);\n\n        coll.remove({});\n\n        // Test values that require transformation to go into Mongo:\n\n        var t1 = new Mongo.ObjectID();\n        var t2 = new Mongo.ObjectID();\n        var result3 = upsert(coll, useUpdate, {foo: t1}, {foo: t1});\n        test.equal(result3.numberAffected, 1);\n        if (! skipIds)\n          test.isTrue(result3.insertedId);\n        compareResults(test, skipIds, coll.find().fetch(), [{foo: t1, _id: result3.insertedId}]);\n\n        var result4 = upsert(coll, useUpdate, {foo: t1}, {foo: t2});\n        test.equal(result2.numberAffected, 1);\n        if (! skipIds)\n          test.isFalse(result2.insertedId);\n        compareResults(test, skipIds, coll.find().fetch(), [{foo: t2, _id: result3.insertedId}]);\n\n        coll.remove({});\n\n        // Test modification by upsert\n\n        var result5 = upsert(coll, useUpdate, {name: 'David'}, {$set: {foo: 1}});\n        test.equal(result5.numberAffected, 1);\n        if (! skipIds)\n          test.isTrue(result5.insertedId);\n        var davidId = result5.insertedId;\n        compareResults(test, skipIds, coll.find().fetch(), [{name: 'David', foo: 1, _id: davidId}]);\n\n        test.throws(function () {\n          // test that bad modifier fails fast\n          upsert(coll, useUpdate, {name: 'David'}, {$blah: {foo: 2}});\n        });\n\n\n        var result6 = upsert(coll, useUpdate, {name: 'David'}, {$set: {foo: 2}});\n        test.equal(result6.numberAffected, 1);\n        if (! skipIds)\n          test.isFalse(result6.insertedId);\n        compareResults(test, skipIds, coll.find().fetch(), [{name: 'David', foo: 2,\n                                                               _id: result5.insertedId}]);\n\n        var emilyId = coll.insert({name: 'Emily', foo: 2});\n        compareResults(test, skipIds, coll.find().fetch(), [{name: 'David', foo: 2, _id: davidId},\n                                                              {name: 'Emily', foo: 2, _id: emilyId}]);\n\n        // multi update by upsert\n        var result7 = upsert(coll, useUpdate, {foo: 2},\n                             {$set: {bar: 7},\n                              $setOnInsert: {name: 'Fred', foo: 2}},\n                             {multi: true});\n        test.equal(result7.numberAffected, 2);\n        if (! skipIds)\n          test.isFalse(result7.insertedId);\n        compareResults(test, skipIds, coll.find().fetch(), [{name: 'David', foo: 2, bar: 7, _id: davidId},\n                                                              {name: 'Emily', foo: 2, bar: 7, _id: emilyId}]);\n\n        // insert by multi upsert\n        var result8 = upsert(coll, useUpdate, {foo: 3},\n                             {$set: {bar: 7},\n                              $setOnInsert: {name: 'Fred', foo: 2}},\n                             {multi: true});\n        test.equal(result8.numberAffected, 1);\n        if (! skipIds)\n          test.isTrue(result8.insertedId);\n        var fredId = result8.insertedId;\n        compareResults(test, skipIds, coll.find().fetch(),\n                       [{name: 'David', foo: 2, bar: 7, _id: davidId},\n                        {name: 'Emily', foo: 2, bar: 7, _id: emilyId},\n                        {name: 'Fred', foo: 2, bar: 7, _id: fredId}]);\n\n        // test `insertedId` option\n        var result9 = upsert(coll, useUpdate, {name: 'Steve'},\n                             {name: 'Steve'},\n                             {insertedId: 'steve'});\n        test.equal(result9.numberAffected, 1);\n        if (! skipIds)\n          test.equal(result9.insertedId, 'steve');\n        compareResults(test, skipIds, coll.find().fetch(),\n                       [{name: 'David', foo: 2, bar: 7, _id: davidId},\n                        {name: 'Emily', foo: 2, bar: 7, _id: emilyId},\n                        {name: 'Fred', foo: 2, bar: 7, _id: fredId},\n                        {name: 'Steve', _id: 'steve'}]);\n        test.isTrue(coll.findOne('steve'));\n        test.isFalse(coll.findOne('fred'));\n\n        // Test $ operator in selectors.\n\n        var result10 = upsert(coll, useUpdate,\n                              {$or: [{name: 'David'}, {name: 'Emily'}]},\n                              {$set: {foo: 3}}, {multi: true});\n        test.equal(result10.numberAffected, 2);\n        if (! skipIds)\n          test.isFalse(result10.insertedId);\n        compareResults(test, skipIds,\n                       [coll.findOne({name: 'David'}), coll.findOne({name: 'Emily'})],\n                       [{name: 'David', foo: 3, bar: 7, _id: davidId},\n                        {name: 'Emily', foo: 3, bar: 7, _id: emilyId}]\n                      );\n\n        var result11 = upsert(\n          coll, useUpdate,\n          {\n            name: 'Charlie',\n            $or: [{ foo: 2}, { bar: 7 }]\n          },\n          { $set: { foo: 3 } }\n        );\n        test.equal(result11.numberAffected, 1);\n        if (! skipIds)\n          test.isTrue(result11.insertedId);\n        var charlieId = result11.insertedId;\n        compareResults(test, skipIds,\n                       coll.find({ name: 'Charlie' }).fetch(),\n                       [{name: 'Charlie', foo: 3, _id: charlieId}]);\n      });\n    });\n  });\n});\n\nvar asyncUpsertTestName = function (useNetwork, useDirectCollection,\n                                    useUpdate, idGeneration) {\n  return \"mongo-livedata - async \" +\n    (useUpdate ? \"update \" : \"\") +\n    \"upsert \" +\n    (useNetwork ? \"over network \" : \"\") +\n    (useDirectCollection ? \", direct collection \" : \"\") +\n    idGeneration;\n};\n\n// This is a duplicate of the test above, with some changes to make it work for\n// callback style. On the client, we test server-backed and in-memory\n// collections, and run the tests for both the Mongo.Collection and the\n// LocalCollection. On the server, we test mongo-backed collections, for both\n// the Mongo.Collection and the MongoConnection.\n//\n// XXX Rewrite with testAsyncMulti, that would simplify things a lot!\n_.each(Meteor.isServer ? [false] : [true, false], function (useNetwork) {\n  _.each(useNetwork ? [false] : [true, false], function (useDirectCollection) {\n    _.each([true, false], function (useUpdate) {\n      Tinytest.addAsync(asyncUpsertTestName(useNetwork, useDirectCollection, useUpdate, idGeneration), function (test, onComplete) {\n        var coll;\n        var run = test.runId();\n        var collName = \"livedata_upsert_collection_\"+run+\n              (useUpdate ? \"_update_\" : \"\") +\n              (useNetwork ? \"_network_\" : \"\") +\n              (useDirectCollection ? \"_direct_\" : \"\");\n\n        var next0 = function () {\n          // Test starts here.\n          upsert(coll, useUpdate, {_id: 'foo'}, {_id: 'foo', foo: 'bar'}, next1);\n        };\n\n        if (useNetwork) {\n          Meteor.call(\"createInsecureCollection\", collName, collectionOptions);\n          coll = new Mongo.Collection(collName, collectionOptions);\n          Meteor.subscribe(\"c-\" + collName, next0);\n        } else {\n          var opts = _.clone(collectionOptions);\n          if (Meteor.isClient)\n            opts.connection = null;\n          coll = new Mongo.Collection(collName, opts);\n          if (useDirectCollection)\n            coll = coll._collection;\n        }\n\n        var result1;\n        var next1 = function (err, result) {\n          result1 = result;\n          test.equal(result1.numberAffected, 1);\n          if (! useUpdate) {\n            test.isTrue(result1.insertedId);\n            test.equal(result1.insertedId, 'foo');\n          }\n          compareResults(test, useUpdate, coll.find().fetch(), [{foo: 'bar', _id: 'foo'}]);\n          upsert(coll, useUpdate, {_id: 'foo'}, {foo: 'baz'}, next2);\n        };\n\n        if (! useNetwork) {\n          next0();\n        }\n\n        var t1, t2, result2;\n        var next2 = function (err, result) {\n          result2 = result;\n          test.equal(result2.numberAffected, 1);\n          if (! useUpdate)\n            test.isFalse(result2.insertedId);\n          compareResults(test, useUpdate, coll.find().fetch(), [{foo: 'baz', _id: result1.insertedId}]);\n          coll.remove({_id: 'foo'});\n          compareResults(test, useUpdate, coll.find().fetch(), []);\n\n          // Test values that require transformation to go into Mongo:\n\n          t1 = new Mongo.ObjectID();\n          t2 = new Mongo.ObjectID();\n          upsert(coll, useUpdate, {_id: t1}, {_id: t1, foo: 'bar'}, next3);\n        };\n\n        var result3;\n        var next3 = function (err, result) {\n          result3 = result;\n          test.equal(result3.numberAffected, 1);\n          if (! useUpdate) {\n            test.isTrue(result3.insertedId);\n            test.equal(t1, result3.insertedId);\n          }\n          compareResults(test, useUpdate, coll.find().fetch(), [{_id: t1, foo: 'bar'}]);\n\n          upsert(coll, useUpdate, {_id: t1}, {foo: t2}, next4);\n        };\n\n        var next4 = function (err, result4) {\n          test.equal(result2.numberAffected, 1);\n          if (! useUpdate)\n            test.isFalse(result2.insertedId);\n          compareResults(test, useUpdate, coll.find().fetch(), [{foo: t2, _id: result3.insertedId}]);\n\n          coll.remove({_id: t1});\n\n          // Test modification by upsert\n          upsert(coll, useUpdate, {_id: 'David'}, {$set: {foo: 1}}, next5);\n        };\n\n        var result5;\n        var next5 = function (err, result) {\n          result5 = result;\n          test.equal(result5.numberAffected, 1);\n          if (! useUpdate) {\n            test.isTrue(result5.insertedId);\n            test.equal(result5.insertedId, 'David');\n          }\n          var davidId = result5.insertedId;\n          compareResults(test, useUpdate, coll.find().fetch(), [{foo: 1, _id: davidId}]);\n\n          if (! Meteor.isClient && useDirectCollection) {\n            // test that bad modifier fails\n            // The stub throws an exception about the invalid modifier, which\n            // livedata logs (so we suppress it).\n            Meteor._suppress_log(1);\n            upsert(coll, useUpdate, {_id: 'David'}, {$blah: {foo: 2}}, function (err) {\n              if (! (Meteor.isClient && useDirectCollection))\n                test.isTrue(err);\n              upsert(coll, useUpdate, {_id: 'David'}, {$set: {foo: 2}}, next6);\n            });\n          } else {\n            // XXX skip this test for now for LocalCollection; the fact that\n            // we're in a nested sequence of callbacks means we're inside a\n            // Meteor.defer, which means the exception just gets\n            // logged. Something should be done about this at some point?  Maybe\n            // LocalCollection callbacks don't really have to be deferred.\n            upsert(coll, useUpdate, {_id: 'David'}, {$set: {foo: 2}}, next6);\n          }\n        };\n\n        var result6;\n        var next6 = function (err, result) {\n          result6 = result;\n          test.equal(result6.numberAffected, 1);\n          if (! useUpdate)\n            test.isFalse(result6.insertedId);\n          compareResults(test, useUpdate, coll.find().fetch(), [{_id: 'David', foo: 2}]);\n\n          var emilyId = coll.insert({_id: 'Emily', foo: 2});\n          compareResults(test, useUpdate, coll.find().fetch(), [{_id: 'David', foo: 2},\n                                                                {_id: 'Emily', foo: 2}]);\n\n          // multi update by upsert.\n          // We can't actually update multiple documents since we have to do it by\n          // id, but at least make sure the multi flag doesn't mess anything up.\n          upsert(coll, useUpdate, {_id: 'Emily'},\n                 {$set: {bar: 7},\n                  $setOnInsert: {name: 'Fred', foo: 2}},\n                 {multi: true}, next7);\n        };\n\n        var result7;\n        var next7 = function (err, result) {\n          result7 = result;\n          test.equal(result7.numberAffected, 1);\n          if (! useUpdate)\n            test.isFalse(result7.insertedId);\n          compareResults(test, useUpdate, coll.find().fetch(), [{_id: 'David', foo: 2},\n                                                                {_id: 'Emily', foo: 2, bar: 7}]);\n\n          // insert by multi upsert\n          upsert(coll, useUpdate, {_id: 'Fred'},\n                 {$set: {bar: 7},\n                  $setOnInsert: {name: 'Fred', foo: 2}},\n                 {multi: true}, next8);\n\n        };\n\n        var result8;\n        var next8 = function (err, result) {\n          result8 = result;\n\n          test.equal(result8.numberAffected, 1);\n          if (! useUpdate) {\n            test.isTrue(result8.insertedId);\n            test.equal(result8.insertedId, 'Fred');\n          }\n          var fredId = result8.insertedId;\n          compareResults(test, useUpdate,  coll.find().fetch(),\n                         [{_id: 'David', foo: 2},\n                          {_id: 'Emily', foo: 2, bar: 7},\n                          {name: 'Fred', foo: 2, bar: 7, _id: fredId}]);\n          onComplete();\n        };\n      });\n    });\n  });\n});\n\nif (Meteor.isClient) {\n  Tinytest.addAsync(\"mongo-livedata - async update/remove return values over network \" + idGeneration, function (test, onComplete) {\n    var coll;\n    var run = test.runId();\n    var collName = \"livedata_upsert_collection_\"+run;\n    Meteor.call(\"createInsecureCollection\", collName, collectionOptions);\n    coll = new Mongo.Collection(collName, collectionOptions);\n    Meteor.subscribe(\"c-\" + collName, function () {\n      coll.insert({ _id: \"foo\" });\n      coll.insert({ _id: \"bar\" });\n      coll.update({ _id: \"foo\" }, { $set: { foo: 1 } }, { multi: true }, function (err, result) {\n        test.isFalse(err);\n        test.equal(result, 1);\n        coll.update({ _id: \"foo\" }, { _id: \"foo\", foo: 2 }, function (err, result) {\n          test.isFalse(err);\n          test.equal(result, 1);\n          coll.update({ _id: \"baz\" }, { $set: { foo: 1 } }, function (err, result) {\n            test.isFalse(err);\n            test.equal(result, 0);\n            coll.remove({ _id: \"foo\" }, function (err, result) {\n              test.equal(result, 1);\n              coll.remove({ _id: \"baz\" }, function (err, result) {\n                test.equal(result, 0);\n                onComplete();\n              });\n            });\n          });\n        });\n      });\n    });\n  });\n}\n\n// Runs a method and its stub which do some upserts. The method throws an error\n// if we don't get the right return values.\nif (Meteor.isClient) {\n  _.each([true, false], function (useUpdate) {\n    Tinytest.addAsync(\"mongo-livedata - \" + (useUpdate ? \"update \" : \"\") + \"upsert in method, \" + idGeneration, function (test, onComplete) {\n      var run = test.runId();\n      upsertTestMethodColl = new Mongo.Collection(upsertTestMethod + \"_collection_\" + run, collectionOptions);\n      var m = {};\n      delete Meteor.connection._methodHandlers[upsertTestMethod];\n      m[upsertTestMethod] = function (run, useUpdate, options) {\n        upsertTestMethodImpl(upsertTestMethodColl, useUpdate, test);\n      };\n      Meteor.methods(m);\n      Meteor.call(upsertTestMethod, run, useUpdate, collectionOptions, function (err, result) {\n        test.isFalse(err);\n        onComplete();\n      });\n    });\n  });\n}\n\n_.each(Meteor.isServer ? [true, false] : [true], function (minimongo) {\n  _.each([true, false], function (useUpdate) {\n    Tinytest.add(\"mongo-livedata - \" + (useUpdate ? \"update \" : \"\") + \"upsert by id\" + (minimongo ? \" minimongo\" : \"\") + \", \" + idGeneration, function (test) {\n      var run = test.runId();\n      var options = collectionOptions;\n      if (minimongo)\n        options = _.extend({}, collectionOptions, { connection: null });\n      var coll = new Mongo.Collection(\"livedata_upsert_by_id_collection_\"+run, options);\n\n      var ret;\n      ret = upsert(coll, useUpdate, {_id: 'foo'}, {$set: {x: 1}});\n      test.equal(ret.numberAffected, 1);\n      if (! useUpdate)\n        test.equal(ret.insertedId, 'foo');\n      compareResults(test, useUpdate, coll.find().fetch(),\n                     [{_id: 'foo', x: 1}]);\n\n      ret = upsert(coll, useUpdate, {_id: 'foo'}, {$set: {x: 2}});\n      test.equal(ret.numberAffected, 1);\n      if (! useUpdate)\n        test.isFalse(ret.insertedId);\n      compareResults(test, useUpdate, coll.find().fetch(),\n                     [{_id: 'foo', x: 2}]);\n\n      ret = upsert(coll, useUpdate, {_id: 'bar'}, {$set: {x: 1}});\n      test.equal(ret.numberAffected, 1);\n      if (! useUpdate)\n        test.equal(ret.insertedId, 'bar');\n      compareResults(test, useUpdate, coll.find().fetch(),\n                     [{_id: 'foo', x: 2},\n                      {_id: 'bar', x: 1}]);\n\n      coll.remove({});\n      ret = upsert(coll, useUpdate, {_id: 'traq'}, {x: 1});\n\n      test.equal(ret.numberAffected, 1);\n      var myId = ret.insertedId;\n      if (useUpdate) {\n        myId = coll.findOne()._id;\n      }\n      // Starting with Mongo 2.6, upsert with entire document takes _id from the\n      // query, so the above upsert actually does an insert with _id traq\n      // instead of a random _id.  Whenever we are using our simulated upsert,\n      // we have this behavior (whether running against Mongo 2.4 or 2.6).\n      // https://jira.mongodb.org/browse/SERVER-5289\n      test.equal(myId, 'traq');\n      compareResults(test, useUpdate, coll.find().fetch(),\n                     [{x: 1, _id: 'traq'}]);\n\n      // this time, insert as _id 'traz'\n      ret = upsert(coll, useUpdate, {_id: 'traz'}, {_id: 'traz', x: 2});\n      test.equal(ret.numberAffected, 1);\n      if (! useUpdate)\n        test.equal(ret.insertedId, 'traz');\n      compareResults(test, useUpdate, coll.find().fetch(),\n                     [{x: 1, _id: 'traq'},\n                      {x: 2, _id: 'traz'}]);\n\n      // now update _id 'traz'\n      ret = upsert(coll, useUpdate, {_id: 'traz'}, {x: 3});\n      test.equal(ret.numberAffected, 1);\n      test.isFalse(ret.insertedId);\n      compareResults(test, useUpdate, coll.find().fetch(),\n                     [{x: 1, _id: 'traq'},\n                      {x: 3, _id: 'traz'}]);\n\n      // now update, passing _id (which is ok as long as it's the same)\n      ret = upsert(coll, useUpdate, {_id: 'traz'}, {_id: 'traz', x: 4});\n      test.equal(ret.numberAffected, 1);\n      test.isFalse(ret.insertedId);\n      compareResults(test, useUpdate, coll.find().fetch(),\n                     [{x: 1, _id: 'traq'},\n                      {x: 4, _id: 'traz'}]);\n\n    });\n  });\n});\n\n});  // end idGeneration parametrization\n\nTinytest.add('mongo-livedata - rewrite selector', function (test) {\n  test.equal(Mongo.Collection._rewriteSelector({x: /^o+B/im}),\n             {x: {$regex: '^o+B', $options: 'im'}});\n  test.equal(Mongo.Collection._rewriteSelector({x: {$regex: /^o+B/im}}),\n             {x: {$regex: '^o+B', $options: 'im'}});\n  test.equal(Mongo.Collection._rewriteSelector({x: /^o+B/}),\n             {x: {$regex: '^o+B'}});\n  test.equal(Mongo.Collection._rewriteSelector({x: {$regex: /^o+B/}}),\n             {x: {$regex: '^o+B'}});\n  test.equal(Mongo.Collection._rewriteSelector('foo'),\n             {_id: 'foo'});\n\n  test.equal(\n    Mongo.Collection._rewriteSelector(\n      {'$or': [\n        {x: /^o/},\n        {y: /^p/},\n        {z: 'q'},\n        {w: {$regex: /^r/}}\n      ]}\n    ),\n    {'$or': [\n      {x: {$regex: '^o'}},\n      {y: {$regex: '^p'}},\n      {z: 'q'},\n      {w: {$regex: '^r'}}\n    ]}\n  );\n\n  test.equal(\n    Mongo.Collection._rewriteSelector(\n      {'$or': [\n        {'$and': [\n          {x: /^a/i},\n          {y: /^b/},\n          {z: {$regex: /^c/i}},\n          {w: {$regex: '^[abc]', $options: 'i'}}, // make sure we don't break vanilla selectors\n          {v: {$regex: /O/, $options: 'i'}}, // $options should override the ones on the RegExp object\n          {u: {$regex: /O/m, $options: 'i'}} // $options should override the ones on the RegExp object\n        ]},\n        {'$nor': [\n          {s: /^d/},\n          {t: /^e/i},\n          {u: {$regex: /^f/i}},\n          // even empty string overrides built-in flags\n          {v: {$regex: /^g/i, $options: ''}}\n        ]}\n      ]}\n    ),\n    {'$or': [\n      {'$and': [\n        {x: {$regex: '^a', $options: 'i'}},\n        {y: {$regex: '^b'}},\n        {z: {$regex: '^c', $options: 'i'}},\n        {w: {$regex: '^[abc]', $options: 'i'}},\n        {v: {$regex: 'O', $options: 'i'}},\n        {u: {$regex: 'O', $options: 'i'}}\n      ]},\n      {'$nor': [\n        {s: {$regex: '^d'}},\n        {t: {$regex: '^e', $options: 'i'}},\n        {u: {$regex: '^f', $options: 'i'}},\n        {v: {$regex: '^g', $options: ''}}\n      ]}\n    ]}\n  );\n\n  var oid = new Mongo.ObjectID();\n  test.equal(Mongo.Collection._rewriteSelector(oid),\n             {_id: oid});\n});\n\ntestAsyncMulti('mongo-livedata - specified _id', [\n  function (test, expect) {\n    this.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', this.collectionName);\n      Meteor.subscribe('c-' + this.collectionName, expect());\n    }\n  }, function (test, expect) {\n    var expectError = expect(function (err, result) {\n      test.isTrue(err);\n      var doc = coll.findOne();\n      test.equal(doc.name, \"foo\");\n    });\n    var coll = new Mongo.Collection(this.collectionName);\n    coll.insert({_id: \"foo\", name: \"foo\"}, expect(function (err1, id) {\n      test.equal(id, \"foo\");\n      var doc = coll.findOne();\n      test.equal(doc._id, \"foo\");\n      Meteor._suppress_log(1);\n      coll.insert({_id: \"foo\", name: \"bar\"}, expectError);\n    }));\n  }\n]);\n\n\n// Consistent id generation tests\nfunction collectionInsert (test, expect, coll, index) {\n  var clientSideId = coll.insert({name: \"foo\"}, expect(function (err1, id) {\n    test.equal(id, clientSideId);\n    var o = coll.findOne(id);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\nfunction collectionUpsert (test, expect, coll, index) {\n  var upsertId = '123456' + index;\n\n  coll.upsert(upsertId, {$set: {name: \"foo\"}}, expect(function (err1, result) {\n    test.equal(result.insertedId, upsertId);\n    test.equal(result.numberAffected, 1);\n\n    var o = coll.findOne(upsertId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\nfunction collectionUpsertExisting (test, expect, coll, index) {\n  var clientSideId = coll.insert({name: \"foo\"}, expect(function (err1, id) {\n    test.equal(id, clientSideId);\n\n    var o = coll.findOne(id);\n    test.isTrue(_.isObject(o));\n    // We're not testing sequencing/visibility rules here, so skip this check\n    // test.equal(o.name, 'foo');\n  }));\n\n  coll.upsert(clientSideId, {$set: {name: \"bar\"}}, expect(function (err1, result) {\n    test.equal(result.insertedId, clientSideId);\n    test.equal(result.numberAffected, 1);\n\n    var o = coll.findOne(clientSideId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'bar');\n  }));\n};\n\nfunction functionCallsInsert (test, expect, coll, index) {\n  Meteor.call(\"insertObjects\", coll._name, {name: \"foo\"}, 1, expect(function (err1, ids) {\n    test.notEqual((INSERTED_IDS[coll._name] || []).length, 0);\n    var stubId = INSERTED_IDS[coll._name][index];\n\n    test.equal(ids.length, 1);\n    test.equal(ids[0], stubId);\n\n    var o = coll.findOne(stubId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\nfunction functionCallsUpsert (test, expect, coll, index) {\n  var upsertId = '123456' + index;\n  Meteor.call(\"upsertObject\", coll._name, upsertId, {$set:{name: \"foo\"}}, expect(function (err1, result) {\n    test.equal(result.insertedId, upsertId);\n    test.equal(result.numberAffected, 1);\n\n    var o = coll.findOne(upsertId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\nfunction functionCallsUpsertExisting (test, expect, coll, index) {\n  var id = coll.insert({name: \"foo\"});\n\n  var o = coll.findOne(id);\n  test.notEqual(null, o);\n  test.equal(o.name, 'foo');\n\n  Meteor.call(\"upsertObject\", coll._name, id, {$set:{name: \"bar\"}}, expect(function (err1, result) {\n    test.equal(result.numberAffected, 1);\n    test.equal(result.insertedId, undefined);\n\n    var o = coll.findOne(id);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'bar');\n  }));\n};\n\nfunction functionCalls3Inserts (test, expect, coll, index) {\n  Meteor.call(\"insertObjects\", coll._name, {name: \"foo\"}, 3, expect(function (err1, ids) {\n    test.notEqual((INSERTED_IDS[coll._name] || []).length, 0);\n    test.equal(ids.length, 3);\n\n    for (var i = 0; i < 3; i++) {\n      var stubId = INSERTED_IDS[coll._name][(3 * index) + i];\n      test.equal(ids[i], stubId);\n\n      var o = coll.findOne(stubId);\n      test.isTrue(_.isObject(o));\n      test.equal(o.name, 'foo');\n    }\n  }));\n};\n\nfunction functionChainInsert (test, expect, coll, index) {\n  Meteor.call(\"doMeteorCall\", \"insertObjects\", coll._name, {name: \"foo\"}, 1, expect(function (err1, ids) {\n    test.notEqual((INSERTED_IDS[coll._name] || []).length, 0);\n    var stubId = INSERTED_IDS[coll._name][index];\n\n    test.equal(ids.length, 1);\n    test.equal(ids[0], stubId);\n\n    var o = coll.findOne(stubId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\nfunction functionChain2Insert (test, expect, coll, index) {\n  Meteor.call(\"doMeteorCall\", \"doMeteorCall\", \"insertObjects\", coll._name, {name: \"foo\"}, 1, expect(function (err1, ids) {\n    test.notEqual((INSERTED_IDS[coll._name] || []).length, 0);\n    var stubId = INSERTED_IDS[coll._name][index];\n\n    test.equal(ids.length, 1);\n    test.equal(ids[0], stubId);\n\n    var o = coll.findOne(stubId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\nfunction functionChain2Upsert (test, expect, coll, index) {\n  var upsertId = '123456' + index;\n  Meteor.call(\"doMeteorCall\", \"doMeteorCall\", \"upsertObject\", coll._name, upsertId, {$set:{name: \"foo\"}}, expect(function (err1, result) {\n    test.equal(result.insertedId, upsertId);\n    test.equal(result.numberAffected, 1);\n\n    var o = coll.findOne(upsertId);\n    test.isTrue(_.isObject(o));\n    test.equal(o.name, 'foo');\n  }));\n};\n\n_.each( {collectionInsert: collectionInsert,\n         collectionUpsert: collectionUpsert,\n         functionCallsInsert: functionCallsInsert,\n         functionCallsUpsert: functionCallsUpsert,\n         functionCallsUpsertExisting: functionCallsUpsertExisting,\n         functionCalls3Insert: functionCalls3Inserts,\n         functionChainInsert: functionChainInsert,\n         functionChain2Insert: functionChain2Insert,\n         functionChain2Upsert: functionChain2Upsert}, function (fn, name) {\n_.each( [1, 3], function (repetitions) {\n_.each( [1, 3], function (collectionCount) {\n_.each( ['STRING', 'MONGO'], function (idGeneration) {\n\n  testAsyncMulti('mongo-livedata - consistent _id generation ' + name + ', ' + repetitions + ' repetitions on ' + collectionCount + ' collections, idGeneration=' + idGeneration, [ function (test, expect) {\n    var collectionOptions = { idGeneration: idGeneration };\n\n    var cleanups = this.cleanups = [];\n    this.collections = _.times(collectionCount, function () {\n      var collectionName = \"consistentid_\" + Random.id();\n      if (Meteor.isClient) {\n        Meteor.call('createInsecureCollection', collectionName, collectionOptions);\n        Meteor.subscribe('c-' + collectionName, expect());\n        cleanups.push(function (expect) { Meteor.call('dropInsecureCollection', collectionName, expect(function () {})); });\n      }\n\n      var collection = new Mongo.Collection(collectionName, collectionOptions);\n      if (Meteor.isServer) {\n        cleanups.push(function () { collection._dropCollection(); });\n      }\n      COLLECTIONS[collectionName] = collection;\n      return collection;\n    });\n  }, function (test, expect) {\n    // now run the actual test\n    for (var i = 0; i < repetitions; i++) {\n      for (var j = 0; j < collectionCount; j++) {\n        fn(test, expect, this.collections[j], i);\n      }\n    }\n  }, function (test, expect) {\n    // Run any registered cleanup functions (e.g. to drop collections)\n    _.each(this.cleanups, function(cleanup) {\n      cleanup(expect);\n    });\n  }]);\n\n});\n});\n});\n});\n\n\n\ntestAsyncMulti('mongo-livedata - empty string _id', [\n  function (test, expect) {\n    var self = this;\n    self.collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', self.collectionName);\n      Meteor.subscribe('c-' + self.collectionName, expect());\n    }\n    self.coll = new Mongo.Collection(self.collectionName);\n    try {\n      self.coll.insert({_id: \"\", f: \"foo\"});\n      test.fail(\"Insert with an empty _id should fail\");\n    } catch (e) {\n      // ok\n    }\n    self.coll.insert({_id: \"realid\", f: \"bar\"}, expect(function (err, res) {\n      test.equal(res, \"realid\");\n    }));\n  },\n  function (test, expect) {\n    var self = this;\n    var docs = self.coll.find().fetch();\n    test.equal(docs, [{_id: \"realid\", f: \"bar\"}]);\n  },\n  function (test, expect) {\n    var self = this;\n    if (Meteor.isServer) {\n      self.coll._collection.insert({_id: \"\", f: \"baz\"});\n      test.equal(self.coll.find().fetch().length, 2);\n    }\n  }\n]);\n\n\nif (Meteor.isServer) {\n\n  testAsyncMulti(\"mongo-livedata - minimongo on server to server connection\", [\n    function (test, expect) {\n      var self = this;\n      Meteor._debug(\"connection setup\");\n      self.id = Random.id();\n      var C = self.C = new Mongo.Collection(\"ServerMinimongo_\" + self.id);\n      C.allow({\n        insert: function () {return true;},\n        update: function () {return true;},\n        remove: function () {return true;}\n      });\n      C.insert({a: 0, b: 1});\n      C.insert({a: 0, b: 2});\n      C.insert({a: 1, b: 3});\n      Meteor.publish(self.id, function () {\n        return C.find({a: 0});\n      });\n\n      self.conn = DDP.connect(Meteor.absoluteUrl());\n      pollUntil(expect, function () {\n        return self.conn.status().connected;\n      }, 10000);\n    },\n\n    function (test, expect) {\n      var self = this;\n      if (self.conn.status().connected) {\n        self.miniC = new Mongo.Collection(\"ServerMinimongo_\" + self.id, {\n          connection: self.conn\n        });\n        var exp = expect(function (err) {\n          test.isFalse(err);\n        });\n        self.conn.subscribe(self.id, {\n          onError: exp,\n          onReady: exp\n        });\n      }\n    },\n\n    function (test, expect) {\n      var self = this;\n      if (self.miniC) {\n        var contents = self.miniC.find().fetch();\n        test.equal(contents.length, 2);\n        test.equal(contents[0].a, 0);\n      }\n    },\n\n    function (test, expect) {\n      var self = this;\n      if (!self.miniC)\n        return;\n      self.miniC.insert({a:0, b:3});\n      var contents = self.miniC.find({b:3}).fetch();\n      test.equal(contents.length, 1);\n      test.equal(contents[0].a, 0);\n    }\n  ]);\n\n  testAsyncMulti(\"mongo-livedata - minimongo observe on server\", [\n    function (test, expect) {\n      var self = this;\n      self.id = Random.id();\n      self.C = new Mongo.Collection(\"ServerMinimongoObserve_\" + self.id);\n      self.events = [];\n\n      Meteor.publish(self.id, function () {\n        return self.C.find();\n      });\n\n      self.conn = DDP.connect(Meteor.absoluteUrl());\n      pollUntil(expect, function () {\n        return self.conn.status().connected;\n      }, 10000);\n    },\n\n    function (test, expect) {\n      var self = this;\n      if (self.conn.status().connected) {\n        self.miniC = new Mongo.Collection(\"ServerMinimongoObserve_\" + self.id, {\n          connection: self.conn\n        });\n        var exp = expect(function (err) {\n          test.isFalse(err);\n        });\n        self.conn.subscribe(self.id, {\n          onError: exp,\n          onReady: exp\n        });\n      }\n    },\n\n    function (test, expect) {\n      var self = this;\n      if (self.miniC) {\n        self.obs = self.miniC.find().observeChanges({\n          added: function (id, fields) {\n            self.events.push({evt: \"a\", id: id});\n            Meteor._sleepForMs(200);\n            self.events.push({evt: \"b\", id: id});\n          }\n        });\n        self.one = self.C.insert({});\n        self.two = self.C.insert({});\n        pollUntil(expect, function () {\n          return self.events.length === 4;\n        }, 10000);\n      }\n    },\n\n    function (test, expect) {\n      var self = this;\n      if (self.miniC) {\n        test.equal(self.events, [\n          {evt: \"a\", id: self.one},\n          {evt: \"b\", id: self.one},\n          {evt: \"a\", id: self.two},\n          {evt: \"b\", id: self.two}\n        ]);\n      }\n      self.obs && self.obs.stop();\n    }\n  ]);\n}\n\nTinytest.addAsync(\"mongo-livedata - local collections with different connections\", function (test, onComplete) {\n  var cname = Random.id();\n  var cname2 = Random.id();\n  var coll1 = new Mongo.Collection(cname);\n  var doc = { foo: \"bar\" };\n  var coll2 = new Mongo.Collection(cname2, { connection: null });\n  coll2.insert(doc, function (err, id) {\n    test.equal(coll1.find(doc).count(), 0);\n    test.equal(coll2.find(doc).count(), 1);\n    onComplete();\n  });\n});\n\nTinytest.addAsync(\"mongo-livedata - local collection with null connection, w/ callback\", function (test, onComplete) {\n  var cname = Random.id();\n  var coll1 = new Mongo.Collection(cname, { connection: null });\n  var doc = { foo: \"bar\" };\n  var docId = coll1.insert(doc, function (err, id) {\n    test.equal(docId, id);\n    test.equal(coll1.findOne(doc)._id, id);\n    onComplete();\n  });\n});\n\nTinytest.addAsync(\"mongo-livedata - local collection with null connection, w/o callback\", function (test, onComplete) {\n  var cname = Random.id();\n  var coll1 = new Mongo.Collection(cname, { connection: null });\n  var doc = { foo: \"bar\" };\n  var docId = coll1.insert(doc);\n  test.equal(coll1.findOne(doc)._id, docId);\n  onComplete();\n});\n\ntestAsyncMulti(\"mongo-livedata - update handles $push with $each correctly\", [\n  function (test, expect) {\n    var self = this;\n    var collectionName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', collectionName);\n      Meteor.subscribe('c-' + collectionName, expect());\n    }\n\n    self.collection = new Mongo.Collection(collectionName);\n\n    self.id = self.collection.insert(\n      {name: 'jens', elements: ['X', 'Y']}, expect(function (err, res) {\n        test.isFalse(err);\n        test.equal(self.id, res);\n        }));\n  },\n  function (test, expect) {\n    var self = this;\n    self.collection.update(self.id, {\n      $push: {\n        elements: {\n          $each: ['A', 'B', 'C'],\n          $slice: -4\n        }}}, expect(function (err, res) {\n          test.isFalse(err);\n          test.equal(\n            self.collection.findOne(self.id),\n            {_id: self.id, name: 'jens', elements: ['Y', 'A', 'B', 'C']});\n        }));\n  }\n]);\n\nif (Meteor.isServer) {\n  Tinytest.add(\"mongo-livedata - upsert handles $push with $each correctly\", function (test) {\n    var collection = new Mongo.Collection(Random.id());\n\n    var result = collection.upsert(\n      {name: 'jens'},\n      {$push: {\n        elements: {\n          $each: ['A', 'B', 'C'],\n          $slice: -4\n        }}});\n\n    test.equal(collection.findOne(result.insertedId),\n               {_id: result.insertedId,\n                name: 'jens',\n                elements: ['A', 'B', 'C']});\n\n    var id = collection.insert({name: \"david\", elements: ['X', 'Y']});\n    result = collection.upsert(\n      {name: 'david'},\n      {$push: {\n        elements: {\n          $each: ['A', 'B', 'C'],\n          $slice: -4\n        }}});\n\n    test.equal(collection.findOne(id),\n               {_id: id,\n                name: 'david',\n                elements: ['Y', 'A', 'B', 'C']});\n  });\n\n  Tinytest.add(\"mongo-livedata - upsert handles dotted selectors corrrectly\", function (test) {\n    var collection = new Mongo.Collection(Random.id());\n\n    var result1 = collection.upsert({\n      \"subdocument.a\": 1\n    }, {\n      $set: {message: \"upsert 1\"}\n    });\n\n    test.equal(collection.findOne(result1.insertedId),{\n      _id: result1.insertedId,\n      subdocument: {a: 1},\n      message: \"upsert 1\"\n    });\n\n    var result2 = collection.upsert({\n      \"subdocument.a\": 1\n    }, {\n      $set: {message: \"upsert 2\"}\n    });\n\n    test.equal(result2, {numberAffected: 1});\n\n    test.equal(collection.findOne(result1.insertedId),{\n      _id: result1.insertedId,\n      subdocument: {a: 1},\n      message: \"upsert 2\"\n    });\n\n    var result3 = collection.upsert({\n      \"subdocument.a.b\": 1,\n      \"subdocument.c\": 2\n    }, {\n      $set: {message: \"upsert3\"}\n    });\n\n    test.equal(collection.findOne(result3.insertedId),{\n      _id: result3.insertedId,\n      subdocument: {a: {b: 1}, c: 2},\n      message: \"upsert3\"\n    });\n\n    var result4 = collection.upsert({\n      \"subdocument.a\": 4\n    }, {\n      $set: {\"subdocument.a\": \"upsert 4\"}\n    });\n\n    test.equal(collection.findOne(result4.insertedId), {\n      _id: result4.insertedId,\n      subdocument: {a: \"upsert 4\"}\n    });\n\n    var result5 = collection.upsert({\n      \"subdocument.a\": \"upsert 4\"\n    }, {\n      $set: {\"subdocument.a\": \"upsert 5\"}\n    });\n\n    test.equal(result5, {numberAffected: 1});\n\n    test.equal(collection.findOne(result4.insertedId), {\n      _id: result4.insertedId,\n      subdocument: {a: \"upsert 5\"}\n    });\n\n    var result6 = collection.upsert({\n      \"subdocument.a\": \"upsert 5\"\n    }, {\n      $set: {\"subdocument\": \"upsert 6\"}\n    });\n\n    test.equal(result6, {numberAffected: 1});\n\n    test.equal(collection.findOne(result4.insertedId), {\n      _id: result4.insertedId,\n      subdocument: \"upsert 6\"\n    });\n\n    var result7 = collection.upsert({\n      \"subdocument.a.b\": 7\n    }, {\n      $set: {\n        \"subdocument.a.c\": \"upsert7\"\n      }\n    });\n\n    test.equal(collection.findOne(result7.insertedId), {\n      _id: result7.insertedId,\n      subdocument: {\n        a: {b: 7, c: \"upsert7\"}\n      }\n    });\n\n    var result8 = collection.upsert({\n      \"subdocument.a.b\": 7\n    }, {\n      $set: {\n        \"subdocument.a.c\": \"upsert8\"\n      }\n    });\n\n    test.equal(result8, {numberAffected: 1});\n\n    test.equal(collection.findOne(result7.insertedId), {\n      _id: result7.insertedId,\n      subdocument: {\n        a: {b: 7, c: \"upsert8\"}\n      }\n    });\n\n    var result9 = collection.upsert({\n      \"subdocument.a.b\": 7\n    }, {\n      $set: {\n        \"subdocument.a.b\": \"upsert9\"\n      }\n    });\n\n    test.equal(result9, {numberAffected: 1});\n\n    test.equal(collection.findOne(result7.insertedId), {\n      _id: result7.insertedId,\n      subdocument: {\n        a: {b: \"upsert9\", c: \"upsert8\"}\n      }\n    });\n\n  });\n}\n\n// This is a VERY white-box test.\nMeteor.isServer && Tinytest.add(\"mongo-livedata - oplog - _disableOplog\", function (test) {\n  var collName = Random.id();\n  var coll = new Mongo.Collection(collName);\n  if (MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle) {\n    var observeWithOplog = coll.find({x: 5})\n          .observeChanges({added: function () {}});\n    test.isTrue(observeWithOplog._multiplexer._observeDriver._usesOplog);\n    observeWithOplog.stop();\n  }\n  var observeWithoutOplog = coll.find({x: 6}, {_disableOplog: true})\n        .observeChanges({added: function () {}});\n  test.isFalse(observeWithoutOplog._multiplexer._observeDriver._usesOplog);\n  observeWithoutOplog.stop();\n});\n\nMeteor.isServer && Tinytest.add(\"mongo-livedata - oplog - include selector fields\", function (test) {\n  var collName = \"includeSelector\" + Random.id();\n  var coll = new Mongo.Collection(collName);\n\n  var docId = coll.insert({a: 1, b: [3, 2], c: 'foo'});\n  test.isTrue(docId);\n\n  // Wait until we've processed the insert oplog entry. (If the insert shows up\n  // during the observeChanges, the bug in question is not consistently\n  // reproduced.) We don't have to do this for polling observe (eg\n  // --disable-oplog).\n  waitUntilOplogCaughtUp();\n\n  var output = [];\n  var handle = coll.find({a: 1, b: 2}, {fields: {c: 1}}).observeChanges({\n    added: function (id, fields) {\n      output.push(['added', id, fields]);\n    },\n    changed: function (id, fields) {\n      output.push(['changed', id, fields]);\n    },\n    removed: function (id) {\n      output.push(['removed', id]);\n    }\n  });\n  // Initially should match the document.\n  test.length(output, 1);\n  test.equal(output.shift(), ['added', docId, {c: 'foo'}]);\n\n  // Update in such a way that, if we only knew about the published field 'c'\n  // and the changed field 'b' (but not the field 'a'), we would think it didn't\n  // match any more.  (This is a regression test for a bug that existed because\n  // we used to not use the shared projection in the initial query.)\n  runInFence(function () {\n    coll.update(docId, {$set: {'b.0': 2, c: 'bar'}});\n  });\n  test.length(output, 1);\n  test.equal(output.shift(), ['changed', docId, {c: 'bar'}]);\n\n  handle.stop();\n});\n\nMeteor.isServer && Tinytest.add(\"mongo-livedata - oplog - transform\", function (test) {\n  var collName = \"oplogTransform\" + Random.id();\n  var coll = new Mongo.Collection(collName);\n\n  var docId = coll.insert({a: 25, x: {x: 5, y: 9}});\n  test.isTrue(docId);\n\n  // Wait until we've processed the insert oplog entry. (If the insert shows up\n  // during the observeChanges, the bug in question is not consistently\n  // reproduced.) We don't have to do this for polling observe (eg\n  // --disable-oplog).\n  waitUntilOplogCaughtUp();\n\n  var cursor = coll.find({}, {transform: function (doc) {\n    return doc.x;\n  }});\n\n  var changesOutput = [];\n  var changesHandle = cursor.observeChanges({\n    added: function (id, fields) {\n      changesOutput.push(['added', fields]);\n    }\n  });\n  // We should get untransformed fields via observeChanges.\n  test.length(changesOutput, 1);\n  test.equal(changesOutput.shift(), ['added', {a: 25, x: {x: 5, y: 9}}]);\n  changesHandle.stop();\n\n  var transformedOutput = [];\n  var transformedHandle = cursor.observe({\n    added: function (doc) {\n      transformedOutput.push(['added', doc]);\n    }\n  });\n  test.length(transformedOutput, 1);\n  test.equal(transformedOutput.shift(), ['added', {x: 5, y: 9}]);\n  transformedHandle.stop();\n});\n\n\nMeteor.isServer && Tinytest.add(\"mongo-livedata - oplog - drop collection/db\", function (test) {\n  // This test uses a random database, so it can be dropped without affecting\n  // anything else.\n  var mongodbUri = Npm.require('mongodb-uri');\n  var parsedUri = mongodbUri.parse(process.env.MONGO_URL);\n  parsedUri.database = 'dropDB' + Random.id();\n  var driver = new MongoInternals.RemoteCollectionDriver(\n    mongodbUri.format(parsedUri), {\n      oplogUrl: process.env.MONGO_OPLOG_URL\n    }\n  );\n\n  var collName = \"dropCollection\" + Random.id();\n  var coll = new Mongo.Collection(collName, { _driver: driver });\n\n  var doc1Id = coll.insert({a: 'foo', c: 1});\n  var doc2Id = coll.insert({b: 'bar'});\n  var doc3Id = coll.insert({a: 'foo', c: 2});\n  var tmp;\n\n  var output = [];\n  var handle = coll.find({a: 'foo'}).observeChanges({\n    added: function (id, fields) {\n      output.push(['added', id, fields]);\n    },\n    changed: function (id) {\n      output.push(['changed']);\n    },\n    removed: function (id) {\n      output.push(['removed', id]);\n    }\n  });\n  test.length(output, 2);\n  // make order consistent\n  if (output.length === 2 && output[0][1] === doc3Id) {\n    tmp = output[0];\n    output[0] = output[1];\n    output[1] = tmp;\n  }\n  test.equal(output.shift(), ['added', doc1Id, {a: 'foo', c: 1}]);\n  test.equal(output.shift(), ['added', doc3Id, {a: 'foo', c: 2}]);\n\n  // Wait until we've processed the insert oplog entry, so that we are in a\n  // steady state (and we don't see the dropped docs because we are FETCHING).\n  waitUntilOplogCaughtUp();\n\n  // Drop the collection. Should remove all docs.\n  runInFence(function () {\n    coll._dropCollection();\n  });\n\n  test.length(output, 2);\n  // make order consistent\n  if (output.length === 2 && output[0][1] === doc3Id) {\n    tmp = output[0];\n    output[0] = output[1];\n    output[1] = tmp;\n  }\n  test.equal(output.shift(), ['removed', doc1Id]);\n  test.equal(output.shift(), ['removed', doc3Id]);\n\n  // Put something back in.\n  var doc4Id;\n  runInFence(function () {\n    doc4Id = coll.insert({a: 'foo', c: 3});\n  });\n\n  test.length(output, 1);\n  test.equal(output.shift(), ['added', doc4Id, {a: 'foo', c: 3}]);\n\n  // Now drop the database. Should remove all docs again.\n  runInFence(function () {\n    driver.mongo.dropDatabase();\n  });\n\n  test.length(output, 1);\n  test.equal(output.shift(), ['removed', doc4Id]);\n\n  handle.stop();\n  driver.mongo.close();\n});\n\nvar TestCustomType = function (head, tail) {\n  // use different field names on the object than in JSON, to ensure we are\n  // actually treating this as an opaque object.\n  this.myHead = head;\n  this.myTail = tail;\n};\n_.extend(TestCustomType.prototype, {\n  clone: function () {\n    return new TestCustomType(this.myHead, this.myTail);\n  },\n  equals: function (other) {\n    return other instanceof TestCustomType\n      && EJSON.equals(this.myHead, other.myHead)\n      && EJSON.equals(this.myTail, other.myTail);\n  },\n  typeName: function () {\n    return 'someCustomType';\n  },\n  toJSONValue: function () {\n    return {head: this.myHead, tail: this.myTail};\n  }\n});\n\nEJSON.addType('someCustomType', function (json) {\n  return new TestCustomType(json.head, json.tail);\n});\n\ntestAsyncMulti(\"mongo-livedata - oplog - update EJSON\", [\n  function (test, expect) {\n    var self = this;\n    var collectionName = \"ejson\" + Random.id();\n    if (Meteor.isClient) {\n      Meteor.call('createInsecureCollection', collectionName);\n      Meteor.subscribe('c-' + collectionName, expect());\n    }\n\n    self.collection = new Mongo.Collection(collectionName);\n    self.date = new Date;\n    self.objId = new Mongo.ObjectID;\n\n    self.id = self.collection.insert(\n      {d: self.date, oi: self.objId,\n       custom: new TestCustomType('a', 'b')},\n      expect(function (err, res) {\n        test.isFalse(err);\n        test.equal(self.id, res);\n      }));\n  },\n  function (test, expect) {\n    var self = this;\n    self.changes = [];\n    self.handle = self.collection.find({}).observeChanges({\n      added: function (id, fields) {\n        self.changes.push(['a', id, fields]);\n      },\n      changed: function (id, fields) {\n        self.changes.push(['c', id, fields]);\n      },\n      removed: function (id) {\n        self.changes.push(['r', id]);\n      }\n    });\n    test.length(self.changes, 1);\n    test.equal(self.changes.shift(),\n               ['a', self.id,\n                {d: self.date, oi: self.objId,\n                 custom: new TestCustomType('a', 'b')}]);\n\n    // First, replace the entire custom object.\n    // (runInFence is useful for the server, using expect() is useful for the\n    // client)\n    runInFence(function () {\n      self.collection.update(\n        self.id, {$set: {custom: new TestCustomType('a', 'c')}},\n        expect(function (err) {\n          test.isFalse(err);\n        }));\n    });\n  },\n  function (test, expect) {\n    var self = this;\n    test.length(self.changes, 1);\n    test.equal(self.changes.shift(),\n               ['c', self.id, {custom: new TestCustomType('a', 'c')}]);\n\n    // Now, sneakily replace just a piece of it. Meteor won't do this, but\n    // perhaps you are accessing Mongo directly.\n    runInFence(function () {\n      self.collection.update(\n        self.id, {$set: {'custom.EJSON$value.EJSONtail': 'd'}},\n      expect(function (err) {\n        test.isFalse(err);\n      }));\n    });\n  },\n  function (test, expect) {\n    var self = this;\n    test.length(self.changes, 1);\n    test.equal(self.changes.shift(),\n               ['c', self.id, {custom: new TestCustomType('a', 'd')}]);\n\n    // Update a date and an ObjectID too.\n    self.date2 = new Date(self.date.valueOf() + 1000);\n    self.objId2 = new Mongo.ObjectID;\n    runInFence(function () {\n      self.collection.update(\n        self.id, {$set: {d: self.date2, oi: self.objId2}},\n      expect(function (err) {\n        test.isFalse(err);\n      }));\n    });\n  },\n  function (test, expect) {\n    var self = this;\n    test.length(self.changes, 1);\n    test.equal(self.changes.shift(),\n               ['c', self.id, {d: self.date2, oi: self.objId2}]);\n\n    self.handle.stop();\n  }\n]);\n\n\nvar waitUntilOplogCaughtUp = function () {\n  var oplogHandle =\n        MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle;\n  if (oplogHandle)\n    oplogHandle.waitUntilCaughtUp();\n};\n\n\nMeteor.isServer && Tinytest.add(\"mongo-livedata - cursor dedup stop\", function (test) {\n  var coll = new Mongo.Collection(Random.id());\n  _.times(100, function () {\n    coll.insert({foo: 'baz'});\n  });\n  var handler = coll.find({}).observeChanges({\n    added: function (id) {\n      coll.update(id, {$set: {foo: 'bar'}});\n    }\n  });\n  handler.stop();\n  // Previously, this would print\n  //    Exception in queued task: TypeError: Object.keys called on non-object\n  // Unfortunately, this test didn't fail before the bugfix, but it at least\n  // would print the error and no longer does.\n  // See https://github.com/meteor/meteor/issues/2070\n});\n\ntestAsyncMulti(\"mongo-livedata - undefined find options\", [\n  function (test, expect) {\n    var self = this;\n    self.collName = Random.id();\n    if (Meteor.isClient) {\n      Meteor.call(\"createInsecureCollection\", self.collName);\n      Meteor.subscribe(\"c-\" + self.collName, expect());\n    }\n  },\n  function (test, expect) {\n    var self = this;\n    self.coll = new Mongo.Collection(self.collName);\n    self.doc = { foo: 1, bar: 2, _id: \"foobar\" };\n    self.coll.insert(self.doc, expect(function (err, id) {\n      test.isFalse(err);\n    }));\n  },\n  function (test, expect) {\n    var self = this;\n    var result = self.coll.findOne({ foo: 1 }, {\n      fields: undefined,\n      sort: undefined,\n      limit: undefined,\n      skip: undefined\n    });\n    test.equal(result, self.doc);\n  }\n]);\n\n// Regression test for #2274.\nMeteor.isServer && testAsyncMulti(\"mongo-livedata - observe limit bug\", [\n  function (test, expect) {\n    var self = this;\n    self.coll = new Mongo.Collection(Random.id());\n    var state = {};\n    var callbacks = {\n      changed: function (newDoc) {\n        state[newDoc._id] = newDoc;\n      },\n      added: function (newDoc) {\n        state[newDoc._id] = newDoc;\n      },\n      removed: function (oldDoc) {\n        delete state[oldDoc._id];\n      }\n    };\n    self.observe = self.coll.find(\n      {}, {limit: 1, sort: {sortField: -1}}).observe(callbacks);\n\n    // Insert some documents.\n    runInFence(function () {\n      self.id0 = self.coll.insert({sortField: 0, toDelete: true});\n      self.id1 = self.coll.insert({sortField: 1, toDelete: true});\n      self.id2 = self.coll.insert({sortField: 2, toDelete: true});\n    });\n    test.equal(_.keys(state), [self.id2]);\n\n    // Mutate the one in the unpublished buffer and the one below the\n    // buffer. Before the fix for #2274, this left the observe state machine in\n    // a broken state where the buffer was empty but it wasn't try to re-fill\n    // it.\n    runInFence(function () {\n      self.coll.update({_id: {$ne: self.id2}},\n                       {$set: {toDelete: false}},\n                       {multi: 1});\n    });\n    test.equal(_.keys(state), [self.id2]);\n\n    // Now remove the one published document. This should slide up id1 from the\n    // buffer, but this didn't work before the #2274 fix.\n    runInFence(function () {\n      self.coll.remove({toDelete: true});\n    });\n    test.equal(_.keys(state), [self.id1]);\n  }\n]);\n\nMeteor.isServer && testAsyncMulti(\"mongo-livedata - update with replace forbidden\", [\n  function (test, expect) {\n    var c = new Mongo.Collection(Random.id());\n\n    var id = c.insert({ foo: \"bar\" });\n\n    c.update(id, { foo2: \"bar2\" });\n    test.equal(c.findOne(id), { _id: id, foo2: \"bar2\" });\n\n    test.throws(function () {\n      c.update(id, { foo3: \"bar3\" }, { _forbidReplace: true });\n    }, \"Replacements are forbidden\");\n    test.equal(c.findOne(id), { _id: id, foo2: \"bar2\" });\n\n    test.throws(function () {\n      c.update(id, { foo3: \"bar3\", $set: { blah: 1 } });\n    }, \"cannot have both modifier and non-modifier fields\");\n    test.equal(c.findOne(id), { _id: id, foo2: \"bar2\" });\n  }\n]);\n\nMeteor.isServer && Tinytest.add(\n  \"mongo-livedata - connection failure throws\",\n  function (test) {\n    test.throws(function () {\n      new MongoInternals.Connection('mongodb://this-does-not-exist.test/asdf');\n    });\n  }\n);\n\nMeteor.isServer && Tinytest.add(\"mongo-livedata - npm modules\", function (test) {\n  // Make sure the version number looks like a version number.\n  test.matches(MongoInternals.NpmModules.mongodb.version, /^1\\.(\\d+)\\.(\\d+)/);\n  test.equal(typeof(MongoInternals.NpmModules.mongodb.module), 'function');\n  test.equal(typeof(MongoInternals.NpmModules.mongodb.module.connect),\n             'function');\n  test.equal(typeof(MongoInternals.NpmModules.mongodb.module.ObjectID),\n             'function');\n\n  var c = new Mongo.Collection(Random.id());\n  var rawCollection = c.rawCollection();\n  test.isTrue(rawCollection);\n  test.isTrue(rawCollection.findAndModify);\n  var rawDb = c.rawDatabase();\n  test.isTrue(rawDb);\n  test.isTrue(rawDb.admin);\n});\n\nif (Meteor.isServer) {\n  Tinytest.add(\"mongo-livedata - update/remove don't accept an array as a selector #4804\", function (test) {\n    var collection = new Mongo.Collection(Random.id());\n\n    _.times(10, function () {\n      collection.insert({ data: \"Hello\" });\n    });\n\n    test.equal(collection.find().count(), 10);\n\n    // Test several array-related selectors\n    _.each([[], [1, 2, 3], [{}]], function (selector) {\n      test.throws(function () {\n        collection.remove(selector);\n      });\n\n      test.throws(function () {\n        collection.update(selector, {$set: 5});\n      });\n    });\n\n    test.equal(collection.find().count(), 10);\n  });\n}\n\n// This is a regression test for https://github.com/meteor/meteor/issues/4839.\n// Prior to fixing the issue (but after applying\n// https://github.com/meteor/meteor/pull/4694), doing a Mongo write from a\n// timeout that ran after a method body (invoked via the client) would throw an\n// error \"fence has already activated -- too late to add a callback\" and not\n// properly call the Mongo write's callback.  In this test:\n//  - The client invokes a method (fenceOnBeforeFireError1) which\n//    - Starts an observe on a query\n//    - Creates a timeout (which shares a write fence with the method)\n//    - Lets the method return (firing the write fence)\n//  - The timeout runs and does a Mongo write. This write is inside a write\n//    fence (because timeouts preserve the fence, see dcd26415) but the write\n//    fence already fired.\n//  - The Mongo write's callback confirms that there is no error. This was\n//    not the case before fixing the bug!  (Note that the observe was necessary\n//    for the error to occur, because the error was thrown from the observe's\n//    crossbar listener callback).  It puts the confirmation into a Future.\n//  - The client invokes another method which reads the confirmation from\n//    the future. (Well, the invocation happened earlier but the use of the\n//    Future sequences it so that the confirmation only gets read at this point.)\nif (Meteor.isClient) {\n  testAsyncMulti(\"mongo-livedata - fence onBeforeFire error\", [\n    function (test, expect) {\n      var self = this;\n      self.nonce = Random.id();\n      Meteor.call('fenceOnBeforeFireError1', self.nonce, expect(function (err) {\n        test.isFalse(err);\n      }));\n    },\n    function (test, expect) {\n      var self = this;\n      Meteor.call('fenceOnBeforeFireError2', self.nonce, expect(\n        function (err, success) {\n          test.isFalse(err);\n          test.isTrue(success);\n        }\n      ));\n    }\n  ]);\n} else {\n  var fenceOnBeforeFireErrorCollection = new Mongo.Collection(\"FOBFE\");\n  var Future = Npm.require('fibers/future');\n  var futuresByNonce = {};\n  Meteor.methods({\n    fenceOnBeforeFireError1: function (nonce) {\n      futuresByNonce[nonce] = new Future;\n      var observe = fenceOnBeforeFireErrorCollection.find({nonce: nonce})\n            .observeChanges({added: function (){}});\n      Meteor.setTimeout(function () {\n        fenceOnBeforeFireErrorCollection.insert(\n          {nonce: nonce},\n          function (err, result) {\n            var success = !err && result;\n            futuresByNonce[nonce].return(success);\n            observe.stop();\n          }\n        );\n      }, 10);\n    },\n    fenceOnBeforeFireError2: function (nonce) {\n      try {\n        return futuresByNonce[nonce].wait();\n      } finally {\n        delete futuresByNonce[nonce];\n      }\n    }\n  });\n}\n"]},"hash":"c91f2980520f23454481f854f35e60580cb3e42f"}
