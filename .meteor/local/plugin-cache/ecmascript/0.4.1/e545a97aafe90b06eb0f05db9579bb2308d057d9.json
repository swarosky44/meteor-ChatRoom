{"metadata":{"usedHelpers":[],"marked":[],"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"/packages/accounts-base/accounts_reconnect_tests.js","filenameRelative":"/packages/accounts-base/accounts_reconnect_tests.js","env":{},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":false,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"/packages/accounts-base/accounts_reconnect_tests.js.map","sourceFileName":"/packages/accounts-base/accounts_reconnect_tests.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"basename":"accounts_reconnect_tests"},"ignored":false,"code":"if (Meteor.isServer) {\n  Meteor.methods({\n    getConnectionUserId: function () {\n      function getConnectionUserId() {\n        return this.userId;\n      }\n\n      return getConnectionUserId;\n    }()\n  });\n}\n\nif (Meteor.isClient) {\n  Tinytest.addAsync('accounts - reconnect auto-login', function (test, done) {\n    var username1 = 'testuser1-' + Random.id();\n    var username2 = 'testuser2-' + Random.id();\n    var password1 = 'password1-' + Random.id();\n    var password2 = 'password2-' + Random.id();\n    var timeoutHandle;\n    var onLoginStopper;\n\n    loginAsUser1();\n\n    function loginAsUser1() {\n      Accounts.createUser({\n        username: username1,\n        password: password1\n      }, onUser1LoggedIn);\n    }\n\n    function onUser1LoggedIn(err) {\n      test.isUndefined(err, 'Unexpected error logging in as user1');\n      Accounts.createUser({\n        username: username2,\n        password: password2\n      }, onUser2LoggedIn);\n    }\n\n    function onUser2LoggedIn(err) {\n      test.isUndefined(err, 'Unexpected error logging in as user2');\n      onLoginStopper = Accounts.onLogin(onUser2LoggedInAfterReconnect);\n      Meteor.disconnect();\n      Meteor.reconnect();\n    }\n\n    function onUser2LoggedInAfterReconnect() {\n      onLoginStopper.stop();\n      Meteor.loginWithPassword('non-existent-user', 'or-wrong-password', onFailedLogin);\n    }\n\n    function onFailedLogin(err) {\n      test.instanceOf(err, Meteor.Error, 'No Meteor.Error on login failure');\n      onLoginStopper = Accounts.onLogin(onUser2LoggedInAfterReconnectAfterFailedLogin);\n      Meteor.disconnect();\n      Meteor.reconnect();\n      timeoutHandle = Meteor.setTimeout(failTest, 1000);\n    }\n\n    function failTest() {\n      onLoginStopper.stop();\n      test.fail('Issue #4970 has occured.');\n      Meteor.call('getConnectionUserId', checkFinalState);\n    }\n\n    function onUser2LoggedInAfterReconnectAfterFailedLogin() {\n      onLoginStopper.stop();\n      Meteor.clearTimeout(timeoutHandle);\n      Meteor.call('getConnectionUserId', checkFinalState);\n    }\n\n    function checkFinalState(err, connectionUserId) {\n      test.isUndefined(err, 'Unexpected error calling getConnectionUserId');\n      test.equal(connectionUserId, Meteor.userId(), 'userId is different on client and server');\n      done();\n    }\n  });\n}","ast":null,"map":{"version":3,"sources":["/packages/accounts-base/accounts_reconnect_tests.js"],"names":[],"mappings":"AAAA,IAAI,OAAO,QAAP,EAAiB;AACnB,SAAO,OAAP,CAAe;AACb;AAAqB,qCAAW;AAC9B,eAAO,KAAK,MAAL,CADuB;OAAX;;;OAArB;GADF,EADmB;CAArB;;AAQA,IAAI,OAAO,QAAP,EAAiB;AACnB,WAAS,QAAT,CAAkB,iCAAlB,EAAqD,UAAS,IAAT,EAAe,IAAf,EAAqB;AACxE,QAAI,YAAY,eAAe,OAAO,EAAP,EAAf,CADwD;AAExE,QAAI,YAAY,eAAe,OAAO,EAAP,EAAf,CAFwD;AAGxE,QAAI,YAAY,eAAe,OAAO,EAAP,EAAf,CAHwD;AAIxE,QAAI,YAAY,eAAe,OAAO,EAAP,EAAf,CAJwD;AAKxE,QAAI,aAAJ,CALwE;AAMxE,QAAI,cAAJ,CANwE;;AAQxE,mBARwE;;AAUxE,aAAS,YAAT,GAAwB;AACtB,eAAS,UAAT,CAAoB;AAClB,kBAAU,SAAV;AACA,kBAAU,SAAV;OAFF,EAGG,eAHH,EADsB;KAAxB;;AAOA,aAAS,eAAT,CAAyB,GAAzB,EAA8B;AAC5B,WAAK,WAAL,CAAiB,GAAjB,EAAsB,sCAAtB,EAD4B;AAE5B,eAAS,UAAT,CAAoB;AAClB,kBAAU,SAAV;AACA,kBAAU,SAAV;OAFF,EAGG,eAHH,EAF4B;KAA9B;;AAQA,aAAS,eAAT,CAAyB,GAAzB,EAA8B;AAC5B,WAAK,WAAL,CAAiB,GAAjB,EAAsB,sCAAtB,EAD4B;AAE5B,uBAAiB,SAAS,OAAT,CAAiB,6BAAjB,CAAjB,CAF4B;AAG5B,aAAO,UAAP,GAH4B;AAI5B,aAAO,SAAP,GAJ4B;KAA9B;;AAOA,aAAS,6BAAT,GAAyC;AACvC,qBAAe,IAAf,GADuC;AAEvC,aAAO,iBAAP,CAAyB,mBAAzB,EAA8C,mBAA9C,EACE,aADF,EAFuC;KAAzC;;AAMA,aAAS,aAAT,CAAuB,GAAvB,EAA4B;AAC1B,WAAK,UAAL,CAAgB,GAAhB,EAAqB,OAAO,KAAP,EAAc,kCAAnC,EAD0B;AAE1B,uBAAiB,SAAS,OAAT,CAAiB,6CAAjB,CAAjB,CAF0B;AAG1B,aAAO,UAAP,GAH0B;AAI1B,aAAO,SAAP,GAJ0B;AAK1B,sBAAgB,OAAO,UAAP,CAAkB,QAAlB,EAA4B,IAA5B,CAAhB,CAL0B;KAA5B;;AAQA,aAAS,QAAT,GAAoB;AAClB,qBAAe,IAAf,GADkB;AAElB,WAAK,IAAL,CAAU,0BAAV,EAFkB;AAGlB,aAAO,IAAP,CAAY,qBAAZ,EAAmC,eAAnC,EAHkB;KAApB;;AAMA,aAAS,6CAAT,GAAyD;AACvD,qBAAe,IAAf,GADuD;AAEvD,aAAO,YAAP,CAAoB,aAApB,EAFuD;AAGvD,aAAO,IAAP,CAAY,qBAAZ,EAAmC,eAAnC,EAHuD;KAAzD;;AAMA,aAAS,eAAT,CAAyB,GAAzB,EAA8B,gBAA9B,EAAgD;AAC9C,WAAK,WAAL,CAAiB,GAAjB,EAAsB,8CAAtB,EAD8C;AAE9C,WAAK,KAAL,CAAW,gBAAX,EAA6B,OAAO,MAAP,EAA7B,EACE,0CADF,EAF8C;AAI9C,aAJ8C;KAAhD;GA1DmD,CAArD,CADmB;CAArB","file":"/packages/accounts-base/accounts_reconnect_tests.js.map","sourcesContent":["if (Meteor.isServer) {\n  Meteor.methods({\n    getConnectionUserId: function() {\n      return this.userId;\n    }\n  });\n}\n\nif (Meteor.isClient) {\n  Tinytest.addAsync('accounts - reconnect auto-login', function(test, done) {\n    var username1 = 'testuser1-' + Random.id();\n    var username2 = 'testuser2-' + Random.id();\n    var password1 = 'password1-' + Random.id();\n    var password2 = 'password2-' + Random.id();\n    var timeoutHandle;\n    var onLoginStopper;\n\n    loginAsUser1();\n\n    function loginAsUser1() {\n      Accounts.createUser({\n        username: username1,\n        password: password1\n      }, onUser1LoggedIn);\n    }\n\n    function onUser1LoggedIn(err) {\n      test.isUndefined(err, 'Unexpected error logging in as user1');\n      Accounts.createUser({\n        username: username2,\n        password: password2\n      }, onUser2LoggedIn);\n    }\n\n    function onUser2LoggedIn(err) {\n      test.isUndefined(err, 'Unexpected error logging in as user2');\n      onLoginStopper = Accounts.onLogin(onUser2LoggedInAfterReconnect);\n      Meteor.disconnect();\n      Meteor.reconnect();\n    }\n\n    function onUser2LoggedInAfterReconnect() {\n      onLoginStopper.stop();\n      Meteor.loginWithPassword('non-existent-user', 'or-wrong-password',\n        onFailedLogin);\n    }\n\n    function onFailedLogin(err) {\n      test.instanceOf(err, Meteor.Error, 'No Meteor.Error on login failure');\n      onLoginStopper = Accounts.onLogin(onUser2LoggedInAfterReconnectAfterFailedLogin);\n      Meteor.disconnect();\n      Meteor.reconnect();\n      timeoutHandle = Meteor.setTimeout(failTest, 1000);\n    }\n\n    function failTest() {\n      onLoginStopper.stop();\n      test.fail('Issue #4970 has occured.');\n      Meteor.call('getConnectionUserId', checkFinalState);\n    }\n\n    function onUser2LoggedInAfterReconnectAfterFailedLogin() {\n      onLoginStopper.stop();\n      Meteor.clearTimeout(timeoutHandle);\n      Meteor.call('getConnectionUserId', checkFinalState);\n    }\n\n    function checkFinalState(err, connectionUserId) {\n      test.isUndefined(err, 'Unexpected error calling getConnectionUserId');\n      test.equal(connectionUserId, Meteor.userId(),\n        'userId is different on client and server');\n      done();\n    }\n  });\n}\n"]},"hash":"e545a97aafe90b06eb0f05db9579bb2308d057d9"}
